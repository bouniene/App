<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>étiquette</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bwip-js/3.0.4/bwip-js-min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <style>
    /* --- CSS Styles --- */
    .controls {
      position: fixed;
      left: 0;
      right: auto;
      top: 0;
      height: 100vh;
      width: 260px;
      background-color: #212529;
      padding: 20px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      z-index: 990;  
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .controls * { color: #adb5bd !important; }

    .sidebar {
      position: fixed;
      right: 0;
      left: auto;
      top: 0;
      height: 100vh;
      width: 160px;
      background: #f8f9fa;
      padding: 5px 5px;
      box-shadow: -2px 0 5px rgba(0,0,0,0.1);
      z-index: 1000;  
      overflow-y: auto;
    }

    .sidebar-button {
      display: block;
      width: 100%;
      padding: 1px;
      margin: 8px 0;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      color: white;
      text-align: center !important;
      transition: transform 0.2s, box-shadow 0.2s;
      font-size: 14px;
      position: relative;
    }

    .sidebar-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    }
    
    .edit-icon {
        position: absolute;
        left: 4px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 16px !important;
        color: rgba(255, 255, 255, 0.7) !important;
        cursor: pointer;
        transition: color 0.2s;
        display: none;
    }
    .sidebar-button:hover .edit-icon { display: block; color: rgba(255, 255, 255, 1) !important; }
    
    .sidebar-button.is-new::after {
        content: 'new';
        position: absolute;
        top: -6px;
        right: -6px;
        background-color: #ffc107;
        color: #000;
        font-size: 9px;
        font-weight: bold;
        padding: 1px 4px;
        border-radius: 4px;
        transform: rotate(15deg);
        box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    .CIMAISE { background: #d61e1e; }
    .PLINTHE { background: #525045; }
    .CADRE { background: #4dabf7; }
    .Wall-panel { background: #f783ac; }
    .CORNICHE { background: #ff922b; }
    .CORNIERE { background: #94d82d; }

    body {
      font-family: Arial, sans-serif;
      direction: rtl;
      margin: 0;
      padding: 20px 180px 20px 280px;  
      background: #f0f0f0;
      line-height: 1.6;
      transition: padding 0.3s ease-in-out;
    }
    
    .control-group { display: flex; flex-direction: column; gap: 6px; }
    .controls label { font-weight: bold; margin-bottom: 0; font-size: 0.9em; color: #adb5bd; }

    .controls input[type="text"], .controls input[list], .controls input[type="file"] {
      padding: 8px 6px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100%;  
      box-sizing: border-box;
      min-width: auto;
      direction: ltr;
    }
    .controls input[type="file"] { padding: 3px; background: #fff; }

    .controls button.print-btn, .controls button.action-btn {
      padding: 10px 20px;
      font-size: 14px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      transition: background-color 0.3s ease;
      margin-top: 5px;
      width: 100%;
    }
    .controls button.print-btn:hover { background-color: #0056b3; }
    .controls .add-model-btn { background-color: #198754; } 
    .controls .add-model-btn:hover { background-color: #157347; }
    .controls .export-btn { background-color: #6c757d; } 
    .controls .export-btn:hover { background-color: #5c636a; }
    .buttons-container { display: flex; gap: 10px; }
    
    .control-group #hide-container {
      display: grid !important;  
      grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));  
      gap: 8px !important;  
      padding-top: 5px;
    }
    #hide-container label {
      font-size: 0.9em;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 3px 5px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      background-color: #212529;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    #hide-container label:hover { background-color: #f0f0f0; }
    #hide-container input[type="checkbox"] { margin: 0; }
    
    .display-options {
        display: flex;
        flex-direction: column;
        gap: 8px;
        background-color: #2c3034;
        padding: 10px;
        border-radius: 4px;
    }
    .display-options label { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9em !important; }
    .display-options input[type="checkbox"] { width: 16px; height: 16px; }

    .a4-container {
      width: 210mm;
      min-height: 297mm;
      margin: 0 auto;  
      padding: 15mm 10mm 10mm 10mm;
      background: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      box-sizing: border-box;
      position: relative;
    }

    .page-header {
        position: absolute;
        top: 0.9mm;
        left: 10mm;
        right: 10mm;
        height: 12mm;
        box-sizing: border-box;
        overflow: hidden;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .header-text { text-align: center; font-size: 14px; font-weight: bold; color: #333; flex-grow: 1; }
    .header-logo { max-height: 10mm; max-width: 40mm; object-fit: contain; }

.labels-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr); /* عمودين */
      /* تقسيم الارتفاع على 4 صفوف بالضبط مع مراعاة الهوامش */
      grid-template-rows: repeat(4, calc((297mm - 20mm) / 4 - 3mm));
      gap: 6mm;
      width: 100%;
      height: calc(297mm - 20mm);
    }

    .label-box {
      position: relative;
      overflow: hidden;
      background: #fff;
      text-align: center;
      border: 1px dashed #eee;
    }
    
    .label-box.hide-qr .qr-code-container { visibility: hidden; }
    .label-box.hide-shapes .corner-shape, .label-box.hide-shapes .bubble-container { visibility: hidden; }

    /* --- تعديل مكان Data Matrix ليكون في الأسفل على اليمين --- */
    .qr-code-container {
        position: absolute;
        top: auto;        
        bottom: 5px;      /* أسفل */
        right: 5px;       /* يمين */
        left: auto;      
        width: 48px;      /* تصغير عرض الحاوية قليلاً */
        z-index: 15;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    /* تنسيق عنصر الكانفس (Data Matrix) - شفاف وبدون حدود */
    .qr-code-container canvas {
        width: 44px !important; /* تصغير الحجم قليلاً */
        height: 44px !important;
        padding: 0;
        background: transparent; /* خلفية شفافة */
        border: none; /* بدون إطار */
        box-sizing: border-box;
    }
    
    .qr-unique-id {
        width: 44px; /* مطابقة لعرض الرمز الجديد */
        font-size: 9px; /* تصغير الخط قليلاً */
        font-weight: bold;
        color: #333;
        margin-top: 1px;
        font-family: 'Courier New', Courier, monospace;
        letter-spacing: 1px;
        text-align: center;
        box-sizing: border-box;
        overflow: hidden;
    }

    .corner-shape {
      position: absolute;
      top: 15px;
      left: 0;
      width: 40px;
      height: 40px;
      z-index: 10;
      transform-origin: top left;
      transition: all 0.3s ease;
    }

    .bubble-container {
        position: absolute;
        top: 15px;
        right: 70px;
        display: flex;
        flex-wrap: wrap;
        gap: 2px;
        align-items: center;
        justify-content: flex-end;
        z-index: 10;
        pointer-events: none;
        max-width: 50%;
        max-height: 40px;
        overflow: hidden;
        padding: 1px;
    }

    .bubble {
      display: block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: #ccc;
      box-shadow: inset 0 0 1px rgba(255, 255, 255, 0.5), 0 1px 1px rgba(0,0,0,0.1);
      flex-shrink: 0;
      transition: background-color 0.3s ease;
    }

    .label-box .bg-shape {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: 1;
    }

    .label-box .logo {
      position: absolute;
      top: 10mm;
      left: 50%;
      transform: translateX(-50%);
      width: 43mm;
      height: auto;
      z-index: 2;
    }

    .label-box .text-area {
      position: absolute;
      top: calc(8mm + 15mm + 5mm);
      left: 5%;
      width: 90%;
      z-index: 3;
      font-size: 16px;
      color: #000;
      text-align: center;
      line-height: 1.3;
    }

    .label-box .text-area .ref {
        font-weight: bold;
        font-size: 1.1em;
        margin-bottom: 4px;
        word-wrap: break-word;
        text-align: left;
        padding-left: 55px;
        direction: ltr;
    }
    
    html, body, p, span, div, h1, h2, h3, h4, h5, h6, input, textarea, button { direction: ltr !important; }

    .label-box .text-area .pcs { margin-bottom: 4px;  text-align: left; padding-left: 55px; }
    .label-box .text-area .dim { margin-bottom: 4px;    text-align: left; padding-left: 55px; }
    .label-box.hidden { visibility: hidden; }
    
    /* Modals */
    .modal-overlay, .print-modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.6); z-index: 1050;
        display: flex; align-items: center; justify-content: center;
        visibility: hidden; opacity: 0; transition: opacity 0.3s, visibility 0.3s;
    }
    .modal-overlay.visible, .print-modal-overlay.visible { visibility: visible; opacity: 1; }
    .modal-content, .print-modal {
        background: #fff; padding: 25px; border-radius: 8px; width: 350px;
        text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .modal-content h3, .print-modal h3 { margin-top: 0; margin-bottom: 20px; color: #333; }
    .modal-content .form-group { margin-bottom: 15px; text-align: left; }
    .modal-content .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 0.9rem; }
    .modal-content .form-group.inline { display: flex; gap: 10px; }
    .modal-content .form-group.inline > div { flex: 1; }
    .modal-content input, .modal-content select, .print-modal input {
        width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; box-sizing: border-box;
    }
    .modal-content .checkbox-group { display: flex; align-items: center; justify-content: flex-start; gap: 8px; }
    .modal-content .checkbox-group input { width: auto; margin-bottom: 0; }
    .modal-content .modal-actions, .print-modal .modal-actions { margin-top: 20px; }
    .modal-content button, .print-modal button {
        padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; margin: 0 5px;
    }
    .btn-confirm { background-color: #007bff; color: white; }
    .btn-cancel { background-color: #6c757d; color: white; }

    /* Batch Modal */
    .batch-modal-content {
      background: #fff; border-radius: 12px; width: 950px; max-width: 95vw;
      box-shadow: 0 5px 20px rgba(0,0,0,0.25); display: flex; flex-direction: column; max-height: 90vh;
    }
    .batch-modal-content .modal-header {
      padding: 15px 25px; border-bottom: 1px solid #e9ecef; display: flex; align-items: center; gap: 10px; font-size: 1.25rem; font-weight: 500; color: #212529;
    }
    .batch-modal-content .modal-body { padding: 20px 25px; overflow-y: auto; flex-grow: 1; }
    .batch-modal-content .modal-footer {
      padding: 15px 25px; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center;
    }
    .batch-modal-content .table thead { position: sticky; top: -1px; background: #f8f9fa; z-index: 10; }
    .batch-modal-content .table th { font-weight: 600; }
    .batch-modal-content .table td { vertical-align: middle; }
    #batch-print-list .page-break-row td { background-color: #e9ecef; padding: 8px; text-align: center; }
    #batch-print-list .page-break-row input { border: 1px dashed #6c757d; background-color: #f8f9fa; text-align: center; }




/* --- تنسيق الجسم لضمان عدم تغطية المحتوى --- */
    body {
      /* padding-top: ارتفاع الشريط العلوي (50px) + مسافة جمالية (20px) = 70px
         الهوامش الجانبية تبقى كما هي في كودك الأصلي لضمان مكان القوائم 
      */
      padding: 70px 180px 20px 280px !important; 
      transition: padding 0.3s ease-in-out;
    }

    /* --- تنسيق الشريط العلوي (محصور في الوسط) --- */
    .top-navbar {
        position: fixed;
        top: 0;
        height: 50px;
        background-color: #212529; /* لون خلفية الشريط */
        
        /* هنا السحر: نحدد بدايته ونهايته بناءً على عرض القوائم الجانبية */
        left: 260px;  /* يبدأ بعد القائمة اليسرى تماماً */
        right: 160px; /* ينتهي قبل القائمة اليمنى تماماً */
        
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        z-index: 900; /* أقل من القوائم الجانبية حتى لا يغطي عليها عند الفتح في الموبايل */
    }

    /* باقي تنسيقات عناصر الشريط كما هي */
    .menu-trigger {
        color: #fff;
        cursor: pointer;
        display: flex;
        align-items: center;
        padding: 5px 10px;
        border-radius: 4px;
        transition: background 0.3s;
        font-size: 0.9em;
    }
    .menu-trigger:hover { background-color: rgba(255,255,255,0.1); }

    .nav-links { display: flex; gap: 5px; }

    .nav-sq {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 60px; /* تصغير العرض قليلاً ليتناسب مع المساحة */
        height: 30px;
        background-color: #495057;
        color: #fff;
        text-decoration: none;
        font-size: 12px;
        border-radius: 3px;
        font-weight: bold;
        transition: all 0.2s ease;
    }
    .nav-sq:hover { background-color: #0d6efd; color: white; }
    .nav-sq.active { background-color: #0d6efd; border: 1px solid #rgba(255,255,255,0.5); }

    /* --- تنسيق خاص للموبايل (هام جداً) --- */
    /* عندما تختفي القوائم الجانبية في الشاشات الصغيرة، يجب أن يمتد الشريط العلوي */
    @media (max-width: 1024px) {
        .top-navbar {
            left: 0 !important;
            right: 0 !important;
            width: 100%;
            z-index: 900;
        }
        
        body {
            /* تعديل الهوامش في الموبايل */
            padding: 60px 15px 20px 15px !important;
        }
        
        /* إنزال أزرار فتح القوائم في الموبايل لتكون تحت الشريط */
        .mobile-toggle-btn {
            top: 60px !important; 
        }
    }

    @media print {
        .top-navbar { display: none !important; }
        body { padding: 0 !important; }
    }
    
    /* تنسيق الجدول (نفس السابق) */
    .codes-table-container { max-height: 65vh; overflow-y: auto; }
    .codes-table th { position: sticky; top: 0; background: #0e67bf; z-index: 2; }
    .code-cell { font-family: 'Courier New', monospace; font-weight: bold; color: #d63384; direction: ltr; }
	
	
	
	
    /* عند الطباعة نخفي الشريط العلوي */
    @media print {
        .top-navbar { display: none !important; }
        body { padding-top: 0 !important; }
    }
    
    /* تعديل أزرار الموبايل لتنزل قليلاً */
    .mobile-toggle-btn { top: 60px !important; }



    @media print {
      body {
        padding: 0 !important;
        margin: 0 !important;
      }
      /* إخفاء كل شيء ما عدا حاوية الطباعة */
      body > *:not(#print-output) {
        display: none !important;
      }

      #print-output {
        display: block !important;
      }
      
      /* تطبيق الأنماط على كل صفحة A4 داخل حاوية الطباعة */
      #print-output .a4-container {
        display: block !important;
        width: 210mm;
        min-height: 217mm;
        height: 297mm;
        margin: 0;
        padding: 15mm 10mm 10mm 10mm; /* تم تعديل الهامش العلوي ليتناسب مع رأس الصفحة */
        box-shadow: none;
        box-sizing: border-box;
        page-break-after: always; /* الأهم للطباعة متعددة الصفحات */
      }
      
      #print-output .a4-container:last-child {
        page-break-after: auto;
      }

      #print-output .page-header {
      }
      
      #print-output .labels-grid {
          display: grid !important;
          grid-template-columns: repeat(2, 1fr);
          grid-template-rows: repeat(4, calc((297mm - 45mm) / 4 - 3mm));
          gap: 8mm;
          width: 100%;
          height: calc(297mm - 20mm);
      }
      
      #print-output .label-box {
          border: 0px dashed #eee; /* إبقاء الحدود المنقطة لرؤيتها إن أردت */
      }
      #print-output .label-box.hidden {
          visibility: hidden !important;
      }


      @page {
        size: A4;
        margin: 0; /* تم نقل الهوامش إلى حاوية a4-container */
      }
    }

    /* --- START: Mobile Responsive Styles --- */

    /* غطاء شفاف عند فتح القوائم الجانبية */
    #mobile-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 980; /* أقل من القوائم، أعلى من المحتوى */
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    #mobile-overlay.visible {
      display: block;
      opacity: 1;
    }

    /* أزرار التحكم في القوائم الجانبية على الجوال */
    .mobile-toggle-btn {
      display: none; /* مخفية افتراضيًا، تظهر في الميديا كويري */
      position: fixed;
      top: 15px;
      width: 50px;
      height: 50px;
      background-color: #0d6efd;
      color: white;
      border: none;
      border-radius: 50%;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1010;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }
    .mobile-toggle-btn.left {
      left: 15px;
    }
    .mobile-toggle-btn.right {
      right: 15px;
    }

    /* ميديا كويري للأجهزة اللوحية والجوال */
    @media (max-width: 1024px) {
      /* إظهار أزرار التحكم للجوال */
      .mobile-toggle-btn {
        display: flex;
      }

      /* تعديل هوامش الصفحة وإخفاء القوائم الجانبية افتراضيًا */
      body {
        padding: 80px 15px 20px 15px; /* هوامش جديدة للجوال */
      }

      /* --- انتقالات القوائم الجانبية --- */
      .controls, .sidebar {
        transition: transform 0.3s ease-in-out;
        z-index: 999;
      }

      /* القائمة اليسرى (الإعدادات) - الحالة الأولية */
      .controls {
        transform: translateX(-100%);
        width: 280px; /* عرض مناسب للجوال */
      }
      .controls.open {
        transform: translateX(0);
      }

      /* القائمة اليمنى (المنتجات) - الحالة الأولية */
      .sidebar {
        transform: translateX(100%);
        width: 200px;
      }
      .sidebar.open {
        transform: translateX(0);
      }

      /* --- تعديل حجم صفحة A4 --- */
      .a4-viewport {
        width: 100%;
        margin: 0 auto;
      }
      .a4-container {
        /* استخدام transform لتصغير الصفحة لتناسب الشاشة */
        transform-origin: top center; /* تغيير نقطة الأصل للتوسيط */
      }
      
      /* تعديل نافذة الطباعة لتكون في المنتصف على الجوال */
      .modal-content {
        width: 90%;
        max-width: 350px;
      }
    }

    /* تعديلات إضافية للشاشات الصغيرة جدًا */
    @media (max-width: 480px) {
      .labels-grid {
        /* عرض الملصقات في عمود واحد */
        grid-template-columns: 1fr;
        gap: 10px;
      }
      .label-box .text-area {
        font-size: 14px; /* تصغير الخط قليلاً */
      }
    }
    /* --- END: Mobile Responsive Styles --- */
  </style>
</head>
<body>
<div class="top-navbar">
    <div class="menu-trigger" onclick="openCodesModal()">
        <span class="material-icons">menu</span>
        <span style="margin-right: 8px; font-weight: bold;">قائمة الرموز</span>
    </div>
    
    <div class="nav-links">
        <a href="Deco4.html" class="nav-sq" id="link-Deco4">Deco4</a>
        <a href="2EMEC.html" class="nav-sq" id="link-2EMEC">2EMEC</a>
        <a href="Ui.html" class="nav-sq" id="link-Ui">Ui</a>
    </div>
  </div>
  <div id="mobile-overlay"></div>
  <button id="toggle-controls-btn" class="mobile-toggle-btn left">
    <span class="material-icons">settings</span>
  </button>
  <button id="toggle-sidebar-btn" class="mobile-toggle-btn right">
    <span class="material-icons">view_list</span>
  </button>
  <div class="controls">
    <div class="control-group">
<div class="d-flex align-items-center mb-3" style="border-bottom: 1px solid #333; padding-bottom: 10px; gap: 10px;">
    
    <button id="go-back-btn" class="btn btn-outline-secondary btn-sm d-flex align-items-center justify-content-center" 
            style="width: 32px; height: 32px; padding: 0; border-color: #495057;" 
            title="رجوع">
        <span class="material-icons" style="font-size: 1.2rem; color: #adb5bd;">arrow_back</span> 
    </button>

    <h2 class="fw-bold m-0 d-flex align-items-center gap-2" style="color: #0d6efd; font-size: 1.4rem;">
        <span class="material-icons">print</span>
        Etiquette
    </h2>
    
</div>
        <button class="print-btn" onclick="showPrintDialog()">طباعة الصفحة الحالية</button>
        <button class="print-btn" onclick="showBatchPrintDialog()" style="background-color: #198754; margin-top: 5px;">
            <span class="material-icons" style="font-size: 1.2em; vertical-align: middle;">dynamic_feed</span>
            طباعة مجمعة
        </button>
        <div class="buttons-container">
            <button id="addModelBtn" class="action-btn add-model-btn">اضافة</button>
            <button id="exportAppBtn" class="action-btn export-btn">تصدير</button>
        </div>
    </div>

    <div class="control-group">
        <label for="headerLogoFileInput">تحميل صورة للرأس (يمين):</label>
        <input type="file" id="headerLogoFileInput" accept="image/*">
    </div>
    
    <div class="control-group">
      <label for="refInput">Référence</label>
      <input list="refOptions" id="refInput" value="" placeholder="مثال: CIMAISE 207-1"/>
      <datalist id="refOptions">
        <option value="CIMAISE 200-1"></option>
        <option value="CIMAISE 201-1"></option>
        <option value="CIMAISE 202-1"></option>
        <option value="CIMAISE 203-1"></option>
        <option value="CIMAISE 204-1"></option>
        <option value="CIMAISE 206-1"></option>
        <option value="CIMAISE 207-1"></option>
        <option value="CIMAISE 208-1"></option>
        <option value="CIMAISE 209-1"></option>
        <option value="PLINTHE 100-1"></option>
        <option value="PLINTHE 101-1"></option>
        <option value="PLINTHE 103-1"></option>
        <option value="PLINTHE 104-1"></option>
        <option value="PLINTHE 105-1"></option>
        <option value="PLINTHE 106-1"></option>
        <option value="Wall panel 400-1"></option>
        <option value="Wall panel 401-1"></option>
        <option value="Wall panel 402-1"></option>
        <option value="CORNIERE 351-1"></option>
        <option value="CORNICHE 300-1"></option>
        <option value="CORNICHE 301-1"></option>
        <option value="CORNIERE 353-1"></option>
        <option value="PLINTHE 116-1"></option>
        <option value="CIMAISE 217-1"></option>
        <option value="PLINTHE 109-1"></option>
        <option value="PLINTHE 117-1"></option>
        <option value="CIMAISE 215-1"></option>
        <option value="CIMAISE 216-1"></option>
        <option value="CORNICHE 315-1"></option>
        <option value="PLINTHE 102-1"></option>
      </datalist>
    </div>
    <div class="control-group"> <label for="pcsInput">العدد/كرتون:</label> <input type="text" id="pcsInput" value="15" placeholder="مثال: 15"> </div>
    <div class="control-group"> <label for="widthInput">العرض (مم):</label> <input type="text" id="widthInput" value="100" placeholder="مثال: 64"> </div>
    <div class="control-group"> <label for="thicknessInput">السمك (مم):</label> <input type="text" id="thicknessInput" value="12" placeholder="مثال: 39"> </div>
    
    <div class="control-group">
        <label>خيارات العرض</label>
        <div class="display-options">
            <label>
                <input type="checkbox" id="toggleQrCode" checked>
                <span>إظهار QR Code</span>
            </label>
            <label>
                <input type="checkbox" id="toggleSameCodeInRow" checked>
                <span>رمز موحد لكل سطر</span>
            </label>
        <label>
                <input type="checkbox" id="toggleShapes">
                <span>إظهار الأشكال الملونة</span>
            </label>  
        </div>
    </div>
    
    <div class="control-group">
      <label>إخفاء الملصقات</label>
      <div id="hide-container">
        </div>
    </div>

  </div>

  <div class="sidebar">
    <button class="sidebar-button CIMAISE" data-ref="CIMAISE 200-1">CIMAISE 200-1</button>
    <button class="sidebar-button CIMAISE" data-ref="CIMAISE 201-1">CIMAISE 201-1</button>
    <button class="sidebar-button CIMAISE" data-ref="CIMAISE 202-1">CIMAISE 202-1</button>
    <button class="sidebar-button CIMAISE" data-ref="CIMAISE 203-1">CIMAISE 203-1</button>
    <button class="sidebar-button CIMAISE" data-ref="CIMAISE 204-1">CIMAISE 204-1</button>
    <button class="sidebar-button CIMAISE" data-ref="CIMAISE 206-1">CIMAISE 206-1</button>
    <button class="sidebar-button CIMAISE" data-ref="CIMAISE 207-1">CIMAISE 207-1</button>
    <button class="sidebar-button CIMAISE" data-ref="CIMAISE 208-1">CIMAISE 208-1</button>
    <button class="sidebar-button CIMAISE" data-ref="CIMAISE 209-1">CIMAISE 209-1</button>
    <button class="sidebar-button CIMAISE is-new" data-ref="CIMAISE 215-1">CIMAISE 215-1</button>
    <button class="sidebar-button CIMAISE is-new" data-ref="CIMAISE 216-1">CIMAISE 216-1</button>
    <button class="sidebar-button CIMAISE is-new" data-ref="CIMAISE 217-1">CIMAISE 217-1</button>

    <button class="sidebar-button PLINTHE" data-ref="PLINTHE 100-1">PLINTHE 100-1</button>
    <button class="sidebar-button PLINTHE" data-ref="PLINTHE 101-1">PLINTHE 101-1</button>
    <button class="sidebar-button PLINTHE is-new" data-ref="PLINTHE 102-1">PLINTHE 102-1</button>
    <button class="sidebar-button PLINTHE" data-ref="PLINTHE 103-1">PLINTHE 103-1</button>
    <button class="sidebar-button PLINTHE" data-ref="PLINTHE 104-1">PLINTHE 104-1</button>
    <button class="sidebar-button PLINTHE" data-ref="PLINTHE 105-1">PLINTHE 105-1</button>
    <button class="sidebar-button PLINTHE" data-ref="PLINTHE 106-1">PLINTHE 106-1</button>
    <button class="sidebar-button PLINTHE is-new" data-ref="PLINTHE 109-1">PLINTHE 109-1</button>
    <button class="sidebar-button PLINTHE is-new" data-ref="PLINTHE 116-1">PLINTHE 116-1</button>
    <button class="sidebar-button PLINTHE is-new" data-ref="PLINTHE 117-1">PLINTHE 117-1</button>

    <button class="sidebar-button Wall-panel" data-ref="Wall panel 400-1">Wall panel 400-1</button>
    <button class="sidebar-button Wall-panel" data-ref="Wall panel 401-1">Wall panel 401-1</button>
    <button class="sidebar-button Wall-panel" data-ref="Wall panel 402-1">Wall panel 402-1</button>
    
    <button class="sidebar-button CORNICHE" data-ref="CORNICHE 300-1">CORNICHE 300-1</button>
    <button class="sidebar-button CORNICHE" data-ref="CORNICHE 301-1">CORNICHE 301-1</button>
    <button class="sidebar-button CORNICHE is-new" data-ref="CORNICHE 315-1">CORNICHE 315-1</button>

    <button class="sidebar-button CORNIERE" data-ref="CORNIERE 351-1">CORNIERE 351-1</button>
    <button class="sidebar-button CORNIERE is-new" data-ref="CORNIERE 353-1">CORNIERE 353-1</button>
  </div>
  
  <div id="editor-page">
    <div class="a4-viewport">
      <div id="a4" class="a4-container">
        <div class="page-header">
          <div class="header-text" contenteditable="true">...</div>
          <img id="headerLogo" class="header-logo" src="" alt="Header Logo" style="display: none;">
        </div>

        <div class="labels-grid">
          <div class="label-box">
            <div class="qr-code-container"></div>
            <div class="corner-shape"></div>
            <div class="bubble-container"></div>
            <img class="bg-shape" src="https://i.imgur.com/csZfnUg.png" alt="">
            <div class="text-area">
              <div class="ref">Référence : C.5.2.1</div>
              <div class="pcs">PCS/Carton: 15</div>
              <div class="dim">Dimensions: 100 x 12 mm</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="print-output" style="display: none;"></div>

  <div id="printModal" class="print-modal-overlay">
      <div class="print-modal">
          <h3>عدد النسخ للطباعة</h3>
          <input type="number" id="pageCountInput" value="1" min="1">
          <div class="modal-actions">
              <button id="confirmPrintBtn" class="btn-confirm">تأكيد الطباعة</button>
              <button id="cancelPrintBtn" class="btn-cancel">إلغاء</button>
          </div>
      </div>
  </div>

<div id="batchPrintModal" class="print-modal-overlay">
  <div class="batch-modal-content">
    <div class="modal-header">
      <span class="material-icons">settings_applications</span>
      إعدادات الطباعة المجمعة
    </div>
    <div class="modal-body">
      <div id="batch-print-table-container">
        <table class="table table-bordered table-striped table-hover">
          <thead style="text-align: center; font-size: 0.9em;">
            <tr>
              <th style="width: 25%;">اختيار المنتج</th>
              <th style="width: 25%;">Référence (للطباعة)</th>
              <th style="width: 30%;">نص رأس الصفحة</th>
              <th style="width: 10%;">عدد الصفحات</th>
              <th style="width: 10%;">إزالة</th>
            </tr>
          </thead>
          <tbody id="batch-print-list">
            </tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer">
      <div>
        <button id="addBatchRowBtn" class="btn btn-sm btn-outline-primary">إضافة منتج آخر</button>
        <button id="addPageBreakBtn" class="btn btn-sm btn-outline-secondary">إضافة فاصل صفحات</button>
      </div>
      <div>
        <button id="cancelBatchPrintBtn" class="btn-cancel">إلغاء</button>
        <button id="confirmBatchPrintBtn" class="btn-confirm" style="background-color: #198754;">تأكيد الطباعة المجمعة</button>
      </div>
    </div>
  </div>
</div>

  <div id="modelModal" class="modal-overlay" data-mode="add">
      <div class="modal-content">
          <h3 id="modelModalTitle">إضافة مودال جديد</h3>
          <input type="hidden" id="originalModelRef" value=""> 
          <div class="form-group">
              <label for="modelCategory">نوع المودال:</label>
              <select id="modelCategory">
                  <option value="CIMAISE">CIMAISE</option>
                  <option value="PLINTHE">PLINTHE</option>
                  <option value="Wall-panel">Wall panel</option>
                  <option value="CORNICHE">CORNICHE</option>
                  <option value="CORNIERE">CORNIERE</option>
                  <option value="CADRE">CADRE</option>
              </select>
          </div>
          <div class="form-group">
              <label for="modelNumber">رقم الموديل (الاسم الظاهري):</label>
              <input type="text" id="modelNumber" placeholder="مثال: 200-1">
          </div>
          <div class="form-group">
              <label for="modelLookupRef">الاسم المرافق (للبيانات والقصاصة):</label>
              <input type="text" id="modelLookupRef" placeholder="مثال: 5218-1">
          </div>
          <div class="form-group">
              <label for="modelPcs">PCS/Carton:</label>
              <input type="text" id="modelPcs" placeholder="مثال: 15">
          </div>
          <div class="form-group inline">
              <div>
                <label for="modelWidth">العرض (مم):</label>
                <input type="text" id="modelWidth" placeholder="مثال: 64">
              </div>
              <div>
                <label for="modelThickness">السمك (مم):</label>
                <input type="text" id="modelThickness" placeholder="مثال: 39">
              </div>
            </div>
          <div class="form-group checkbox-group">
              <input type="checkbox" id="modelIsNew">
              <label for="modelIsNew">إضافة علامة "جديد"</label>
          </div>
          <div class="modal-actions">
              <button id="saveModelBtn" class="btn-confirm">حفظ</button>
              <button id="cancelModelBtn" class="btn-cancel">إلغاء</button>
          </div>
      </div>
  </div>

<div id="temp-render-container" style="position: absolute; top: -9999px; left: -9999px; opacity: 0;"></div>


<div id="codesModal" class="print-modal-overlay">
      <div class="batch-modal-content" style="width: 800px;"> <div class="modal-header">
            <span class="material-icons">qr_code_2</span>
            دليل رموز المنتجات والباراركود
        </div>
        <div class="modal-body">
            <div class="codes-table-container">
                <table class="table table-bordered table-hover codes-table">
                    <thead class="table-dark">
                        <tr>
                            <th>اسم المودال (الظاهري)</th>
                            <th>الاسم البديل (Code)</th>
                            <th>(QR String)</th>
                        </tr>
                    </thead>
                    <tbody id="codesTableBody">
                        </tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeCodesModal()" class="btn-cancel">إغلاق</button>
        </div>
      </div>
  </div>
<script>
    let refData = {
      'C.5.2.1':     { pcs: '40', width: '52', thickness: '2900' }, 
      'C.4.1':       { pcs: '65', width: '40', thickness: '2900' }, 
      'C.6.1':       { pcs: '30', width: '60', thickness: '2900' }, 
      'C.3.5.1':     { pcs: '72', width: '35', thickness: '2900' }, 
      'C.3.1':       { pcs: '104', width: '31', thickness: '2900' }, 
      'C.2.5.1':     { pcs: '120', width: '25', thickness: '2900' }, 
      'C.4.2':       { pcs: '50', width: '40', thickness: '2900' }, 
      'C.7.1':       { pcs: '29', width: '70', thickness: '2900' }, 
      'C.3.5.1':   { pcs: '66', width: '40', thickness: '2900' }, 
      'CP.10.1':     { pcs: '24', width: '100', thickness: '2900' }, 
      'P.11.1':      { pcs: '12', width: '110', thickness: '2900' }, 
      'P.7.1':       { pcs: '37', width: '71', thickness: '2900' }, 
      'P.12.1':      { pcs: '18', width: '121', thickness: '2900' }, 
      'P.10.1':      { pcs: '24', width: '100', thickness: '2900' }, 
      'P.10.2':      { pcs: '20', width: '100', thickness: '2900' }, 
      'WP.200.1':    { pcs: '13', width: '121', thickness: '2900' }, 
      'WP.201.1':    { pcs: '56', width: '34', thickness: '2900' }, 
      'WP.202.1':    { pcs: '20', width: '118', thickness: '2900' }, 
      'Cr.3.1':      { pcs: '84', width: '30', thickness: '2900' }, 
      'Cr.10.1':     { pcs: '14', width: '100', thickness: '2900' }, 
      'Cr.7.1':      { pcs: '21', width: '72', thickness: '2900' }, 
      'CR.3.2':      { pcs: '108', width: '30', thickness: '2900' }, 
      'P.10.3':      { pcs: '26', width: '100', thickness: '2900' }, 
      'C.2.5.2':     { pcs: '125', width: '25', thickness: '2900' }, 
      'PL.10.1':     { pcs: '15', width: '100', thickness: '2900' }, 
      'PLINTHE 117-1': { pcs: '17', width: '120', thickness: '2900' }, 
      'C.6.2':       { pcs: '33', width: '60', thickness: '2900' }, 
      'C.4.3':       { pcs: '65', width: '40', thickness: '2900' }, 
      'CR.5.7.1':    { pcs: '22', width: '57', thickness: '2900' }, 
      'CP.14.4.1':   { pcs: '14', width: '144', thickness: '2900' } 
    };

    let referenceMap = {
      'CIMAISE 200-1': 'C.5.2.1',
      'CIMAISE 201-1': 'C.4.1',
      'CIMAISE 202-1': 'C.6.1',
      'CIMAISE 203-1': 'C.3.5.1',
      'CIMAISE 204-1': 'C.3.1',
      'CIMAISE 206-1': 'C.2.5.1',
      'CIMAISE 207-1': 'C.4.2',
      'CIMAISE 208-1': 'C.7.1',
      'CIMAISE 209-1': 'C.3.5.1',
      'PLINTHE 100-1': 'CP.10.1',
      'PLINTHE 101-1': 'P.11.1',
      'PLINTHE 103-1': 'P.7.1',
      'PLINTHE 104-1': 'P.12.1',
      'PLINTHE 105-1': 'P.10.1',
      'PLINTHE 106-1': 'P.10.2',
      'Wall panel 400-1': 'WP.200.1',
      'Wall panel 401-1': 'WP.201.1',
      'Wall panel 402-1': 'WP.202.1',
      'CORNIERE 351-1': 'Cr.3.1',
      'CORNICHE 300-1': 'Cr.10.1',
      'CORNICHE 301-1': 'Cr.7.1',
      'CORNIERE 353-1': 'CR.3.2',
      'PLINTHE 116-1': 'P.10.3',
      'CIMAISE 217-1': 'C.2.5.2',
      'PLINTHE 109-1': 'PL.10.1',
      'PLINTHE 117-1': 'PLINTHE 117-1',
      'CIMAISE 215-1': 'C.6.2',
      'CIMAISE 216-1': 'C.4.3',
      'CORNICHE 315-1': 'CR.5.7.1',
      'PLINTHE 102-1': 'CP.14.4.1'
    };

    let reverseReferenceMap = {};
    
    function initReferenceMaps() {
        reverseReferenceMap = {};
        for (const key in referenceMap) {
            reverseReferenceMap[referenceMap[key]] = key;
        }
        document.querySelectorAll('.sidebar-button').forEach(btn => {
            const ref = btn.dataset.ref;
            if(!referenceMap[ref] && refData[ref]) {
                referenceMap[ref] = ref;
                reverseReferenceMap[ref] = ref;
            }
        });
    }
    initReferenceMaps();

    const refInput = document.getElementById('refInput');
    const pcsInput = document.getElementById('pcsInput');
    const widthInput = document.getElementById('widthInput');
    const thicknessInput = document.getElementById('thicknessInput');
    const headerLogoFileInput = document.getElementById('headerLogoFileInput');
    function calculateWeeksAndDayOfWeek(d){const a=new Date(d),e=new Date,t=Math.abs(e-a),n=Math.floor(t/864e5),s=Math.floor(n/7);return`${s}-${(e.getDay()+1)%7}`}
    function generateShortUniqueId(){const d=Math.random().toString(36).substring(2,6),a=String(Math.floor(1e3*Math.random())).padStart(3,"0");return(d+a).slice(0,7)}
    function formatRefForQR(d){const a=["CIMAISE","PLINTHE","Wall panel","CORNIERE","CADRE","CORNICHE","Référence :"];let e=d.trim(),t=!0;for(;t;){t=!1;for(const n of a){const s=new RegExp(`^${n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}\\s*`,"i");if(s.test(e)){e=e.replace(s,""),t=!0;break}}}return e}
    function getStyleAttributesFromRef(d){if (!d || typeof d !== 'string') {return { color: '#cccccc', size: 30 };}
        const a=d.trim();let e=0,t="DEFAULT";const n=a.match(/(\d)-\d+$/);n&&n[1]&&(t=n[1],e=parseInt(t,10));const s=100*e%360,r=0===e||1===e?30+20*e:70+3*e,i=8===e||0===e?40:50+2*e,o=Math.min(100,Math.max(0,r)),l=Math.min(100,Math.max(0,i)),c=`hsl(${s}, ${o}%, ${l}%)`;let g=0;const h=t.length>0?t:"X";for(let m=0;m<h.length;m++)g=h.charCodeAt(m)+(g<<5)-g,g&=g;return{color:c,size:30+Math.abs(g)%21}}
    function getCornerRotation(d){if (!d || typeof d !== 'string') return 0;
        const a=d.toUpperCase().trim();return a.startsWith("PLINTHE")?0:a.startsWith("CADRE")?0:a.startsWith("WALL PANEL")?15:a.startsWith("CIMAISE")?-10:a.startsWith("CORNIERE")?0:0}
    function getCornerShapeClipPath(d){if (!d || typeof d !== 'string') return "polygon(0 0, 100% 0, 0 100%)";
        const a=d.toUpperCase().trim();return a.startsWith("CIMAISE")?"polygon(0 0, 100% 0, 100% 40%, 40% 40%, 40% 100%, 0 100%)":a.startsWith("PLINTHE")?"polygon(0 0, 100% 0, 100% 100%, 30% 100%, 0 70%)":a.startsWith("CADRE")?"polygon(0 0, 100% 0, 100% 100%, 0 100%)":a.startsWith("WALL PANEL")?"polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%)":a.startsWith("CORNIERE")?"polygon(0 0, 30% 0, 30% 70%, 0 100%)":"polygon(0 0, 100% 0, 0 100%)"}
    function getLastSuffixNumber(d){if (!d || typeof d !== 'string') return null;
        const a=d.trim().match(/-(\d+)$/);return a?parseInt(a[1],10):null}
    
    // توليد Data Matrix باستخدام bwip-js
// دالة محدثة لتوليد QR بناءً على محتوى الملصق
function updateLabelQR(labelBox) {
        const qrContainer = labelBox.querySelector(".qr-code-container");
        if (!qrContainer) return;
        qrContainer.innerHTML = "";
        
        // 1. قراءة المرجع
        const refText = labelBox.querySelector(".ref").textContent.replace("Référence : ", "").trim() || "N/A";
        
        // 2. قراءة العدد
        // نستخدم Regex لاستخراج الأرقام فقط من نص العدد لتجنب الأخطاء إذا مسحت كلمة PCS
        const pcsContent = labelBox.querySelector(".pcs").textContent;
        const pcsMatch = pcsContent.match(/(\d+)/); // البحث عن أول رقم
        const pcsVal = pcsMatch ? pcsMatch[0] : "0";

        // 3. قراءة الأبعاد وحساب الطول
        const dimContent = labelBox.querySelector(".dim").textContent;
        // تنظيف النص: نحذف كلمة Dimensions و cm أو mm وأي مسافات
        // نفترض الصيغة: رقم x رقم
        const cleanDim = dimContent.replace(/Dimensions:|cm|mm/gi, "").trim();
        const parts = cleanDim.split('x');
        
        let calculatedLength = 0;
        
        // إذا وجدنا جزئين (عرض x طول)، نأخذ الجزء الثاني
        if (parts.length >= 2) {
            const val = parseFloat(parts[1].trim());
            if (!isNaN(val)) {
                calculatedLength = val / 10; // المعادلة: الطول تقسيم 10
            }
        }

        // تكوين النص: Ref-Length-PCS
        const qrString = `${refText}-${calculatedLength}-${pcsVal}`;
        
        const canvas = document.createElement('canvas');
        try {
            bwipjs.toCanvas(canvas, {
                bcid:        'datamatrix',        
                text:        qrString,
                scale:       3,                
                height:      10,              
                width:       10,              
                includetext: false,            
                barcolor:    '000000' 
            });
            canvas.style.width = '44px';
            canvas.style.height = '44px';
            qrContainer.appendChild(canvas);
        } catch (e) {
            console.error(e);
        }
        
    }
    
    function updateLabels(){
        const userInput = refInput.value.trim();
        const lookupRef = referenceMap[userInput] || userInput;
        
        if (refData.hasOwnProperty(lookupRef)) {
            pcsInput.value = refData[lookupRef].pcs;
            widthInput.value = refData[lookupRef].width;
            thicknessInput.value = refData[lookupRef].thickness;
        }
        
        const a=pcsInput.value.trim(),e=widthInput.value.trim(),t=thicknessInput.value.trim(),n=document.getElementById("toggleQrCode").checked,s=document.getElementById("toggleShapes").checked,r=document.getElementById("toggleSameCodeInRow").checked,{color:i,size:o}=getStyleAttributesFromRef(lookupRef),l=getCornerRotation(lookupRef),c=getCornerShapeClipPath(lookupRef),g=getLastSuffixNumber(lookupRef),h=g>0?g:0,m=Math.max(20,o*(g>=2?.8:1));let p="";
        
        document.querySelectorAll("#editor-page .label-box").forEach((u,f)=>{
            const b=u.querySelector(".ref");
            b.dataset.manual||(b.textContent="Référence : "+(lookupRef||"N/A"));
            
            const y=u.querySelector(".pcs");y.dataset.manual||(y.textContent="PCS/Carton: "+(a||"N/A"));
            
            const v=u.querySelector(".dim");
            const widthCm = e ? (parseFloat(e) / 10) : "N/A";
            const thickCm = t ? (parseFloat(t) / 10) : "N/A";
            v.dataset.manual||(v.textContent=`Dimensions: ${widthCm} x ${thickCm} cm`);
            
            u.classList.toggle("hide-qr",!n),u.classList.toggle("hide-shapes",!s);const w=u.querySelector(".corner-shape");w&&(w.style.backgroundColor=i,w.style.width=`${m}px`,w.style.height=`${m}px`,w.style.transform=`rotate(${l}deg)`,w.style.clipPath=c);const L=u.querySelector(".bubble-container");if(L){L.innerHTML="";for(let C=0;C<h;C++){const I=document.createElement("div");I.classList.add("bubble"),I.style.backgroundColor=i,L.appendChild(I)}}let q;r?f%2==0?(p=generateShortUniqueId(),q=p):q=p:q=generateShortUniqueId(),updateLabelQR(u,q)
        })
    }
    
    function generateAndPrintPages(d){const a=document.getElementById("print-output");a.innerHTML="";const e=document.getElementById("a4"),t=document.getElementById("toggleSameCodeInRow").checked;for(let n=0;n<d;n++){const s=e.cloneNode(!0);s.removeAttribute("id");const r=s.querySelector(".header-text");r&&r.removeAttribute("contenteditable");let i="";const o=s.querySelectorAll(".label-box");o.forEach((l,c)=>{const g=document.querySelectorAll("#editor-page .label-box")[c];g&&(l.innerHTML=g.innerHTML,l.className=g.className);let h;t?c%2==0?(i=generateShortUniqueId(),h=i):h=i:h=generateShortUniqueId(),updateLabelQR(l,h)}),a.appendChild(s)}window.print()}
    function showPrintDialog(){document.getElementById("printModal").classList.add("visible")}
    function hidePrintDialog(){document.getElementById("printModal").classList.remove("visible")}

    const batchPrintModal = document.getElementById('batchPrintModal');
    const batchPrintList = document.getElementById('batch-print-list');
    
    function saveBatchData() {
        const rows = document.querySelectorAll('#batch-print-list tr');
        const dataToSave = [];
        rows.forEach(row => {
            const type = row.dataset.type;
            if (type === 'product') {
                const ref = row.querySelector('.batch-ref-input').value;
                const quantity = row.querySelector('.batch-quantity-input').value;
                const selectedValue = row.querySelector('.batch-ref-select').value;
                const headerText = row.querySelector('.batch-header-input').value;
                dataToSave.push({ type: 'product', ref, quantity, selectedValue, headerText });
            } else if (type === 'break') {
                const text = row.querySelector('.page-break-input').value;
                dataToSave.push({ type: 'break', text });
            }
        });
        localStorage.setItem('batchPrintData', JSON.stringify(dataToSave));
    }

    function loadBatchData() {
        const savedDataJSON = localStorage.getItem('batchPrintData');
        if (!savedDataJSON) return false;
        try {
            const savedData = JSON.parse(savedDataJSON);
            batchPrintList.innerHTML = ''; 
            if (savedData.length === 0) return false;
            savedData.forEach(item => {
                if (item.type === 'product') createBatchRow(item);
                else if (item.type === 'break') createPageBreakRow(item);
            });
            return true;
        } catch (e) {
            console.error("Failed to load batch data from localStorage", e);
            return false;
        }
    }
    
    function updateRefOptionsHTML() {
        const buttons = document.querySelectorAll('.sidebar .sidebar-button');
        return Array.from(buttons)
        .map(button => `<option value="${button.dataset.ref}">${button.textContent.trim()}</option>`)
        .join('');
    }

    function createBatchRow(data = { ref: '', quantity: 1, selectedValue: '', headerText: '' }) {
        const tr = document.createElement('tr');
        tr.dataset.type = 'product';
        tr.innerHTML = `
            <td><select class="form-select batch-ref-select"><option value="">-- اختر منتج --</option>${updateRefOptionsHTML()}</select></td>
            <td><input type="text" class="form-control batch-ref-input"></td>
            <td><input type="text" class="form-control batch-header-input" placeholder="اختياري..."></td>
            <td><input type="number" class="form-control batch-quantity-input" min="1"></td>
            <td class="text-center"><button class="btn btn-danger btn-sm remove-batch-row-btn w-100">X</button></td>
        `;
        
        const selectEl = tr.querySelector('.batch-ref-select');
        const refInputEl = tr.querySelector('.batch-ref-input');
        const headerInputEl = tr.querySelector('.batch-header-input');
        const quantityEl = tr.querySelector('.batch-quantity-input');

        selectEl.value = data.selectedValue || '';
        refInputEl.value = data.ref || '';
        headerInputEl.value = data.headerText || '';
        quantityEl.value = data.quantity || 1;

        selectEl.addEventListener('change', () => { refInputEl.value = selectEl.value; saveBatchData(); });
        refInputEl.addEventListener('input', saveBatchData);
        headerInputEl.addEventListener('input', saveBatchData);
        quantityEl.addEventListener('input', saveBatchData);

        tr.querySelector('.remove-batch-row-btn').addEventListener('click', () => { tr.remove(); saveBatchData(); });
        batchPrintList.appendChild(tr);
    }

    function createPageBreakRow(data = { text: '' }) {
        const tr = document.createElement('tr');
        tr.dataset.type = 'break';
        tr.classList.add('page-break-row');
        tr.innerHTML = `
            <td colspan="4"><input type="text" class="form-control page-break-input" placeholder="اكتب نصًا للفاصل (اختياري) أو اتركه فارغًا لصفحة بيضاء"></td>
            <td class="text-center"><button class="btn btn-danger btn-sm remove-batch-row-btn w-100">X</button></td>
        `;
        const inputEl = tr.querySelector('.page-break-input');
        inputEl.value = data.text || '';
        inputEl.addEventListener('input', saveBatchData);
        tr.querySelector('.remove-batch-row-btn').addEventListener('click', () => { tr.remove(); saveBatchData(); });
        batchPrintList.appendChild(tr);
    }

    function showBatchPrintDialog() {
        const dataLoaded = loadBatchData();
        if (!dataLoaded) { createBatchRow(); saveBatchData(); }
        batchPrintModal.classList.add('visible');
    }

    function hideBatchPrintDialog() { batchPrintModal.classList.remove('visible'); }

    function populateLabel(labelElement, ref) {
        const lookupRef = referenceMap[ref] || ref;
        let initialDataRef = lookupRef;
        if(!refData.hasOwnProperty(lookupRef)) {
            initialDataRef = Object.keys(refData).find(key => key === lookupRef) || Object.keys(refData).find(key => lookupRef.startsWith(key.split(' ')[0]));
        }
        const data = refData[initialDataRef] || { pcs: 'N/A', width: 'N/A', thickness: 'N/A' };
        labelElement.classList.remove('hidden');
        const showQr = document.getElementById('toggleQrCode').checked;
        const showShapes = document.getElementById('toggleShapes').checked;

        labelElement.querySelector('.ref').textContent = `Référence : ${lookupRef}`; 
        labelElement.querySelector('.pcs').textContent = `PCS/Carton: ${data.pcs || 'N/A'}`;
        
        const widthCm = data.width ? (parseFloat(data.width) / 10) : "N/A";
        const thickCm = data.thickness ? (parseFloat(data.thickness) / 10) : "N/A";
        labelElement.querySelector('.dim').textContent = `Dimensions: ${widthCm} x ${thickCm} cm`;
        
        labelElement.classList.toggle('hide-qr', !showQr);
        labelElement.classList.toggle('hide-shapes', !showShapes);

        const { color, size } = getStyleAttributesFromRef(initialDataRef);
        const rotation = getCornerRotation(initialDataRef);
        const clipPath = getCornerShapeClipPath(initialDataRef);
        const suffix = getLastSuffixNumber(initialDataRef);
        const bubbleCount = suffix > 0 ? suffix : 0;
        const shapeSize = Math.max(20, size * (suffix >= 2 ? 0.8 : 1));

        const cornerShape = labelElement.querySelector('.corner-shape');
        if (cornerShape) {
            cornerShape.style.backgroundColor = color;
            cornerShape.style.width = `${shapeSize}px`;
            cornerShape.style.height = `${shapeSize}px`;
            cornerShape.style.transform = `rotate(${rotation}deg)`;
            cornerShape.style.clipPath = clipPath;
        }
        const bubbleContainer = labelElement.querySelector('.bubble-container');
        if (bubbleContainer) {
            bubbleContainer.innerHTML = '';
            for (let i = 0; i < bubbleCount; i++) {
                const bubble = document.createElement('div');
                bubble.classList.add('bubble');
                bubble.style.backgroundColor = color;
                bubbleContainer.appendChild(bubble);
            }
        }
        updateLabelQR(labelElement, generateShortUniqueId());
    }

    function generateBatchPrintPages() {
        const printOutput = document.getElementById('print-output');
        printOutput.innerHTML = '';
        const rows = document.querySelectorAll('#batch-print-list tr');
        const templatePage = document.getElementById('a4');
        const originalHeaderText = templatePage.querySelector('.header-text').textContent;

        if (rows.length === 0) { alert('الرجاء إضافة منتجات للطباعة.'); return; }

        rows.forEach(row => {
            if (row.dataset.type === 'product') {
                const ref = row.querySelector('.batch-ref-input').value.trim();
                const pageCount = parseInt(row.querySelector('.batch-quantity-input').value, 10) || 0;
                const headerText = row.querySelector('.batch-header-input').value.trim();
                if (ref && pageCount > 0) {
                    for (let i = 0; i < pageCount; i++) {
                        const newPage = templatePage.cloneNode(true);
                        newPage.removeAttribute('id');
                        const pageHeaderTextEl = newPage.querySelector('.header-text');
                        pageHeaderTextEl.textContent = headerText || originalHeaderText;
                        pageHeaderTextEl.removeAttribute('contenteditable');
                        const labelBoxes = newPage.querySelectorAll('.label-box');
                        labelBoxes.forEach(box => { populateLabel(box, ref); });
                        printOutput.appendChild(newPage);
                    }
                }
            } else if (row.dataset.type === 'break') {
                const breakText = row.querySelector('.page-break-input').value.trim();
                const breakPage = templatePage.cloneNode(true);
                breakPage.removeAttribute('id');
                const grid = breakPage.querySelector('.labels-grid');
                grid.innerHTML = ''; 
                if (breakText) {
                    const textContainer = document.createElement('div');
                    textContainer.className = 'page-break-text-container';
                    textContainer.textContent = breakText;
                    grid.appendChild(textContainer);
                }
                printOutput.appendChild(breakPage);
            }
        });
        if (printOutput.children.length > 0) { window.print(); } else { alert('لم يتم تحديد أي صفحات للطباعة.'); }
    }
    
    const modelModal = document.getElementById('modelModal');
    const modelModalTitle = document.getElementById('modelModalTitle');
    const originalModelRefInput = document.getElementById('originalModelRef');
    const modelCategorySelect = document.getElementById('modelCategory');
    const modelNumberInput = document.getElementById('modelNumber');
    const modelLookupRefInput = document.getElementById('modelLookupRef');
    const modelPcsInput = document.getElementById('modelPcs');
    const modelWidthInput = document.getElementById('modelWidth');
    const modelThicknessInput = document.getElementById('modelThickness');
    const modelIsNewCheckbox = document.getElementById('modelIsNew');

    function openModelModal(mode, displayRef = null) {
        originalModelRefInput.value = '';
        modelLookupRefInput.value = '';
        if (mode === 'add') {
            modelModalTitle.textContent = 'إضافة مودال جديد';
            modelModal.dataset.mode = 'add';
            modelCategorySelect.value = 'CIMAISE';
            modelNumberInput.value = '';
            modelPcsInput.value = '';
            modelWidthInput.value = '';
            modelThicknessInput.value = '';
            modelIsNewCheckbox.checked = false;
        } else if (mode === 'edit' && displayRef) {
            const lookupRef = referenceMap[displayRef] || displayRef;
            if (!refData[lookupRef]) return;
            modelModalTitle.textContent = 'تعديل المودال';
            modelModal.dataset.mode = 'edit';
            originalModelRefInput.value = displayRef;
            const data = refData[lookupRef];
            const button = document.querySelector(`.sidebar-button[data-ref="${displayRef}"]`);
            
            const categories = ['CIMAISE', 'PLINTHE', 'Wall-panel', 'CORNICHE', 'CORNIERE', 'CADRE'];
            let category = 'CIMAISE';
            let number = displayRef;
            for (const cat of categories) {
                const prefix = cat === 'Wall-panel' ? 'Wall panel ' : cat.toUpperCase() + ' ';
                if (displayRef.toUpperCase().startsWith(prefix.toUpperCase()) || (cat === 'Wall-panel' && displayRef.startsWith('WP'))) {
                   if(displayRef.startsWith('WP')) {
                       category = 'Wall-panel';
                       number = displayRef; 
                   } else {
                       category = cat;
                       number = displayRef.substring(cat.length).trim();
                   }
                   break;
                }
            }
            modelCategorySelect.value = category;
            modelNumberInput.value = number;
            modelLookupRefInput.value = lookupRef;
            modelPcsInput.value = data.pcs;
            modelWidthInput.value = data.width;
            modelThicknessInput.value = data.thickness;
            modelIsNewCheckbox.checked = button ? button.classList.contains('is-new') : false;
        } else { return; }
        modelModal.classList.add('visible');
    }
    
    function hideModelModal() { modelModal.classList.remove('visible'); }
    
    function saveModel() {
        const mode = modelModal.dataset.mode;
        const originalDisplayRef = originalModelRefInput.value;
        const category = modelCategorySelect.value;
        const number = modelNumberInput.value.trim();
        let newLookupRef = modelLookupRefInput.value.trim();
        const pcs = modelPcsInput.value.trim();
        const width = modelWidthInput.value.trim();
        const thickness = modelThicknessInput.value.trim();
        const isNew = modelIsNewCheckbox.checked;

        if (!number || !pcs || !width || !thickness) { alert('الرجاء تعبئة جميع الحقول.'); return; }

        let newDisplayRef = '';
        if(category === 'Wall-panel' && !number.startsWith('Wall panel')) {
             newDisplayRef = `Wall panel ${number}`;
        } else {
             newDisplayRef = `${category} ${number}`;
        }
        if (!newLookupRef) { newLookupRef = newDisplayRef; }

        if (mode === 'add' && (document.querySelector(`[data-ref="${newDisplayRef}"]`))) {
            alert('هذا المودال موجود بالفعل.'); return;
        }
        if (mode === 'edit' && originalDisplayRef) {
             delete referenceMap[originalDisplayRef];
             delete reverseReferenceMap[referenceMap[originalDisplayRef]];
             const button = document.querySelector(`.sidebar-button[data-ref="${originalDisplayRef}"]`);
             if (button) button.remove();
             const option = document.querySelector(`#refOptions option[value="${originalDisplayRef}"]`);
             if (option) option.remove();
        }

        refData[newLookupRef] = { pcs, width, thickness };
        referenceMap[newDisplayRef] = newLookupRef;
        reverseReferenceMap[newLookupRef] = newDisplayRef;
        
        const newButton = document.createElement('button');
        newButton.className = `sidebar-button ${category}`;
        if (isNew) newButton.classList.add('is-new');
        newButton.dataset.ref = newDisplayRef;
        
        attachButtonListeners(newButton);
        insertButtonInOrder(newButton, category);

        const newOption = document.createElement('option');
        newOption.value = newDisplayRef;
        document.getElementById('refOptions').appendChild(newOption);
        
        hideModelModal();
    }

    function insertButtonInOrder(newButton, category) {
        const sidebar = document.querySelector('.sidebar');
        const categoryOrder = ['CIMAISE', 'PLINTHE', 'Wall-panel', 'CORNICHE', 'CORNIERE', 'CADRE'];
        const sameCategoryButtons = document.querySelectorAll(`.sidebar-button.${category}`);
        if (sameCategoryButtons.length > 0) {
            const lastButton = sameCategoryButtons[sameCategoryButtons.length - 1];
            lastButton.after(newButton);
            return;
        }
        const categoryIndex = categoryOrder.indexOf(category);
        for (let i = categoryIndex - 1; i >= 0; i--) {
            const prevCategory = categoryOrder[i];
            const precedingButtons = document.querySelectorAll(`.sidebar-button.${prevCategory}`);
            if (precedingButtons.length > 0) {
                const lastButton = precedingButtons[precedingButtons.length - 1];
                lastButton.after(newButton);
                return;
            }
        }
        for (let i = categoryIndex + 1; i < categoryOrder.length; i++) {
            const nextCategory = categoryOrder[i];
            const nextGroupButton = document.querySelector(`.sidebar-button.${nextCategory}`);
            if (nextGroupButton) { nextGroupButton.before(newButton); return; }
        }
        sidebar.appendChild(newButton);
    }

    function attachButtonListeners(button) {
        const displayRef = button.dataset.ref; // الاسم الظاهري (مثل CIMAISE 200-1)

        // 1. الشريط الجانبي الأيمن: نعرض الاسم الظاهري كما هو (بدون تغيير)
        button.textContent = displayRef;
        
        // إضافة أيقونة التعديل (edit)
        const oldIcon = button.querySelector('.edit-icon');
        if(oldIcon) oldIcon.remove();
        const editIcon = document.createElement('span');
        editIcon.className = 'material-icons edit-icon';
        editIcon.textContent = 'edit';
        editIcon.addEventListener('click', (e) => {
            e.stopPropagation(); 
            openModelModal('edit', displayRef);
        });
        button.appendChild(editIcon);
        
        // 2. عند النقر (التأثير على الشريط الأيسر والملصق)
        button.addEventListener('click', (e) => {
            if (e.target.classList.contains('edit-icon')) return;
            document.querySelectorAll('.label-box [data-manual]').forEach(el => el.removeAttribute('data-manual'));
            
            // هنا التغيير: نجلب الكود (C.5.2.1) ونضعه في خانة الإدخال (الشريط الأيسر)
            const codeRef = referenceMap[displayRef] || displayRef;
            refInput.value = codeRef; 
            
            // نستخرج الرقم (200-1) من الاسم الظاهري لوضعه في رأس الصفحة
            const numberPart = displayRef.split(' ').pop();
            document.querySelector('.header-text').textContent = ` ${numberPart}`;
            
            updateLabels();
            updateURLHash();
        });
    }
    
    function exportApplication() {
        const refDataString = `let refData = ${JSON.stringify(refData, null, 4)};`;
        let currentHtml = document.documentElement.outerHTML;
        const refDataRegex = /let refData = \{[^;]*\};/;
        currentHtml = currentHtml.replace(refDataRegex, refDataString);
        const blob = new Blob([currentHtml], { type: 'text/html' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        const now = new Date();
        const timestamp = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}-${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}`;
        a.download = `etiquette-app-${timestamp}.html`; 
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
    }

    function loadModelFromURL() {
        const hash = window.location.hash.substring(1).trim();
        if (!hash) return;
        
        const parts = hash.split('+');
        const modelHash = decodeURIComponent(parts[0]);
        const headerFromURL = parts.length > 1 ? decodeURIComponent(parts[1]) : null;

        if (modelHash) {
            const lookupRef = Object.keys(refData).find(key => key.endsWith(' ' + modelHash));
            if (lookupRef) {
                refInput.value = lookupRef;
                
                if (!headerFromURL) {
                    const displayRef = reverseReferenceMap[lookupRef] || lookupRef;
                    const numberPart = displayRef.split(' ').pop();
                    document.querySelector('.header-text').textContent = ` ${numberPart}`;
                }
            } else {
                 refInput.value = modelHash; 
            }
        }
        
        if (headerFromURL !== null) {
            document.querySelector('.header-text').textContent = headerFromURL;
        }
        updateLabels();
    }

    function updateURLHash() {
        const headerText = document.querySelector('.header-text').textContent.trim();
        const refValue = refInput.value.trim();
        
        if (!refValue) { 
            history.replaceState(null, '', window.location.pathname + window.location.search); 
            return; 
        }

        let modelIdentifier = refValue;
        const categories = ['Wall-panel', 'CIMAISE', 'PLINTHE', 'CORNICHE', 'CORNIERE', 'CADRE'];
        for (const cat of categories) {
            const prefix = cat === 'Wall-panel' ? 'Wall panel ' : cat + ' ';
            if (refValue.startsWith(prefix)) {
                modelIdentifier = refValue.substring(prefix.length);
                break;
            }
        }

        let newHash = encodeURIComponent(modelIdentifier);
        if (headerText && headerText !== "...") {
            newHash += `+${encodeURIComponent(headerText)}`;
        }

        if ('#' + newHash !== window.location.hash) {
           history.replaceState(null, '', '#' + newHash);
        }
    }
// --- دوال الشريط العلوي وجدول الرموز ---

    const codesModal = document.getElementById('codesModal');
    const codesTableBody = document.getElementById('codesTableBody');

    function openCodesModal() {
        generateCodesTable();
        codesModal.classList.add('visible');
    }

    function closeCodesModal() {
        codesModal.classList.remove('visible');
    }

    function generateCodesTable() {
        codesTableBody.innerHTML = '';
        
        // ترتيب البيانات للعرض
        const sortedKeys = Object.keys(referenceMap).sort();

        sortedKeys.forEach(displayName => {
            const codeName = referenceMap[displayName];
            
            // جلب بيانات المنتج
            let data = refData[codeName];
            
            // محاولة العثور على البيانات إذا كان الاسم البديل غير موجود مباشرة
            if (!data) {
                 // بحث عكسي بسيط أو استخدام القيم الافتراضية
                 const keyFound = Object.keys(refData).find(k => k === codeName);
                 data = keyFound ? refData[keyFound] : null;
            }

            let qrString = "بيانات غير مكتملة";
            
            if (data) {
                // حساب القيم للكود
                // Pcs
                const pcs = data.pcs;
                
                // Length calculation:
                // في البيانات thickness = 2900 (مم)
                // في مثالك P.10.1-29-24، الـ 29 جاءت من 2900 / 100 = 29 (أي 2.9 متر)
                const rawThickness = parseFloat(data.thickness);
                const lengthVal = !isNaN(rawThickness) ? rawThickness / 100 : 0; 
                
                // صيغة الكود: الاسم-الطول-العدد
                qrString = `${codeName}-${lengthVal}-${pcs}`;
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="font-weight:500">${displayName}</td>
                <td>${codeName}</td>
                <td class="code-cell">${qrString}</td>
            `;
            codesTableBody.appendChild(tr);
        });
    }

    // تمييز الصفحة الحالية في الشريط العلوي
    function highlightCurrentPage() {
        const path = window.location.pathname;
        const page = path.split("/").pop(); // الحصول على اسم الملف (مثلاً Deco4.html)
        
        if(page.includes('Deco4')) document.getElementById('link-Deco4').classList.add('active');
        else if(page.includes('2EMEC')) document.getElementById('link-2EMEC').classList.add('active');
        else if(page.includes('Ui')) document.getElementById('link-Ui').classList.add('active');
    }
document.addEventListener('DOMContentLoaded', () => {
        const grid = document.querySelector('#editor-page .labels-grid');
        const template = grid.querySelector('.label-box');
        grid.innerHTML = '';
        
        // إنشاء 8 قصاصات
        for (let i = 0; i < 8; i++) {
            const clone = template.cloneNode(true);
            grid.appendChild(clone);
            
            // --- إعداد مراقبة التعديل اليدوي ---
            
            // 1. مراقبة المرجع (Ref)
            const refEl = clone.querySelector('.ref');
            refEl.setAttribute('contenteditable', 'true');
            refEl.addEventListener('input', function() { 
                this.dataset.manual = 'true'; // منع التحديث العام من تغيير ما كتبته
                updateLabelQR(clone);         // تحديث الـ QR لهذه القصاصة فقط
            });

            // 2. مراقبة العدد (PCS)
            const pcsEl = clone.querySelector('.pcs');
            pcsEl.setAttribute('contenteditable', 'true');
            pcsEl.addEventListener('input', function() { 
                this.dataset.manual = 'true'; 
                updateLabelQR(clone); 
            });

            // 3. مراقبة الأبعاد (Dimensions) - هذا ما طلبته
            const dimEl = clone.querySelector('.dim');
            dimEl.setAttribute('contenteditable', 'true');
            dimEl.addEventListener('input', function() { 
                this.dataset.manual = 'true'; 
                updateLabelQR(clone); // بمجرد تغيير رقم الطول، سيتغير الكود فوراً
            });
            
            // تحديث أولي للقصاصة
            updateLabelQR(clone);
        }
        
        // ... (باقي كود التهيئة الخاص بأزرار الإخفاء والأزرار الجانبية يبقى كما هو) ...
        const hideContainer = document.getElementById('hide-container');
        for (let i = 0; i < 8; i++) {
            const lbl = document.createElement('label');
            lbl.innerHTML = `<input type="checkbox" class="hide-checkbox" data-index="${i}" /> ${i + 1}`;
            hideContainer.appendChild(lbl);
        }
        document.querySelectorAll('.hide-checkbox').forEach(cb => {
            cb.addEventListener('change', function() {
                document.querySelectorAll('#editor-page .label-box')[this.dataset.index].classList.toggle('hidden', this.checked);
            });
        });
        
        document.querySelectorAll('.sidebar-button').forEach(button => {
            attachButtonListeners(button);
        });
        
        refInput.addEventListener('input', () => {
            document.querySelectorAll('.label-box [data-manual]').forEach(el => el.removeAttribute('data-manual'));
            updateLabels();
            updateURLHash();
        });
        
        document.querySelector('.header-text').addEventListener('input', updateURLHash);

        [pcsInput, widthInput, thicknessInput].forEach(el => el.addEventListener('input', updateLabels));
        ['toggleQrCode', 'toggleShapes', 'toggleSameCodeInRow'].forEach(id => document.getElementById(id).addEventListener('change', updateLabels));
        
        // ... (تأكد من بقاء باقي مستمعي الأزرار والطباعة والمودال كما هم في كودك الأصلي) ...
        
        // (أضف بقية المستمعين للأزرار هنا مثل confirmPrintBtn, exportAppBtn ...الخ)
        document.getElementById('confirmPrintBtn').addEventListener('click', () => {
            const pageCount = parseInt(document.getElementById('pageCountInput').value, 10);
            if (pageCount > 0) { hidePrintDialog(); generateAndPrintPages(pageCount); } 
        });
        document.getElementById('cancelPrintBtn').addEventListener('click', hidePrintDialog);
        document.getElementById('addBatchRowBtn').addEventListener('click', ()=>{createBatchRow(); saveBatchData();});
        document.getElementById('addPageBreakBtn').addEventListener('click', ()=>{createPageBreakRow(); saveBatchData();});
        document.getElementById('cancelBatchPrintBtn').addEventListener('click', hideBatchPrintDialog);
        document.getElementById('confirmBatchPrintBtn').addEventListener('click', generateBatchPrintPages);
        
        document.getElementById('addModelBtn').addEventListener('click', () => openModelModal('add'));
        document.getElementById('cancelModelBtn').addEventListener('click', hideModelModal);
        document.getElementById('saveModelBtn').addEventListener('click', saveModel);
        document.getElementById('exportAppBtn').addEventListener('click', exportApplication);

        headerLogoFileInput.addEventListener('change', () => {
            const headerLogo = document.getElementById('headerLogo');
            if (headerLogoFileInput.files && headerLogoFileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) { headerLogo.src = e.target.result; headerLogo.style.display = 'block'; }
                reader.readAsDataURL(headerLogoFileInput.files[0]);
            } else { headerLogo.src = ''; headerLogo.style.display = 'none'; }
        });
        
        // دوال الـ Mobile والـ Resize
        const toggleControlsBtn = document.getElementById('toggle-controls-btn');
        const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');
        const controlsPanel = document.querySelector('.controls');
        const sidebarPanel = document.querySelector('.sidebar');
        const mobileOverlay = document.getElementById('mobile-overlay');
        function closeSidebars() {
            controlsPanel.classList.remove('open');
            sidebarPanel.classList.remove('open');
            mobileOverlay.classList.remove('visible');
        }
        toggleControlsBtn.addEventListener('click', (e) => { e.stopPropagation(); const isOpen = controlsPanel.classList.toggle('open'); if(isOpen) { sidebarPanel.classList.remove('open'); mobileOverlay.classList.add('visible'); } else { mobileOverlay.classList.remove('visible'); } });
        toggleSidebarBtn.addEventListener('click', (e) => { e.stopPropagation(); const isOpen = sidebarPanel.classList.toggle('open'); if(isOpen) { controlsPanel.classList.remove('open'); mobileOverlay.classList.add('visible'); } else { mobileOverlay.classList.remove('visible'); } });
        mobileOverlay.addEventListener('click', closeSidebars);


// --- منطق زر الرجوع ---
    const backBtn = document.getElementById('go-back-btn');
    if (backBtn) {
        backBtn.addEventListener('click', () => {
            // التحقق مما إذا كان هناك صفحات سابقة في السجل
            // ملاحظة: history.length غالباً ما يكون 1 في علامة تبويب جديدة، لذا نتحقق إذا كان أكبر من 1
            if (window.history.length > 1) {
                window.history.back();
            } else {
                console.log("No history to go back to.");
                // اختياري: يمكنك توجيهه للصفحة الرئيسية إذا لم يكن هناك سجل
                // window.location.href = 'index.html'; 
            }
        });
    }






        function scaleA4Page() {
            const a4Container = document.getElementById('a4');
            const a4Viewport = document.querySelector('.a4-viewport');
            if (window.innerWidth <= 1024) {
                const availableWidth = a4Viewport.offsetWidth;
                const a4PixelWidth = 794;
                if (availableWidth < a4PixelWidth) {
                    const scale = availableWidth / a4PixelWidth;
                    a4Container.style.transform = `scale(${scale})`;
                    a4Viewport.style.height = `${a4Container.getBoundingClientRect().height}px`;
                } else { a4Container.style.transform = 'none'; a4Viewport.style.height = 'auto'; }
            } else { a4Container.style.transform = 'none'; a4Viewport.style.height = 'auto'; }
        }
        window.addEventListener('resize', scaleA4Page);
        
        // تشغيل أولي
        updateLabels();
        scaleA4Page();
        loadModelFromURL();
		highlightCurrentPage();
    });
</script>
</body>
</html>