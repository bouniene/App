<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ŸÖÿµŸÖŸÖ ŸÖÿÆÿ∑ÿ∑ÿßÿ™ UML ÿßŸÑÿßÿ≠ÿ™ÿ±ÿßŸÅŸä</title>
    <style>
        :root {
            --primary-color: #2c7be5;
            --header-bg: #1a5c9e;
            --bg-grid: #f4f6f8;
            --border-color: #d1d9e6;
            --node-width: 220px;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: var(--bg-grid);
        }

        /* Print Styles - ÿ™ŸÖ ÿßŸÑÿ™ÿπÿØŸäŸÑ ŸÑÿ•ÿµŸÑÿßÿ≠ ÿßÿÆÿ™ŸÅÿßÿ° ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ */
        @media print {
            @page { size: auto; margin: 5mm; }
            body, html, #workspace-container { 
                width: 100%; 
                height: 100%; 
                overflow: visible !important; 
                position: static !important; 
                background: white !important;
            }
            #toolbar, #zoom-controls, .add-field-btn, .action-icon, .port, .resize-handle, .node-actions {
                display: none !important;
            }
            #workspace {
                transform: scale(1) !important; /* ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ™ŸÉÿ®Ÿäÿ± ÿπŸÜÿØ ÿßŸÑÿ∑ÿ®ÿßÿπÿ© */
                position: static !important;
                width: 100%;
                height: auto;
                overflow: visible !important;
            }
            .node {
                box-shadow: none;
                border: 1px solid #000;
                page-break-inside: avoid;
            }
            svg { 
                z-index: 0; 
                position: absolute; 
                top: 0; 
                left: 0;
                width: 100%;
                height: 100%;
            }
        }

        /* Workspace Wrapper */
        #workspace-container {
            width: 100%;
            height: 100%;
            overflow: auto;
            position: relative;
            background-image: radial-gradient(#dfe3e8 1px, transparent 1px);
            background-size: 20px 20px;
        }

        #workspace {
            transform-origin: 0 0;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* Toolbar */
        #toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: white;
            padding: 0 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            overflow-x: auto;
        }

        #toolbar h3 {
            margin: 0 0 0 20px;
            font-size: 16px;
            color: #2d3748;
            white-space: nowrap;
        }

        .toolbar-group {
            display: flex;
            gap: 8px;
            align-items: center;
            border-left: 1px solid #eee;
            padding-left: 15px;
            flex-shrink: 0;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }

        .btn:hover { background: #1a5c9e; transform: translateY(-1px); }
        .btn.secondary { background: #e2e8f0; color: #2d3748; }
        .btn.secondary:hover { background: #cbd5e0; }
        
        /* Zoom Controls */
        #zoom-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 8px 20px;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
        }
        
        input[type="range"] { width: 150px; cursor: pointer; }

        /* SVG Layer */
        #svg-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: visible;
        }

        path {
            fill: none;
            stroke: #94a3b8;
            stroke-width: 2px;
            pointer-events: auto;
            transition: stroke 0.3s;
            cursor: pointer;
            marker-end: url(#arrowhead); /* Default UML Arrow */
        }
        
        path:hover, path.selected {
            stroke: var(--primary-color);
            stroke-width: 3px;
        }

        /* Nodes (Tables & Shapes) */
        .node {
            position: absolute;
            width: var(--node-width);
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            z-index: 1;
            transition: box-shadow 0.2s, border 0.2s;
        }

        /* Selected State for Deletion */
        .node.selected-node {
            border: 2px solid #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2);
            z-index: 10;
        }

        .node:hover {
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            z-index: 5;
        }

        /* Resize Handle (Top Right) */
        .resize-handle {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 12px;
            height: 12px;
            background: white;
            border: 2px solid #333;
            cursor: nesw-resize; /* Diagonal cursor */
            z-index: 20;
            display: none;
        }
        
        .node:hover .resize-handle, .node.selected-node .resize-handle {
            display: block;
        }

        /* UML Class */
        .node.shape-class {
            border: 1px solid #333;
            border-radius: 0;
        }
        .node.shape-class .node-header {
            background: #fff;
            color: #000;
            border-bottom: 1px solid #333;
            border-radius: 0;
            justify-content: center;
        }
        .node.shape-class .node-title {
            text-align: center;
            font-weight: bold;
        }

        /* Use Case (Oval) */
        .node.shape-usecase {
            border-radius: 50%;
            width: 180px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            border: 2px solid #2c7be5;
        }
        .node.shape-usecase .node-header {
            background: transparent;
            color: #333;
            width: 80%;
            padding: 0;
        }
        .node.shape-usecase .node-body, .node.shape-usecase .add-field-btn { display: none; }

        /* Actor (Stickman) */
        .node.shape-actor {
            background: transparent;
            border: none;
            box-shadow: none;
            width: 80px;
            height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .node.shape-actor .node-header {
            background: transparent;
            color: #333;
            padding: 0;
            text-align: center;
            margin-top: 5px;
        }
        .node.shape-actor .node-body { display: none; }
        .node.shape-actor img { width: 50px; height: auto; pointer-events: none; }

        /* Activity/Start/End */
        .node.shape-activity {
            border-radius: 20px;
            border: 2px solid #2c7be5;
            text-align: center;
            min-height: 60px;
        }
        .node.shape-start, .node.shape-end {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #333;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .node.shape-end {
            border: 4px solid white;
            box-shadow: 0 0 0 2px #333;
        }
        .node.shape-start .node-header, .node.shape-end .node-header { display: none; }

        /* Decision (Diamond) */
        .node.shape-decision {
            width: 100px;
            height: 100px;
            background: transparent;
            border: none;
            box-shadow: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .diamond-inner {
            width: 100%;
            height: 100%;
            background: white;
            border: 2px solid #2c7be5;
            transform: rotate(45deg);
            position: absolute;
            z-index: 0;
        }
        .node.shape-decision .node-header {
            background: transparent;
            color: #333;
            z-index: 1;
            padding: 0;
            width: 100%;
            text-align: center;
            transform: translateY(0);
        }

        /* Original & Note */
        .node.shape-note {
            background: #fff9c4;
            border: 1px solid #fbc02d;
            width: 180px;
            min-height: 150px;
        }
        .node.shape-note .node-header { background: #fbc02d; color: #555; }
        
        /* General Node Header */
        .node-header {
            background: var(--primary-color);
            color: white;
            padding: 10px;
            font-weight: bold;
            cursor: grab;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 7px;
            border-top-right-radius: 7px;
        }

        .node-header:active { cursor: grabbing; }

        .node-title {
            flex-grow: 1;
            outline: none;
            margin-left: 5px;
        }

        .node-actions {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .action-icon {
            cursor: pointer;
            opacity: 0.8;
            font-size: 14px;
            padding: 2px;
            border-radius: 3px;
        }
        .action-icon:hover { opacity: 1; background: rgba(255,255,255,0.2); }

        .color-picker-wrapper {
            position: relative;
            width: 16px;
            height: 16px;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 50%;
            border: 1px solid white;
            font-size: 10px;
            font-weight: bold;
            color: white;
        }
        
        .color-picker-input {
            position: absolute;
            left: -50%;
            top: -50%;
            width: 200%;
            height: 200%;
            cursor: pointer;
            opacity: 0;
        }

        .node-body { padding: 5px 0; min-height: 50px; width: 100%; }

        /* Fields/Attributes Style */
        .field-row {
            padding: 6px 10px;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #f1f1f1;
            font-size: 14px;
            color: #4a5568;
        }
        
        .field-input {
            border: none;
            width: 100%;
            outline: none;
            background: transparent;
        }

        .add-field-btn {
            width: 100%;
            padding: 5px;
            background: #f8fafc;
            border: none;
            border-top: 1px solid #eee;
            color: #718096;
            cursor: pointer;
            font-size: 12px;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }
        .add-field-btn:hover { background: #edf2f7; color: var(--primary-color); }

        /* Separator for Class Diagram */
        .section-separator {
            border-bottom: 1px solid #333;
            margin: 5px 0;
            height: 1px;
            background: #eee;
        }

        /* Connection Ports */
        .port {
            position: absolute;
            width: 12px;
            height: 12px;
            background: white;
            border: 2px solid #94a3b8;
            border-radius: 50%;
            z-index: 10;
            cursor: crosshair;
            transition: all 0.2s;
            opacity: 0; /* Hidden by default for cleaner UML look */
        }
        
        .node:hover .port { opacity: 1; } /* Show on hover */
        .port:hover {
            background: var(--primary-color);
            border-color: var(--primary-color);
            transform: scale(1.2);
            opacity: 1;
        }

        .port-top { top: -6px; left: 50%; transform: translateX(-50%); }
        .port-right { right: -6px; top: 50%; transform: translateY(-50%); }
        .port-bottom { bottom: -6px; left: 50%; transform: translateX(-50%); }
        .port-left { left: -6px; top: 50%; transform: translateY(-50%); }

        .port.active-port {
            background: #e74c3c;
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.3);
            opacity: 1;
        }

    </style>
</head>
<body>

    <div id="toolbar">
        <h3>UML Designer</h3>
        
        <div class="toolbar-group">
            <button class="btn" onclick="addNode('class')">
                <span>‚¨ú</span> Class
            </button>
            <button class="btn secondary" onclick="addNode('table')">
                <span>üìÖ</span> DB Table
            </button>
        </div>

        <div class="toolbar-group">
            <button class="btn secondary" onclick="addNode('usecase')">
                <span>ü•ö</span> Use Case
            </button>
            <button class="btn secondary" onclick="addNode('actor')">
                <span>üë§</span> Actor
            </button>
        </div>

        <div class="toolbar-group">
            <button class="btn secondary" onclick="addNode('activity')">
                <span>üîÑ</span> Activity
            </button>
            <button class="btn secondary" onclick="addNode('decision')">
                <span>‚óá</span> Decision
            </button>
            <button class="btn secondary" onclick="addNode('start')">
                <span>‚óè</span> Start
            </button>
            <button class="btn secondary" onclick="addNode('end')">
                <span>‚¶ø</span> End
            </button>
        </div>

        <div class="toolbar-group">
            <button class="btn secondary" onclick="addNode('note')">
                <span>üìù</span> Note
            </button>
        </div>

        <div class="toolbar-group" style="margin-right: auto;">
            <button class="btn secondary" onclick="deleteSelectedNode()" title="Delete Selected (Del)">
                 <span>‚ùå</span> ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≠ÿØÿØ
            </button>
            <button class="btn secondary" onclick="clearCanvas()">
                <span>üóëÔ∏è</span> ŸÖÿ≥ÿ≠ ÿßŸÑŸÉŸÑ
            </button>
            <button class="btn secondary" onclick="printCanvas()">
                <span>üñ®Ô∏è</span> ÿ∑ÿ®ÿßÿπÿ©
            </button>
        </div>
        
        <div style="font-size: 12px; color: #888; margin-right: 15px;">
            <span id="save-status">ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã</span>
        </div>
    </div>

    <div id="workspace-container" onmousedown="startPan(event)">
        <div id="workspace">
            <svg id="svg-layer">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8" />
                    </marker>
                    <marker id="inheritance" markerWidth="12" markerHeight="12" refX="11" refY="6" orient="auto">
                        <path d="M0,0 L12,6 L0,12 z" fill="white" stroke="#94a3b8" stroke-width="1.5"/>
                    </marker>
                </defs>
            </svg>
            <div id="canvas"></div>
        </div>
    </div>

    <div id="zoom-controls">
        <span style="font-size: 12px; color: #666;">ÿ™ŸÉÿ®Ÿäÿ±/ÿ™ÿµÿ∫Ÿäÿ±</span>
        <button class="btn secondary" style="padding: 2px 8px;" onclick="adjustZoom(-0.1)">-</button>
        <input type="range" id="zoomRange" min="0.5" max="2" step="0.1" value="1" oninput="setZoom(this.value)">
        <button class="btn secondary" style="padding: 2px 8px;" onclick="adjustZoom(0.1)">+</button>
        <span id="zoomValue" style="font-size: 12px; min-width: 40px; text-align: center;">100%</span>
    </div>

    <script>
        let nodeCount = 0;
        let connections = [];
        let currentZoom = 1;
        let isConnecting = false;
        let sourcePort = null;
        let startPortElem = null;
        let selectedNodeId = null;

        const canvas = document.getElementById('canvas');
        const svgLayer = document.getElementById('svg-layer');
        const workspace = document.getElementById('workspace');
        const saveStatus = document.getElementById('save-status');

        // --- Initialization ---
        window.onload = () => {
            loadData();
            
            // Demo data if empty
            if (nodeCount === 0) {
                const classNode = addNode('class', 150, 150, false);
                classNode.querySelector('.node-title').innerText = "User";
                
                const actorNode = addNode('actor', 500, 150, false);
                actorNode.querySelector('.node-title').innerText = "Admin";
                
                saveToLocal();
            }
            updateLines();
        };

        // --- Selection & Keyboard Delete ---
        document.addEventListener('mousedown', (e) => {
            // Deselect if clicking on workspace empty area
            if (e.target.id === 'workspace-container' || e.target.id === 'workspace' || e.target.id === 'canvas' || e.target.tagName === 'svg') {
                deselectNodes();
            }
        });

        document.addEventListener('keydown', (e) => {
            // Check for Delete or Backspace key
            if (e.key === 'Delete' || e.key === 'Backspace') {
                // Ignore if user is typing in an input or editable content
                const active = document.activeElement;
                const isInput = active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.isContentEditable;
                
                if (!isInput && selectedNodeId) {
                    deleteNode(selectedNodeId);
                    e.preventDefault(); // Prevent browser back navigation on Backspace
                }
            }
        });

        function selectNode(id) {
            deselectNodes();
            selectedNodeId = id;
            const node = document.getElementById(id);
            if(node) node.classList.add('selected-node');
        }

        function deselectNodes() {
            if(selectedNodeId) {
                const node = document.getElementById(selectedNodeId);
                if(node) node.classList.remove('selected-node');
            }
            selectedNodeId = null;
        }

        function deleteSelectedNode() {
            if(selectedNodeId) {
                deleteNode(selectedNodeId);
            } else {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ™ÿ≠ÿØŸäÿØ ÿ¥ŸÉŸÑ ÿ£ŸàŸÑÿßŸã ŸÑŸÑÿ≠ÿ∞ŸÅ');
            }
        }

        // --- Node Creation Logic ---
        function addNode(type = 'class', x = 350, y = 150, save = true) {
            nodeCount++;
            const node = document.createElement('div');
            const nodeId = `node-${new Date().getTime()}-${nodeCount}`;
            node.className = `node shape-${type}`;
            node.id = nodeId;
            node.dataset.type = type;
            node.style.left = `${x}px`;
            node.style.top = `${y}px`;

            // Default Color
            let headerColor = '#2c7be5';
            if (type === 'note') headerColor = '#fbc02d';
            
            node.style.setProperty('--primary-color', headerColor);

            // Add selection listener
            node.onmousedown = (e) => {
                if(!e.target.closest('.action-icon') && !e.target.closest('.color-picker-input') && !e.target.closest('.field-input') && !e.target.closest('.resize-handle')) {
                    selectNode(nodeId);
                }
            };

            // Handle Drag Trigger
            const dragTrigger = `onmousedown="startDrag(event, this.closest('.node'))"`;

            let content = '';
            let headerActions = `
                <div class="node-actions">
                    <div class="color-picker-wrapper" title="ŸÑŸàŸÜ ÿßŸÑÿÆŸÑŸÅŸäÿ©">
                        <input type="color" class="color-picker-input" onchange="changeColor(this, '${nodeId}')" value="${headerColor}">
                        <div style="width:100%;height:100%;background:inherit;"></div>
                    </div>
                     <div class="color-picker-wrapper" title="ŸÑŸàŸÜ ÿßŸÑŸÜÿµ" style="background: transparent; border: 1px solid rgba(255,255,255,0.7);">
                        <input type="color" class="color-picker-input" onchange="changeTextColor(this, '${nodeId}')" value="#ffffff">
                        <div style="width:100%;height:100%; display:flex; align-items:center; justify-content:center;">T</div>
                    </div>
                    <span class="action-icon" onclick="deleteNode('${nodeId}')">‚úñ</span>
                </div>`;
            
            // Standard Editable Header
            const standardHeader = (title) => `
                <div class="node-header" style="background-color: ${headerColor}" ${dragTrigger}>
                    <span class="node-title" contenteditable="true" spellcheck="false" oninput="saveToLocal()">${title}</span>
                    ${headerActions}
                </div>`;

            // Shape Specific HTML
            if (type === 'class' || type === 'table') {
                content = `
                    ${standardHeader(type === 'class' ? 'ClassName' : 'TableName')}
                    <div class="node-body">
                        <div class="field-row"><input class="field-input" value="${type === 'class' ? '- id: int' : 'id: int (PK)'}" oninput="saveToLocal()"></div>
                    </div>
                    <button class="add-field-btn" onclick="addField(this, 'attribute')">+ ${type === 'class' ? 'Attribute' : 'Field'}</button>
                    ${type === 'class' ? `
                        <div class="section-separator"></div>
                        <div class="node-body methods-body">
                             <div class="field-row"><input class="field-input" value="+ save(): void" oninput="saveToLocal()"></div>
                        </div>
                        <button class="add-field-btn" onclick="addField(this, 'method')">+ Method</button>
                    ` : ''}
                `;
            } else if (type === 'usecase') {
                content = `
                    <div class="node-header" ${dragTrigger}>
                        <span class="node-title" contenteditable="true" spellcheck="false" oninput="saveToLocal()">Use Case</span>
                        ${headerActions}
                    </div>
                `;
            } else if (type === 'actor') {
                content = `
                    <div ${dragTrigger} style="cursor: grab;">
                        <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="7" r="4"></circle>
                            <path d="M12 11v12M8 15h8M8 23h8"></path>
                        </svg>
                    </div>
                    <div class="node-header" style="background:transparent; color:#000;">
                        <span class="node-title" contenteditable="true" spellcheck="false" oninput="saveToLocal()">Actor</span>
                         ${headerActions}
                    </div>
                `;
            } else if (type === 'activity') {
                 content = `
                    ${standardHeader('Activity Name')}
                    <div class="node-body" contenteditable="true" oninput="saveToLocal()" style="padding:10px;">Description</div>
                `;
            } else if (type === 'decision') {
                content = `
                    <div class="diamond-inner"></div>
                    <div class="node-header" ${dragTrigger}>
                        <span class="node-title" contenteditable="true" spellcheck="false" oninput="saveToLocal()">?</span>
                         ${headerActions}
                    </div>
                `;
            } else if (type === 'note') {
                content = `
                    ${standardHeader('Note')}
                    <div class="node-body" contenteditable="true" oninput="saveToLocal()" style="padding:10px; min-height:100px;">Write here...</div>
                `;
            } else if (type === 'start' || type === 'end') {
                content = `<div ${dragTrigger} style="width:100%;height:100%; border-radius:50%; display:flex; justify-content:center; align-items:center; color:white; cursor:grab;"></div>`;
                 content += `<div style="position:absolute; top:-10px; right:-10px; background:white; border-radius:50%; width:15px; height:15px; font-size:10px; text-align:center; cursor:pointer; border:1px solid #ccc; color:red;" onclick="deleteNode('${nodeId}')">x</div>`;
            }

            // Ports and Resize Handle
            node.innerHTML = `
                <div class="resize-handle" onmousedown="startResize(event, '${nodeId}')"></div>
                <div class="port port-top" onmousedown="startConnection(event, '${nodeId}', 'top')"></div>
                <div class="port port-right" onmousedown="startConnection(event, '${nodeId}', 'right')"></div>
                <div class="port port-bottom" onmousedown="startConnection(event, '${nodeId}', 'bottom')"></div>
                <div class="port port-left" onmousedown="startConnection(event, '${nodeId}', 'left')"></div>
                ${content}
            `;

            canvas.appendChild(node);
            if (save) saveToLocal();
            return node;
        }

        function addField(btn, type) {
            const body = btn.previousElementSibling;
            let val = "new_field";
            if(type === 'method') val = "+ method(): void";
            else if(type === 'attribute') val = "- attribute: type";
            
            addFieldToNode(body, val);
            saveToLocal();
        }

        function addFieldToNode(container, text) {
            const row = document.createElement('div');
            row.className = 'field-row';
            row.innerHTML = `<input class="field-input" value="${text}" oninput="saveToLocal()"><span style="cursor:pointer;color:#e53e3e;" onclick="this.parentNode.remove(); saveToLocal()">√ó</span>`;
            container.appendChild(row);
        }

        function deleteNode(id) {
            // No confirmation needed for delete key usually, but let's keep it safe or remove confirm for better UX as requested by "keypress"
            if(confirm('ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿπŸÜÿµÿ±ÿü')) {
                const node = document.getElementById(id);
                connections = connections.filter(conn => {
                    if (conn.from === id || conn.to === id) {
                        conn.path.remove();
                        return false;
                    }
                    return true;
                });
                node.remove();
                if(selectedNodeId === id) selectedNodeId = null;
                saveToLocal();
            }
        }

        function changeColor(input, nodeId) {
            const node = document.getElementById(nodeId);
            const color = input.value;
            node.style.setProperty('--primary-color', color);
            const header = node.querySelector('.node-header');
            if (header && !node.classList.contains('shape-actor') && !node.classList.contains('shape-usecase') && !node.classList.contains('shape-decision') && !node.classList.contains('shape-class')) {
                header.style.backgroundColor = color;
            }
            saveToLocal();
        }

        function changeTextColor(input, nodeId) {
            const node = document.getElementById(nodeId);
            const color = input.value;
            const header = node.querySelector('.node-header');
            if (header) {
                header.style.color = color;
                // Try to find the title inside
                const title = header.querySelector('.node-title');
                if(title) title.style.color = color;
            }
            saveToLocal();
        }

        // --- Resize Logic (Top Right) ---
        let resizingNode = null;
        let resizeStart = { x: 0, y: 0, w: 0, h: 0, top: 0 };

        function startResize(e, nodeId) {
            e.stopPropagation();
            e.preventDefault();
            resizingNode = document.getElementById(nodeId);
            resizeStart.x = e.clientX;
            resizeStart.y = e.clientY;
            resizeStart.w = resizingNode.offsetWidth;
            resizeStart.h = resizingNode.offsetHeight;
            resizeStart.top = resizingNode.offsetTop;
            
            document.addEventListener('mousemove', doResize);
            document.addEventListener('mouseup', stopResize);
        }

        function doResize(e) {
            if (!resizingNode) return;
            
            const dx = (e.clientX - resizeStart.x) / currentZoom;
            const dy = (e.clientY - resizeStart.y) / currentZoom;

            // Top Right Resize:
            // Width increases with dx
            // Height increases with -dy (since we pull UP to increase size at the top)
            // Top position moves with dy
            
            const newWidth = Math.max(100, resizeStart.w + dx); // Min width 100
            const newHeight = Math.max(60, resizeStart.h - dy); // Min height 60
            
            // Only update top if height changed effectively (above min height)
            if (resizeStart.h - dy > 60) {
                 resizingNode.style.top = (resizeStart.top + dy) + 'px';
            }

            resizingNode.style.width = newWidth + 'px';
            resizingNode.style.height = newHeight + 'px'; // Enforce height
            
            updateLines();
        }

        function stopResize() {
            if(resizingNode) saveToLocal();
            resizingNode = null;
            document.removeEventListener('mousemove', doResize);
            document.removeEventListener('mouseup', stopResize);
        }

        // --- Dragging Logic ---
        let draggedNode = null;
        let dragStartPos = { x: 0, y: 0 };
        let nodeStartPos = { x: 0, y: 0 };

        function startDrag(e, node) {
            if(e.target.closest('.resize-handle')) return; // Don't drag if resizing
            e.stopPropagation();
            draggedNode = node;
            selectNode(node.id); // Select on drag start
            dragStartPos.x = e.clientX;
            dragStartPos.y = e.clientY;
            nodeStartPos.x = parseInt(node.style.left || 0);
            nodeStartPos.y = parseInt(node.style.top || 0);
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', stopDrag);
        }

        function onDrag(e) {
            if (!draggedNode) return;
            const deltaX = (e.clientX - dragStartPos.x) / currentZoom;
            const deltaY = (e.clientY - dragStartPos.y) / currentZoom;
            draggedNode.style.left = (nodeStartPos.x + deltaX) + 'px';
            draggedNode.style.top = (nodeStartPos.y + deltaY) + 'px';
            updateLines();
        }

        function stopDrag() {
            if (draggedNode) saveToLocal();
            draggedNode = null;
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', stopDrag);
        }

        // --- Panning ---
        let isPanning = false;
        let panStart = { x: 0, y: 0 };
        let scrollStart = { x: 0, y: 0 };

        function startPan(e) {
            if (e.target.closest('.node') || e.target.closest('.port')) return;
            isPanning = true;
            panStart.x = e.clientX;
            panStart.y = e.clientY;
            scrollStart.x = document.getElementById('workspace-container').scrollLeft;
            scrollStart.y = document.getElementById('workspace-container').scrollTop;
            document.getElementById('workspace-container').style.cursor = 'grabbing';
            document.addEventListener('mousemove', onPan);
            document.addEventListener('mouseup', stopPan);
        }

        function onPan(e) {
            if (!isPanning) return;
            const dx = e.clientX - panStart.x;
            const dy = e.clientY - panStart.y;
            document.getElementById('workspace-container').scrollLeft = scrollStart.x - dx;
            document.getElementById('workspace-container').scrollTop = scrollStart.y - dy;
        }

        function stopPan() {
            isPanning = false;
            document.getElementById('workspace-container').style.cursor = 'default';
            document.removeEventListener('mousemove', onPan);
            document.removeEventListener('mouseup', stopPan);
        }

        // --- Connections ---
        function startConnection(e, nodeId, portSide) {
            e.stopPropagation();
            isConnecting = true;
            sourcePort = { nodeId, side: portSide };
            startPortElem = e.target;
            startPortElem.classList.add('active-port');
            
            // Temporary line
            const tempLine = document.createElementNS("http://www.w3.org/2000/svg", "path");
            tempLine.setAttribute("id", "temp-line");
            tempLine.setAttribute("stroke", "#2c7be5");
            tempLine.setAttribute("stroke-width", "2");
            tempLine.setAttribute("stroke-dasharray", "5,5");
            svgLayer.appendChild(tempLine);

            document.addEventListener('mousemove', drawTempLine);
            document.addEventListener('mouseup', endConnection);
        }

        function drawTempLine(e) {
            if (!isConnecting) return;
            const tempLine = document.getElementById("temp-line");
            const startRect = startPortElem.getBoundingClientRect();
            const workspaceRect = workspace.getBoundingClientRect();
            const x1 = (startRect.left + startRect.width / 2 - workspaceRect.left) / currentZoom;
            const y1 = (startRect.top + startRect.height / 2 - workspaceRect.top) / currentZoom;
            const x2 = (e.clientX - workspaceRect.left) / currentZoom;
            const y2 = (e.clientY - workspaceRect.top) / currentZoom;
            tempLine.setAttribute("d", `M ${x1} ${y1} L ${x2} ${y2}`);
        }

        function endConnection(e) {
            isConnecting = false;
            document.removeEventListener('mousemove', drawTempLine);
            document.removeEventListener('mouseup', endConnection);
            const tempLine = document.getElementById("temp-line");
            if (tempLine) tempLine.remove();
            if (startPortElem) startPortElem.classList.remove('active-port');

            const targetPort = e.target;
            if (targetPort.classList.contains('port')) {
                const targetNodeId = targetPort.parentNode.id;
                if (sourcePort.nodeId !== targetNodeId) {
                    createConnectionObj(sourcePort.nodeId, targetNodeId);
                    saveToLocal();
                }
            }
        }

        function createConnectionObj(id1, id2) {
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            svgLayer.appendChild(path);
            path.addEventListener('dblclick', function() {
                if(confirm('ÿ≠ÿ∞ŸÅ ÿßŸÑÿ±ÿßÿ®ÿ∑ÿü')) {
                    this.remove();
                    connections = connections.filter(c => c.path !== this);
                    saveToLocal();
                }
            });
            connections.push({ from: id1, to: id2, path: path });
            updateLines();
        }

        function updateLines() {
            connections.forEach(conn => {
                const nodeA = document.getElementById(conn.from);
                const nodeB = document.getElementById(conn.to);
                if (!nodeA || !nodeB) return;

                const rectA = nodeA.getBoundingClientRect();
                const rectB = nodeB.getBoundingClientRect();
                const workspaceRect = workspace.getBoundingClientRect();

                const x1 = (rectA.left + rectA.width / 2 - workspaceRect.left) / currentZoom;
                const y1 = (rectA.top + rectA.height / 2 - workspaceRect.top) / currentZoom;
                const x2 = (rectB.left + rectB.width / 2 - workspaceRect.left) / currentZoom;
                const y2 = (rectB.top + rectB.height / 2 - workspaceRect.top) / currentZoom;

                // Bezier
                const dx = Math.abs(x1 - x2);
                const dy = Math.abs(y1 - y2);
                let d = "";
                if (dx > dy) {
                    const c1x = x1 + (x2 - x1) / 2;
                    d = `M ${x1} ${y1} C ${c1x} ${y1}, ${c1x} ${y2}, ${x2} ${y2}`;
                } else {
                    const c1y = y1 + (y2 - y1) / 2;
                    d = `M ${x1} ${y1} C ${x1} ${c1y}, ${x2} ${c1y}, ${x2} ${y2}`;
                }
                
                conn.path.setAttribute("d", d);
            });
        }

        // --- Zooming & Helpers ---
        function setZoom(val) {
            currentZoom = parseFloat(val);
            document.getElementById('zoomRange').value = currentZoom;
            document.getElementById('zoomValue').innerText = Math.round(currentZoom * 100) + '%';
            workspace.style.transform = `scale(${currentZoom})`;
        }

        function adjustZoom(delta) {
            let newZoom = currentZoom + delta;
            if (newZoom < 0.5) newZoom = 0.5;
            if (newZoom > 2) newZoom = 2;
            setZoom(newZoom);
        }

        function clearCanvas() {
            if(confirm("ŸáŸÑ ÿ™ÿ±ŸäÿØ ŸÖÿ≥ÿ≠ ŸÉŸÑ ÿ¥Ÿäÿ°ÿü")) {
                canvas.innerHTML = '';
                // Keep defs
                const defs = svgLayer.querySelector('defs').outerHTML;
                svgLayer.innerHTML = defs;
                connections = [];
                nodeCount = 0;
                localStorage.removeItem('dbDesignerData');
            }
        }
        
        function printCanvas() { window.print(); }

        // --- Storage ---
        function saveToLocal() {
            const nodes = [];
            document.querySelectorAll('.node').forEach(n => {
                const title = n.querySelector('.node-title') ? n.querySelector('.node-title').innerText : '';
                const color = n.style.getPropertyValue('--primary-color');
                const headerColor = n.querySelector('.node-header') ? n.querySelector('.node-header').style.color : '';
                const type = n.dataset.type;
                const w = n.style.width;
                const h = n.style.height;
                
                const inputs = [];
                n.querySelectorAll('input.field-input').forEach(inp => inputs.push(inp.value));
                
                let bodyContent = '';
                const bodyDiv = n.querySelector('.node-body');
                if (bodyDiv && type !== 'class' && type !== 'table') {
                    bodyContent = bodyDiv.innerText;
                }

                nodes.push({
                    id: n.id,
                    left: n.style.left,
                    top: n.style.top,
                    width: w,
                    height: h,
                    title: title,
                    color: color,
                    headerColor: headerColor,
                    inputs: inputs,
                    type: type,
                    bodyContent: bodyContent
                });
            });

            const connData = connections.map(c => ({ from: c.from, to: c.to }));
            localStorage.setItem('dbDesignerData', JSON.stringify({ nodes, connections: connData, nodeCount }));
            
            saveStatus.innerText = "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏...";
            setTimeout(() => saveStatus.innerText = "ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã", 1000);
        }

        function loadData() {
            const dataStr = localStorage.getItem('dbDesignerData');
            if (!dataStr) return;

            const data = JSON.parse(dataStr);
            nodeCount = data.nodeCount || 0;

            data.nodes.forEach(n => {
                const node = addNode(n.type, parseInt(n.left), parseInt(n.top), false);
                node.id = n.id;
                
                // Restore Size
                if(n.width) node.style.width = n.width;
                if(n.height) node.style.height = n.height;

                const titleElem = node.querySelector('.node-title');
                if (titleElem) titleElem.innerText = n.title;
                
                node.style.setProperty('--primary-color', n.color);
                
                // Restore Colors
                const header = node.querySelector('.node-header');
                if (header) {
                     if(!['actor', 'usecase', 'decision', 'class'].includes(n.type)) {
                        header.style.backgroundColor = n.color;
                     }
                     if(n.headerColor) {
                         header.style.color = n.headerColor;
                         if(titleElem) titleElem.style.color = n.headerColor;
                     }
                }
                const picker = node.querySelector('.color-picker-input');
                if (picker) picker.value = n.color;

                // Restore Content
                if (n.type === 'class' || n.type === 'table') {
                    const bodies = node.querySelectorAll('.node-body');
                    bodies.forEach(b => b.innerHTML = '');
                    
                    const mainBody = node.querySelector('.node-body'); 
                    const methodsBody = node.querySelector('.methods-body');
                    
                    n.inputs.forEach(val => {
                        if (val.includes('(') && methodsBody) {
                             addFieldToNode(methodsBody, val);
                        } else {
                             addFieldToNode(mainBody, val);
                        }
                    });
                } else {
                    const body = node.querySelector('.node-body');
                    if (body) body.innerText = n.bodyContent;
                }
            });

            data.connections.forEach(c => createConnectionObj(c.from, c.to));
        }

    </script>
</body>
</html>