<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sample Management System</title>
    <meta name="theme-color" content="#674ea7"/>
    <link rel="manifest" id="manifest-placeholder">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.css" rel="stylesheet">


    <style>
        /* --- Odoo Theme & Core Styles --- */
        :root {
            --bs-primary-rgb: 103, 78, 167; /* Odoo-like Purple */
            --bs-secondary-rgb: 233, 236, 239; /* Light Gray */
            --bs-body-font-family: 'Inter', 'Cairo', sans-serif;
            --bs-body-bg: #f8f9fa;
            --bs-card-bg: #ffffff;
            --bs-card-border-color: #dee2e6;
            --bs-border-radius: 0.25rem;
            --bs-box-shadow-sm: 0 .125rem .25rem rgba(0,0,0,.075);
            --bs-box-shadow: 0 .5rem 1rem rgba(0,0,0,.15);
        }

        body {
            font-family: var(--bs-body-font-family);
            background-color: var(--bs-body-bg);
        }

        /* --- App Layout --- */
        .app-container { padding: 1rem 1.5rem; }
        .control-panel {
            display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between;
            padding: 0.75rem; background-color: var(--bs-body-bg); border-bottom: 1px solid var(--bs-card-border-color);
            gap: 1rem; margin-bottom: 1rem;
        }
        .control-panel-left, .control-panel-right { display: flex; align-items: center; gap: 0.75rem; }
        .search-container { flex-grow: 1; min-width: 250px; max-width: 450px; position: relative; }
        .view-switcher .btn.active { background-color: rgb(var(--bs-primary-rgb)); color: white; border-color: rgb(var(--bs-primary-rgb)); }
        .main-content { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Save Status Indicator --- */
        #save-status-indicator { display: flex; align-items: center; gap: 0.5rem; transition: opacity 0.3s; }
        
        /* --- Kanban View --- */
        #kanban-view-content {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 0.75rem;
        }
        .kanban-card {
            background-color: var(--bs-card-bg); border: 1px solid var(--bs-card-border-color); border-radius: var(--bs-border-radius);
            box-shadow: var(--bs-box-shadow-sm); transition: transform 0.2s ease, box-shadow 0.2s ease; cursor: pointer;
            display: flex; flex-direction: column; padding: 0.5rem;
        }
        .kanban-card:hover { transform: translateY(-4px); box-shadow: var(--bs-box-shadow); }
        .kanban-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.4rem; }
        .kanban-card-title { font-weight: 700; font-size: 0.9rem; color: #333; }
        .kanban-card-body { font-size: 0.75rem; color: #555; margin-bottom: 0.5rem; flex-grow: 1; }
        .kanban-card-body p { margin-bottom: 0.2rem; }
        .kanban-card-footer { margin-top: auto; display: flex; justify-content: flex-end; align-items: center; font-size: 0.7rem; color: #6c757d;}
        .kanban-image-container { position: relative; width: 40px; height: 40px; flex-shrink: 0; margin-left: 0.5rem; }
        .kanban-image-container img { 
            width: 100%; height: 100%; object-fit: cover; border-radius: var(--bs-border-radius);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .kanban-image-container:hover img {
            transform: scale(2.5);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10;
        }
        .component-tag {
            background-color: #dc3545;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: 600;
        }
        .component-tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 4px;
        }

        /* --- List View & Foil View --- */
        .dataTables_wrapper {
            font-size: 14px;
        }
        .table-view-container .table { background-color: var(--bs-card-bg); box-shadow: var(--bs-box-shadow-sm); border-radius: var(--bs-border-radius); width: 100% !important; }
        .table-view-container { 
            border-radius: var(--bs-border-radius);
        }
        .table-view-container .table thead { background-color: #f1f3f5; }
        .table-view-container .table th, .table-view-container .table td { font-weight: 600; padding: 0.75rem; vertical-align: middle;}
        .table-view-container .table-hover tbody tr:hover { background-color: rgba(var(--bs-primary-rgb), 0.07); cursor: pointer; }
        .list-view-row img {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            position: relative;
        }
        .list-view-row img:hover {
            transform: scale(3.5);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10;
        }
        
        /* --- Reports View (Accordion Style) --- */
        .accordion-button { font-weight: 600; }
        .accordion-button:not(.collapsed) { background-color: rgba(var(--bs-primary-rgb), 0.1); color: rgb(var(--bs-primary-rgb)); }
        
        /* --- Search Tags & Autocomplete --- */
        .search-tags-container { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .search-tag { display: inline-flex; align-items: center; background-color: rgb(var(--bs-primary-rgb), 0.2); color: rgb(var(--bs-primary-rgb)); border: 1px solid rgb(var(--bs-primary-rgb), 0.4); padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.85rem; font-weight: 600; }
        .search-tag .btn-close { margin-left: 0.5rem; margin-right: -0.25rem; }
        
        /* --- Advanced Search Dropdown --- */
        .advanced-search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1055;
            background-color: #fff;
            border: 1px solid var(--bs-card-border-color);
            border-top: none;
            box-shadow: var(--bs-box-shadow);
            border-radius: 0 0 var(--bs-border-radius) var(--bs-border-radius);
            padding: 0.75rem;
            max-height: 300px;
            overflow-y: auto;
        }
        .search-dropdown-section { margin-bottom: 1rem; }
        .search-dropdown-header {
            font-weight: 700;
            color: #495057;
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #f1f3f5;
            font-size: 0.9rem;
        }
        .search-dropdown-item {
            padding: 0rem 0.1rem;
            cursor: pointer;
            border-radius: var(--bs-border-radius);
            display: flex;
            align-items: center;
            font-size: 13px; 
        }
        .search-dropdown-item:hover { background-color: #e9ecef; }
        .search-dropdown-item i { margin-right: 0.5rem; }
        .search-dropdown-item .text-muted { margin-left: auto; font-size: 0.8em; }

        
        /* --- Modals & General --- */
        .modal-header { background-color: #f8f9fa; border-bottom: 1px solid #dee2e6; color: #495057; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(4px); }
        #image-drop-zone { border: 2px dashed #ccc; border-radius: var(--bs-border-radius); padding: 2rem; text-align: center; color: #6c757d; transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out; }
        #image-drop-zone.dragover { background-color: #e9ecef; border-color: rgb(var(--bs-primary-rgb)); }
        #image-drop-zone p { margin: 0; }
        #sample-image-preview { border: 1px solid var(--bs-card-border-color); object-fit: cover; }
        
        /* --- Visual Progress Bar --- */
        .component-bar-container { margin-top: 1rem; border-top: 1px solid #eee; padding-top: 1rem; }
        .component-bar-title { font-weight: 700; font-size: 1rem; }
        .visual-bar-container { 
            height: 25px; 
            background-color: #e9ecef; 
            border-radius: 5px; 
            overflow: hidden; 
            border: 1px solid #dee2e6;
        }
        .visual-bar-content { 
            display: flex; 
            height: 100%; 
            width: 100%; 
        }
        .visual-bar-segment { 
            height: 100%; 
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
        }
        .component-bar-image {
            width: 32px;
            height: 32px;
            object-fit: cover;
            border-radius: var(--bs-border-radius);
            border: 1px solid #ddd;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .component-bar-image:hover {
            transform: scale(4.5);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 20;
            position: relative;
        }

        /* --- Camera Modal Styles --- */
        #camera-modal .modal-body { padding: 0; }
        #camera-stream { width: 100%; height: auto; display: block; background-color: #000; }
        #camera-snap-preview { width: 100%; height: auto; display: block; }
        
        /* --- Annotation Modal Styles --- */
        #foil-tray {
            border: 1px solid #dee2e6;
            min-height: 50px;
        }
        .foil-label {
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            cursor: grab;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: var(--bs-box-shadow-sm);
            user-select: none;
        }
        .foil-label:active {
            cursor: grabbing;
            background-color: #e9ecef;
        }
        .foil-name {
            font-weight: 600;
            font-size: 0.8rem;
        }
        .foil-handle {
            width: 10px;
            height: 10px;
            background-color: rgb(var(--bs-primary-rgb));
            border-radius: 50%;
            margin-top: 4px;
            cursor: crosshair;
            border: 2px solid white;
            box-shadow: 0 0 0 1px rgb(var(--bs-primary-rgb));
        }
        #annotation-canvas {
            max-width: 100%;
            max-height: 70vh;
            cursor: crosshair;
        }

        /* --- Print Styles --- */
        @media print {
            body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0 !important; padding: 0 !important; }
            .no-print { display: none !important; }
            .card, .table, .accordion-item { box-shadow: none !important; border: 1px solid #ccc !important; }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading-overlay" style="display: none;">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"><span class="visually-hidden">Loading...</span></div>
    </div>

    <div class="app-container">
        <header class="d-flex justify-content-between align-items-center pb-2 mb-3 border-bottom no-print">
            <h1 class="h4 m-0 fw-bold d-flex align-items-center">
                <i class="bi bi-box-seam text-primary me-2"></i> Sample Management System
            </h1>
            <div class="form-check form-switch ms-2" title="Show Archived">
                <input class="form-check-input" type="checkbox" role="switch" id="show-archived-toggle">
                <label class="form-check-label" for="show-archived-toggle"><i class="bi bi-archive-fill"></i></label>
            </div>
        </header>

        <div class="control-panel no-print">
            <div class="control-panel-left">
                <button id="create-btn" class="btn btn-primary"><i class="bi bi-plus-circle me-1"></i> Create</button>
                </div>
            
            <div id="view-specific-search-container" class="search-container"></div>

            <div class="control-panel-right">
                <div id="save-status-indicator" style="display: none;"></div>
                <div class="btn-group view-switcher">
                    <button class="btn btn-outline-secondary active" id="kanban-view-btn" title="Kanban View"><i class="bi bi-grid-3x3-gap-fill"></i></button>
                    <button class="btn btn-outline-secondary" id="list-view-btn" title="List View"><i class="bi bi-list-ul"></i></button>
                    <button class="btn btn-outline-secondary" id="foil-view-btn" title="Foil View"><i class="bi bi-layers-fill"></i></button>
                    <button class="btn btn-outline-secondary" id="reports-view-btn" title="Reports View"><i class="bi bi-journal-text"></i></button>
                </div>
                <button id="print-summary-btn" class="btn btn-outline-secondary" title="Print"><i class="bi bi-printer-fill"></i></button>
            </div>
        </div>
        
        <div id="search-tags-container" class="search-tags-container mb-3 no-print"></div>

        <main id="main-content" class="print-area"></main>
    </div>

    <div class="modal fade" id="sample-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="sample-form">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modal-title"></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="sample-edit-id">
                        <div class="text-center mb-3">
                            <img src="" id="sample-image-preview" class="img-fluid rounded d-none" alt="Image Preview" style="max-height: 150px;">
                        </div>
                        <div class="mb-3">
                            <label for="sample-name" class="form-label">Sample Name</label>
                            <input type="text" id="sample-name" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="sample-category" class="form-label">Category</label>
                            <input type="text" id="sample-category" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="sample-location" class="form-label">Location</label>
                            <input type="text" id="sample-location" class="form-control">
                        </div>
                        
                        <div class="mb-3">
                            <label for="sample-components" class="form-label">Foil Components (Optional)</label>
                            <select id="sample-components" multiple placeholder="Choose components..."></select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="sample-description" class="form-label">Description (Optional)</label>
                            <textarea id="sample-description" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="sample-entry-date" class="form-label">Entry Date (Optional)</label>
                            <input type="date" id="sample-entry-date" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Sample Image (Optional)</label>
                            <div id="image-drop-zone"><p>Drag & drop an image here, or click to select a file.</p></div>
                            <input type="file" id="sample-image" class="form-control" accept="image/*" hidden>
                            <button type="button" id="open-camera-btn" class="btn btn-outline-primary w-100 mt-2">
                                <i class="bi bi-camera-fill me-1"></i> Capture with Camera
                            </button>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="details-modal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="details-modal-title"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="details-modal-body"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmation-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Action</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="confirmation-modal-body"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmation-modal-confirm-btn">Confirm</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="camera-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Capture Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <p id="camera-permission-message">Waiting for camera permission...</p>
                    <video id="camera-stream" autoplay playsinline style="display:none;"></video>
                    <img id="camera-snap-preview" alt="Image Preview" style="display:none;" />
                    <canvas id="camera-canvas" style="display:none;"></canvas>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="snap-photo-btn" style="display:none;"><i class="bi bi-camera"></i> Snap</button>
                    <button type="button" class="btn btn-success" id="use-photo-btn" style="display:none;"><i class="bi bi-check-lg"></i> Use Photo</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="annotation-modal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Annotate Components</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="foil-tray" class="mb-3 p-2 bg-light rounded d-flex flex-wrap gap-2">
                        </div>
                    <div class="text-center position-relative">
                        <canvas id="annotation-canvas" class="border bg-secondary-subtle"></canvas>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-annotations-btn">Save Annotations</button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed top-0 end-0 p-3 z-3"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.js"></script>
    
    <script>
    // --- PWA & Offline Setup ---
    (function() {
        const manifest = {
            "name": "Sample Management",
            "short_name": "SampleMgr",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#f8f9fa",
            "theme_color": "#674ea7",
            "description": "A system to manage samples.",
            "icons": [{ "src": "https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/icons/box-seam.svg", "sizes": "any", "type": "image/svg+xml" }]
        };
        const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(blob);
        document.querySelector('#manifest-placeholder').setAttribute('href', manifestURL);

        if ('serviceWorker' in navigator) {
            const swContent = `
                const CACHE_NAME = 'sample-manager-cache-v1';
                const urlsToCache = [ '/', 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css', 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css', 'https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Cairo:wght@400;600;700&display=swap', 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js', 'https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js', 'https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js', 'https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.css' ];
                self.addEventListener('install', event => { event.waitUntil( caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache)) ); });
                self.addEventListener('fetch', event => { event.respondWith( caches.match(event.request).then(response => response || fetch(event.request)) ); });
            `;
            const swBlob = new Blob([swContent], {type: 'application/javascript'});
            const swURL = URL.createObjectURL(swBlob);
            window.addEventListener('load', () => { navigator.serviceWorker.register(swURL).then(reg => console.log('ServiceWorker registered.')).catch(err => console.error('ServiceWorker registration failed:', err)); });
        }
    })();
    
    document.addEventListener('DOMContentLoaded', () => {

        const LocalDB = {
            db: null,
            DB_NAME: 'SampleManagerDB',
            DB_VERSION: 2, 

            init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.DB_NAME, this.DB_VERSION);
                    request.onupgradeneeded = event => {
                        this.db = event.target.result;
                        if (!this.db.objectStoreNames.contains('samples')) {
                            this.db.createObjectStore('samples', { keyPath: 'docId' });
                        }
                        if (!this.db.objectStoreNames.contains('logs')) {
                            this.db.createObjectStore('logs', { keyPath: 'id' });
                        }
                        if (!this.db.objectStoreNames.contains('foils')) {
                            this.db.createObjectStore('foils', { keyPath: 'docId' });
                        }
                    };
                    request.onsuccess = event => { this.db = event.target.result; resolve(); };
                    request.onerror = event => { console.error('IndexedDB error:', event.target.error); reject(event.target.error); };
                });
            },
            async saveData(data) {
                if (!this.db) await this.init();
                const tx = this.db.transaction(['samples', 'logs', 'foils'], 'readwrite');
                tx.objectStore('samples').clear();
                tx.objectStore('logs').clear();
                tx.objectStore('foils').clear();
                data.samples.forEach(sample => tx.objectStore('samples').put(sample));
                data.logs.forEach(log => tx.objectStore('logs').put(log));
                data.foils.forEach(foil => tx.objectStore('foils').put(foil));
                return new Promise((resolve, reject) => {
                    tx.oncomplete = () => resolve();
                    tx.onerror = event => reject(tx.error);
                });
            },
            async getData() {
                if (!this.db) await this.init();
                const tx = this.db.transaction(['samples', 'logs', 'foils'], 'readonly');
                const samples = await new Promise(res => { const req = tx.objectStore('samples').getAll(); req.onsuccess = () => res(req.result); });
                const logs = await new Promise(res => { const req = tx.objectStore('logs').getAll(); req.onsuccess = () => res(req.result); });
                const foils = await new Promise(res => { const req = tx.objectStore('foils').getAll(); req.onsuccess = () => res(req.result); });
                return { samples: samples || [], logs: logs || [], foils: foils || [] };
            }
        };

        const SampleManagerApp = {
            state: {
                samples: [],
                logs: [],
                foils: [],
                currentView: 'kanban',
                isSaving: false,
                retryTimerId: null,
                fuse: null,
                foilFuse: null,
                searchTerms: { kanban: [], list: [], reports: [], foil: [] },
                showArchived: false,
                hasSuccessfullyLoadedOnce: false,
                cameraStream: null,
                componentsSelect: null,
                categorySelect: null, // MODIFICATION: Added to manage the category Tom-Select instance
                listViewHolder: null, 
            },
            elements: {
                mainContent: document.getElementById('main-content'),
                viewSwitcher: {
                    kanban: document.getElementById('kanban-view-btn'),
                    list: document.getElementById('list-view-btn'),
                    foil: document.getElementById('foil-view-btn'),
                    reports: document.getElementById('reports-view-btn'),
                },
                createBtn: document.getElementById('create-btn'),
                printBtn: document.getElementById('print-summary-btn'),
                searchContainer: document.getElementById('view-specific-search-container'),
                searchTagsContainer: document.getElementById('search-tags-container'),
                showArchivedToggle: document.getElementById('show-archived-toggle'),
                sampleModal: new bootstrap.Modal(document.getElementById('sample-modal')),
                detailsModal: new bootstrap.Modal(document.getElementById('details-modal')),
                detailsModalBody: document.getElementById('details-modal-body'),
                detailsModalTitle: document.getElementById('details-modal-title'),
                confirmationModal: new bootstrap.Modal(document.getElementById('confirmation-modal')),
                loadingOverlay: document.getElementById('loading-overlay'),
                saveStatusIndicator: document.getElementById('save-status-indicator'),
                cameraModal: new bootstrap.Modal(document.getElementById('camera-modal')),
            },

            GoogleAppsScriptPersistence: {
                URL: 'https://script.google.com/macros/s/AKfycbwWrGCmzYh5RGFUesOxpUgu6ZgZBnhPtjLOvFNKICU20DimKU0_mfui4a33X5oCIto/exec',
                async getData() {
                    console.log("Fetching data from Google Sheet 'Samples'...");
                    const response = await fetch(`${this.URL}?sheet=Samples`, { method: 'GET', cache: 'no-store' });
                    if (!response.ok) throw new Error(`Google Sheet API GET failed: ${response.statusText}`);
                    const data = await response.json();
                    if (Array.isArray(data)) { return { samples: [], logs: [], foils: [] }; }
                    return { samples: data.samples || [], logs: data.logs || [], foils: [] };
                },
                async saveData(state) {
                    console.log("Saving data to Google Sheet 'Samples'...");
                    const stateToSave = { samples: state.samples, logs: state.logs };
                    const response = await fetch(`${this.URL}?sheet=Samples`, {
                        method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(stateToSave)
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Google Sheet API POST failed: ${response.statusText} - ${errorText}`);
                    }
                    return await response.json();
                },
                async importFromOldSheet() {
                    console.log("Fetching data from OLD Foil Sheet (Sheet1)...");
                    const response = await fetch(`${this.URL}`, { method: 'GET', cache: 'no-store' });
                    if (!response.ok) throw new Error(`Google Sheet API GET (Import) failed: ${response.statusText}`);
                    return await response.json();
                }
            },

            async init() {
                await LocalDB.init();
                this.bindEventListeners();
                this.UI.renderCurrentView(); 
                this.loadInitialData(); 
            },

            async loadInitialData() {
                this.UI.updateSaveStatus('loading');
                try {
                    const localData = await LocalDB.getData();
                    this.state.samples = localData.samples || [];
                    this.state.logs = localData.logs || [];
                    this.state.foils = localData.foils || [];
                    
                    console.log("Loaded initial data from IndexedDB.");
                    
                    this.finishDataProcessing(); 

                    if (localData.samples.length > 0 || localData.foils.length > 0) {
                        this.state.hasSuccessfullyLoadedOnce = true;
                        this.UI.updateSaveStatus('offline');
                    }

                } catch (dbError) {
                    console.error("Critical error reading from IndexedDB:", dbError);
                    this.UI.showToast("A critical error occurred with the local database.", 'danger');
                }

                this.runBackgroundSync();
            },

            // الدالة الجديدة التي تقوم بالدمج الذكي
        mergeData(localItems, remoteItems) {
            const localMap = new Map(localItems.map(item => [item.docId, item]));
            const remoteMap = new Map(remoteItems.map(item => [item.docId, item]));
            const mergedList = [];
            const itemsToPush = []; // العناصر المحلية الأحدث التي يجب دفعها للسحابة

            // المرور على جميع العناصر (المحلية والسحابية) بدون تكرار
            const allKeys = new Set([...localMap.keys(), ...remoteMap.keys()]);

            allKeys.forEach(key => {
                const local = localMap.get(key);
                const remote = remoteMap.get(key);

                if (local && !remote) {
                    // موجود محلياً فقط: عنصر جديد تم إنشاؤه أوفلاين
                    mergedList.push(local);
                    itemsToPush.push(local);
                } else if (!local && remote) {
                    // موجود سحابياً فقط: عنصر جديد من السحابة
                    mergedList.push(remote);
                } else if (local && remote) {
                    // موجود في كلا المكانين: نقارن التحديث
                    const localDate = new Date(local.lastUpdated || 0);
                    const remoteDate = new Date(remote.lastUpdated || 0);

                    if (localDate > remoteDate) {
                        // المحلي أحدث: احتفظ به وادفعه للسحابة
                        mergedList.push(local);
                        itemsToPush.push(local);
                    } else {
                        // السحابي أحدث أو متساويان: استخدم النسخة السحابية
                        mergedList.push(remote);
                    }
                }
            });
            
            // يجب فرز القائمة النهائية لضمان العرض المتسق
            mergedList.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            
            return { mergedList, itemsToPush };
        },

        // استبدل الدالة القديمة بهذه النسخة الجديدة بالكامل
        async runBackgroundSync() {
            console.log("Starting SMART background sync...");
            this.UI.updateSaveStatus('loading');

            // جلب البيانات من كلا المصدرين بالتوازي
            const [samplesResult, foilsResult] = await Promise.all([
                this.GoogleAppsScriptPersistence.getData().catch(e => ({ error: e, type: 'samples' })),
                this.GoogleAppsScriptPersistence.importFromOldSheet().catch(e => ({ error: e, type: 'foils' }))
            ]);

            let stateChanged = false;
            let itemsToCommit = [];

            // --- دمج بيانات العينات (Samples) ---
            if (samplesResult && !samplesResult.error) {
                const remoteSamples = samplesResult.samples || [];
                const { mergedList, itemsToPush } = this.mergeData(this.state.samples, remoteSamples);
                
                // تحقق مما إذا كان الدمج قد أدى إلى تغيير
                if (JSON.stringify(this.state.samples) !== JSON.stringify(mergedList)) {
                    this.state.samples = mergedList;
                    stateChanged = true;
                    console.log("Samples state updated after smart merge.");
                }
                if (itemsToPush.length > 0) {
                    itemsToCommit.push(...itemsToPush);
                    console.log(`${itemsToPush.length} local samples are newer and will be pushed.`);
                }
            } else {
                console.warn("Background sync for samples failed:", samplesResult.error.message);
            }
            
            // ملاحظة: منطق الـ Foils ليس لديه حقل lastUpdated، لذا سيبقى كما هو حالياً
            // إذا أردت تطبيق نفس المنطق عليه، يجب إضافة lastUpdated للـ Foils أيضاً.
            if (foilsResult && !foilsResult.error) {
                const foilData = foilsResult.rolls || [];
                const newFoils = foilData.map(foil => ({
                    docId: foil.docId, name: foil.id || "Unnamed Import", reference: foil.groupNumber ? String(foil.groupNumber) : "N/A",
                    imageUrl: foil.imageUrl || "", entryDate: foil.entryDate || null, components: foil.components || [],
                    totalStandardLength: foil.totalStandardLength || 0, width: foil.width || 0
                }));
                if (JSON.stringify(this.state.foils) !== JSON.stringify(newFoils)) {
                    this.state.foils = newFoils;
                    stateChanged = true;
                    console.log("Foils data updated from remote.");
                }
            } else {
                 console.warn("Background sync for foils failed:", foilsResult.error.message);
            }

            // إذا كان هناك أي تغييرات (سواء من الدمج أو لوجود عناصر محلية أحدث)
            if (stateChanged || itemsToCommit.length > 0) {
                 console.log("State has changed, saving to DB and potentially committing newer local items.");
                try {
                    // أولاً، احفظ الحالة المدمجة الجديدة محلياً
                    await LocalDB.saveData(this.state);
                    this.UI.showToast('Data synced in the background.', 'success');
                    
                    // ثانياً، إذا كانت هناك عناصر محلية أحدث، قم بحفظ الحالة بأكملها للسحابة
                    if (itemsToCommit.length > 0) {
                        console.log("Committing merged state to the cloud because local changes were found...");
                        // استدعاء commitState سيقوم بإرسال الحالة المحدثة بالكامل
                        await this.commitState(); 
                    }
                    
                    this.finishDataProcessing(); // تحديث الواجهة
                } catch (dbError) {
                    console.error("Failed to save updated state to IndexedDB after merge:", dbError);
                    this.UI.showToast('Failed to save updated data locally.', 'danger');
                }
            } else {
                console.log("No data changes detected from remote. No update needed.");
            }

            this.UI.updateSaveStatus('saved');
        },

            finishDataProcessing() {
                this.state.samples.forEach(sample => {
                    sample.componentNamesStr = (sample.components || [])
                        .map(comp => {
                            const foil = this.state.foils.find(f => f.docId === (typeof comp === 'object' ? comp.id : comp));
                            return foil ? foil.name : '';
                        })
                        .join(' ');
                });

                this.state.fuse = new Fuse(this.state.samples, {
                    keys: ['name', 'category', 'location', 'componentNamesStr'], 
                    threshold: 0.3, 
                    ignoreLocation: true
                });

                this.state.foilFuse = new Fuse(this.state.foils, {
                    keys: ['name', 'reference'], threshold: 0.3, ignoreLocation: true
                });
                
                const activeModal = document.querySelector('.modal.show');
                if (activeModal && activeModal.id === 'details-modal') {
                    this.UI.renderDetailsModal(this.state.currentModalSampleId); 
                } else {
                    this.UI.renderCurrentView();
                }
            },
            
            async saveStateLocallyAndCommit() {
                try {
                    await LocalDB.saveData(this.state);
                    console.log("State saved to IndexedDB.");
                    this.UI.updateSaveStatus('offline');
                    await this.commitState();
                } catch(dbError) {
                    console.error("Failed to save state to IndexedDB:", dbError);
                    this.UI.showToast("Critical error: Could not save data locally.", 'danger');
                }
            },
            
            scheduleRetry() {
                if (this.state.retryTimerId) clearTimeout(this.state.retryTimerId);
                const retryDelay = 10000;
                this.state.retryTimerId = setTimeout(() => this.commitState(), retryDelay);
            },

            async commitState() {
                if (!this.state.hasSuccessfullyLoadedOnce) {
                    console.warn("SAVE ABORTED: Initial data not loaded.");
                    this.UI.showToast("Cannot save: initial data not loaded. Check connection.", 'danger');
                    return;
                }
                if (this.state.isSaving) return;
                if (!navigator.onLine) { this.UI.updateSaveStatus('offline'); return; }
                if (this.state.retryTimerId) { clearTimeout(this.state.retryTimerId); this.state.retryTimerId = null; }

                this.state.isSaving = true;
                this.UI.updateSaveStatus('saving');

                try {
                    await this.GoogleAppsScriptPersistence.saveData(this.state);
                    console.log("Data successfully synced.");
                    this.state.isSaving = false;
                    this.UI.updateSaveStatus('saved');
                } catch (e) {
                    console.error("Commit Error:", e);
                    this.state.isSaving = false;
                    this.UI.updateSaveStatus('retrying');
                    this.UI.showToast(`Sync failed: ${e.message}. Will retry automatically.`, 'warning');
                    this.scheduleRetry();
                }
            },

            addLog(action, description, details = {}) {
                const newLog = { id: `log_${Date.now()}`, timestamp: new Date().toISOString(), action, description, details };
                this.state.logs.unshift(newLog);
                if (this.state.logs.length > 500) this.state.logs.pop();
            },
            
            addSample(data) {
                const components = (data.components || []).map(id => ({ id: id, points: [] }));
    
                const newSample = {
                    docId: `sample_${Date.now()}`,
                    isArchived: false,
                    imageUrl: '',
                    ...data,
                    components: components,
                    lastUpdated: new Date().toISOString()
                };
                this.state.samples.push(newSample);
                this.addLog('CREATE_SAMPLE', `Created new sample: ${data.name}`, { docId: newSample.docId });
                this.state.samples.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                this.saveStateLocallyAndCommit();
            },

            updateSample(docId, data) {
                const index = this.state.samples.findIndex(sample => sample.docId === docId);
                if (index > -1) {
                    const oldSample = this.state.samples[index];
                    const oldName = oldSample.name;
            
                    if (data.components && Array.isArray(data.components) && data.components.every(c => typeof c === 'string')) {
                        const oldComponentData = (oldSample.components || []).filter(c => typeof c === 'object');
                        data.components = data.components.map(newId => {
                            const existing = oldComponentData.find(old => old.id === newId);
                            return existing || { id: newId, points: [] };
                        });
                    }
            
                    this.state.samples[index] = { ...this.state.samples[index], ...data, lastUpdated: new Date().toISOString() };
                    if (oldName !== data.name) {
                        this.addLog('UPDATE_SAMPLE_INFO', `Renamed sample ${oldName} -> ${data.name}`, { docId: docId });
                    }
                    this.state.samples.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                    this.saveStateLocallyAndCommit();
                }
            },
            
            archiveSample(docId) {
                const index = this.state.samples.findIndex(s => s.docId === docId);
                if (index > -1) {
                    this.state.samples[index].isArchived = true;
                    this.state.samples[index].lastUpdated = new Date().toISOString();
                    this.addLog('ARCHIVE_SAMPLE', `Archived sample: ${this.state.samples[index].name}`, { docId });
                    this.saveStateLocallyAndCommit();
                    this.UI.renderCurrentView();
                }
            },
            
            unarchiveSample(docId) {
                const index = this.state.samples.findIndex(s => s.docId === docId);
                if (index > -1) {
                    this.state.samples[index].isArchived = false;
                    this.state.samples[index].lastUpdated = new Date().toISOString();
                    this.addLog('UNARCHIVE_SAMPLE', `Restored sample: ${this.state.samples[index].name}`, { docId });
                    this.saveStateLocallyAndCommit();
                    this.UI.renderCurrentView();
                }
            },

            deleteSample(docId) { 
                const sample = this.state.samples.find(s => s.docId === docId);
                if(sample) this.addLog('DELETE_SAMPLE', `Permanently deleted sample: ${sample.name}`, { docId: docId, deletedName: sample.name });
                this.state.samples = this.state.samples.filter(s => s.docId !== docId);
                this.saveStateLocallyAndCommit();
            },

            bindEventListeners() {
                Object.entries(this.elements.viewSwitcher).forEach(([viewName, btn]) => {
                    btn.addEventListener('click', () => this.navigateTo(viewName));
                });
                
                this.elements.createBtn.addEventListener('click', () => this.UI.openModal('add'));
                this.elements.printBtn.addEventListener('click', () => this.UI.printView());
                this.elements.showArchivedToggle.addEventListener('change', (e) => {
                    this.state.showArchived = e.target.checked;
                    this.UI.renderCurrentView();
                });

                window.addEventListener('online', () => { this.UI.showToast("You are back online. Syncing changes...", 'success'); this.commitState(); });
                window.addEventListener('offline', () => { this.UI.showToast("You are offline. Changes will be saved locally.", 'info'); this.UI.updateSaveStatus('offline'); });

                this.elements.searchTagsContainer.addEventListener('click', (e) => {
                    const closeButton = e.target.closest('.btn-close');
                    if (closeButton) {
                        this.Search.removeTerm(this.state.currentView, closeButton.parentElement.dataset.term);
                    }
                });

                document.getElementById('sample-form').addEventListener('submit', (e) => this.handleFormSubmit(e));
                this.elements.mainContent.addEventListener('click', (e) => this.handleMainContentClick(e));
                
                this.elements.detailsModalBody.addEventListener('click', (e) => this.handleDetailsModalClick(e));

                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.search-container')) {
                        this.UI.hideAdvancedSearch();
                    }
                });

                const dropZone = document.getElementById('image-drop-zone');
                const fileInput = document.getElementById('sample-image');
                dropZone.addEventListener('click', () => fileInput.click());
                dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
                dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                    if (e.dataTransfer.files.length) {
                        fileInput.files = e.dataTransfer.files;
                        const event = new Event('change', { bubbles: true });
                        fileInput.dispatchEvent(event);
                    }
                });
                fileInput.addEventListener('change', () => {
                   if (fileInput.files.length) this.UI.updateImagePreview(fileInput.files[0]);
                });

                document.getElementById('open-camera-btn').addEventListener('click', () => this.UI.Camera.open());
                document.getElementById('snap-photo-btn').addEventListener('click', () => this.UI.Camera.snap());
                document.getElementById('use-photo-btn').addEventListener('click', () => this.UI.Camera.use());
                document.getElementById('camera-modal').addEventListener('hidden.bs.modal', () => this.UI.Camera.close());
                
                document.getElementById('save-annotations-btn').addEventListener('click', () => {
                    this.UI.ImageAnnotator.save();
                });
            },

            navigateTo(viewName) {
                this.state.currentView = viewName;
                Object.values(this.elements.viewSwitcher).forEach(btn => btn.classList.remove('active'));
                if (this.elements.viewSwitcher[viewName]) this.elements.viewSwitcher[viewName].classList.add('active');
                this.UI.renderCurrentView();
            },
            
            handleSearch() { this.UI.renderCurrentView(); },

            performSearch() {
                const currentView = this.state.currentView;
                const searchTerms = this.state.searchTerms[currentView] || [];
                
                let sourceData, fuseOptions;
                if (currentView === 'foil') {
                    sourceData = this.state.foils;
                    fuseOptions = { keys: ['name', 'reference'], threshold: 0.3, ignoreLocation: true };
                } else {
                    sourceData = this.state.samples;
                    fuseOptions = { keys: ['name', 'category', 'location', 'componentNamesStr'], threshold: 0.3, ignoreLocation: true };
                }
                
                if (!sourceData) return [];

                let filteredData = sourceData;

                const structuredTerms = [];
                const fuzzyTerms = [];
                const filterRegex = /^(\w+):"([^"]+)"$/;

                searchTerms.forEach(term => {
                    const match = term.match(filterRegex);
                    if (match) {
                        structuredTerms.push({ key: match[1].toLowerCase(), value: match[2].toLowerCase() });
                    } else {
                        fuzzyTerms.push(term);
                    }
                });

                if (structuredTerms.length > 0) {
                    filteredData = filteredData.filter(item => {
                        return structuredTerms.every(term => {
                            const itemValue = item[term.key];
                            return itemValue && String(itemValue).toLowerCase().includes(term.value);
                        });
                    });
                }
                
                if (fuzzyTerms.length > 0) {
                    const tempFuse = new Fuse(filteredData, fuseOptions);
                    filteredData = tempFuse.search(fuzzyTerms.join(' ')).map(result => result.item);
                }
                
                if (currentView !== 'foil') {
                    return filteredData.filter(sample => this.state.showArchived ? sample.isArchived : !sample.isArchived);
                }

                return filteredData;
            },

            async handleFormSubmit(e) {
                e.preventDefault();
                
                const name = document.getElementById('sample-name').value.trim();
                // MODIFICATION: Get category value from Tom-Select instance
                const category = this.state.categorySelect ? this.state.categorySelect.getValue() : '';
                const location = document.getElementById('sample-location').value.trim();
                const description = document.getElementById('sample-description').value.trim();
                const entryDate = document.getElementById('sample-entry-date').value;
                let imageFile = document.getElementById('sample-image').files[0];
                const editId = document.getElementById('sample-edit-id').value;
                const components = this.state.componentsSelect ? this.state.componentsSelect.getValue() : [];

                if (!name) {
                    this.UI.showToast("Please enter a valid sample name.", 'danger');
                    return;
                }

                this.UI.setLoading(true);

                const sampleData = { name, category, location, description, components, entryDate: entryDate || null };

                if (imageFile) {
                    try {
                        imageFile = await this.UI.ImageConverter.convertToPng(imageFile);
                    } catch (error) {
                        console.error("Image conversion failed:", error);
                        this.UI.showToast("Failed to process the image. Please try a different image.", 'danger');
                        this.UI.setLoading(false);
                        return;
                    }

                    const imageUrl = await this.uploadToImgur(imageFile);
                    if (imageUrl) {
                        sampleData.imageUrl = imageUrl;
                    } else {
                        // uploadToImgur already shows a toast on failure
                        this.UI.setLoading(false);
                        return;
                    }
                }

                this.elements.sampleModal.hide();
                
                if (editId) {
                    if (!sampleData.imageUrl) {
                        const existingSample = this.state.samples.find(s => s.docId === editId);
                        if (existingSample) sampleData.imageUrl = existingSample.imageUrl;
                    }
                    this.updateSample(editId, sampleData);
                } else {
                    this.addSample(sampleData);
                }
                this.UI.setLoading(false);
                this.UI.renderCurrentView();
            },
            
            handleMainContentClick(e) {
                const card = e.target.closest('.kanban-card, .list-view-row');
                if (card && card.dataset.id) {
                    if (this.state.currentView !== 'foil') {
                        this.UI.renderDetailsModal(card.dataset.id);
                    }
                    return;
                }
            },
            
            handleDetailsModalClick(e) {
                const editBtn = e.target.closest('#details-edit-btn');
                const archiveBtn = e.target.closest('#details-archive-btn');
                const unarchiveBtn = e.target.closest('#details-unarchive-btn');
                const deleteBtn = e.target.closest('#details-delete-btn');
                const annotateBtn = e.target.closest('#details-annotate-btn');
    
                if (annotateBtn) {
                    const docId = annotateBtn.dataset.docId;
                    const sample = this.state.samples.find(s => s.docId === docId);
                    if (sample && sample.imageUrl && sample.components && sample.components.length > 0) {
                        this.elements.detailsModal.hide();
                        setTimeout(() => {
                            const annotationModal = new bootstrap.Modal(document.getElementById('annotation-modal'));
                            annotationModal.show();
                            this.UI.ImageAnnotator.init(sample);
                        }, 300);
                    } else {
                        this.UI.showToast('Image and components are required to annotate.', 'warning');
                    }
                    return;
                }

                const handleAction = (action, docId) => {
                    this.elements.detailsModal.hide();
                    setTimeout(() => action(docId), 200);
                };
    
                if (editBtn) {
                    handleAction((docId) => this.UI.openModal('edit', docId), editBtn.dataset.docId);
                } else if (archiveBtn) {
                    handleAction((docId) => {
                        this.UI.showConfirmationModal('Are you sure you want to archive this sample?', () => this.archiveSample(docId));
                    }, archiveBtn.dataset.docId);
                } else if (unarchiveBtn) {
                    handleAction((docId) => this.unarchiveSample(docId), unarchiveBtn.dataset.docId);
                } else if (deleteBtn) {
                    handleAction((docId) => {
                        this.UI.showConfirmationModal('Are you sure you want to permanently delete this sample?', () => this.deleteSample(docId));
                    }, deleteBtn.dataset.docId);
                }
            },
            
            async uploadToImgur(file) {
                const clientId = 'a2752b647621b24';
                const formData = new FormData();
                formData.append('image', file);
                this.UI.setLoading(true);
                try {
                    const response = await fetch('https://api.imgur.com/3/image', {
                        method: 'POST', headers: { Authorization: `Client-ID ${clientId}` }, body: formData,
                    });
                    if (!response.ok) throw new Error(`Imgur upload failed: ${await response.text()}`);
                    const result = await response.json();
                    if (result.success) {
                        this.UI.showToast('Image uploaded successfully!', 'success');
                        return result.data.link;
                    } else {
                        throw new Error('Imgur API returned an error.');
                    }
                } catch (error) {
                    console.error('Imgur upload error:', error);
                    this.UI.showToast(`Image upload failed: ${error.message}`, 'danger');
                    return null;
                } finally {
                    this.UI.setLoading(false);
                }
            },
            
            Search: {
                addTerm(view, term) {
                    const terms = SampleManagerApp.state.searchTerms[view];
                    term = term.trim();
                    if (term && !terms.includes(term)) {
                        terms.push(term);
                        SampleManagerApp.UI.renderSearchTags(view);
                        SampleManagerApp.handleSearch();
                    }
                    const input = SampleManagerApp.elements.searchContainer.querySelector('input');
                    if(input) input.value = '';
                    SampleManagerApp.UI.hideAdvancedSearch();
                },
                removeTerm(view, termToRemove) {
                    const terms = SampleManagerApp.state.searchTerms[view];
                    const index = terms.indexOf(termToRemove);
                    if (index > -1) {
                        terms.splice(index, 1);
                        SampleManagerApp.UI.renderSearchTags(view);
                        SampleManagerApp.handleSearch();
                    }
                },
            }
        };
        
        SampleManagerApp.UI = {
            setLoading(isLoading) { SampleManagerApp.elements.loadingOverlay.style.display = isLoading ? 'flex' : 'none'; },
            
            updateSaveStatus(status) {
                const indicator = SampleManagerApp.elements.saveStatusIndicator;
                if (!indicator) return;
                let content = '';
                switch(status) {
                    case 'loading': content = `<div class="spinner-border spinner-border-sm text-primary" role="status"></div><span class="text-muted small">Loading...</span>`; break;
                    case 'saving': content = `<i class="bi bi-cloud-arrow-up text-primary"></i><span class="text-muted small">Saving...</span>`; break;
                    case 'saved': content = `<i class="bi bi-check-circle-fill text-success"></i><span class="text-success small">Synced</span>`; break;
                    case 'offline': content = `<i class="bi bi-wifi-off text-muted"></i><span class="text-muted small">Offline</span>`; break;
                    case 'retrying': content = `<i class="bi bi-exclamation-triangle-fill text-warning"></i><span class="text-warning small">Sync failed. Retrying...</span>`; break;
                    case 'error': content = `<i class="bi bi-exclamation-triangle-fill text-danger"></i><span class="text-danger small">Error</span>`; break;
                    default: indicator.style.display = 'none'; break;
                }
                indicator.innerHTML = content;
                indicator.style.display = 'flex';
                if (status === 'saved') setTimeout(() => { if(indicator.innerHTML.includes('Synced')) indicator.style.display = 'none'; }, 2000);
            },

            renderCurrentView() {
                const view = SampleManagerApp.state.currentView;
                this.renderSearchControls(view); 
                const data = SampleManagerApp.performSearch();
                
                this.renderSearchTags(view);

                const countContainer = document.getElementById('item-count-display');
                if (countContainer) {
                    let countText = '';
                    if (view === 'foil') countText = 'Foil';
                    else countText = SampleManagerApp.state.showArchived ? 'Archived' : 'Sample';
                    countContainer.textContent = `${data.length} ${countText}${data.length !== 1 ? 's' : ''}`;
                    countContainer.title = 'Total items currently displayed';
                }
                
                const isMainView = ['kanban', 'list'].includes(view);
                SampleManagerApp.elements.printBtn.style.display = (isMainView && !SampleManagerApp.state.showArchived) ? 'block' : 'none';
                SampleManagerApp.elements.createBtn.style.display = (SampleManagerApp.state.showArchived || view === 'foil' || view === 'reports') ? 'none' : 'block';
                SampleManagerApp.elements.showArchivedToggle.style.display = isMainView ? 'block' : 'none';

                switch (view) {
                    case 'kanban': this.renderKanbanView(data); break;
                    case 'list': this.renderListView(data); break;
                    case 'foil': this.renderFoilView(data); break;
                    case 'reports': this.renderReportsView(); break;
                }
                this.initTooltips();
            },

            renderSearchControls(view) {
                const container = SampleManagerApp.elements.searchContainer;
                if (view === 'reports' || (view !== 'foil' && SampleManagerApp.state.showArchived)) {
                    container.innerHTML = ''; return;
                }
                
                container.innerHTML = `
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="search" id="${view}-search-input" class="form-control" placeholder="Search...">
                        <span id="item-count-display" class="input-group-text bg-light text-dark"></span>
                    </div>
                    <div id="advanced-search-dropdown" class="advanced-search-dropdown" style="display: none;"></div>
                `;

                const input = document.getElementById(`${view}-search-input`);
                input.addEventListener('focus', () => this.showAdvancedSearch(view));
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && input.value.trim()) {
                        e.preventDefault();
                        SampleManagerApp.Search.addTerm(view, input.value.trim());
                    }
                });

                const dropdown = document.getElementById('advanced-search-dropdown');
                dropdown.addEventListener('click', (e) => {
                    const item = e.target.closest('.search-dropdown-item');
                    if (item && item.dataset.filterKey && item.dataset.filterValue) {
                        const { filterKey, filterValue } = item.dataset;
                        const term = `${filterKey}:"${filterValue}"`;
                        SampleManagerApp.Search.addTerm(view, term);
                    }
                });
            },

            showAdvancedSearch(view) {
                const dropdown = document.getElementById('advanced-search-dropdown');
                if (!dropdown) return;

                let content = '';
                const sourceData = view === 'foil' ? SampleManagerApp.state.foils : SampleManagerApp.state.samples;

                const categories = [...new Set(sourceData.map(s => s.category).filter(Boolean))];
                const locations = [...new Set(sourceData.map(s => s.location).filter(Boolean))];

                if (categories.length > 0) {
                    content += `<div class="search-dropdown-section"><div class="search-dropdown-header">Category</div>`;
                    categories.forEach(cat => {
                        content += `<div class="search-dropdown-item" data-filter-key="category" data-filter-value="${cat}"><i class="bi bi-tag"></i>${cat}</div>`;
                    });
                    content += `</div>`;
                }

                if (locations.length > 0) {
                    content += `<div class="search-dropdown-section"><div class="search-dropdown-header">Location</div>`;
                    locations.forEach(loc => {
                        content += `<div class="search-dropdown-item" data-filter-key="location" data-filter-value="${loc}"><i class="bi bi-geo-alt"></i>${loc}</div>`;
                    });
                    content += `</div>`;
                }

                dropdown.innerHTML = content || '<div class="text-muted text-center p-2">No filters available.</div>';
                dropdown.style.display = 'block';
            },

            hideAdvancedSearch() {
                const dropdown = document.getElementById('advanced-search-dropdown');
                if (dropdown) {
                    dropdown.style.display = 'none';
                }
            },

            renderKanbanView(samplesToRender) {
                const container = SampleManagerApp.elements.mainContent;
                if (samplesToRender.length === 0) {
                    container.innerHTML = `<div class="text-center text-muted"><div class="card p-5"><p class="mb-0 h5">No samples match your search.</p></div></div>`; return;
                }
                const kanbanContainer = document.createElement('div');
                kanbanContainer.id = 'kanban-view-content';
                samplesToRender.forEach(sample => { kanbanContainer.innerHTML += this.createKanbanCard(sample); });
                container.innerHTML = ''; container.appendChild(kanbanContainer);
            },

            createKanbanCard(sample) {
                const placeholderImg = `https://placehold.co/80x80/6c757d/ffffff?text=${encodeURIComponent(sample.name[0] || '?')}`;
                
                const componentNames = (sample.components && sample.components.length > 0)
                    ? sample.components.map(comp => {
                        const foil = SampleManagerApp.state.foils.find(f => f.docId === (typeof comp === 'object' ? comp.id : comp));
                        return foil ? `<span class="component-tag">${foil.name}</span>` : '';
                    }).filter(Boolean).join('')
                    : '<span style="font-size: 0.9em; color: #888;">No components</span>';

                return `
                <div class="kanban-card ${sample.isArchived ? 'opacity-50' : ''}" data-id="${sample.docId}">
                    <div class="kanban-card-header">
                        <div>
                            <div class="kanban-card-title">${sample.name}</div>
                        </div>
                        <div class="kanban-image-container">
                            <img src="${sample.imageUrl || placeholderImg}" alt="Sample Image" onerror="this.onerror=null;this.src='${placeholderImg}';">
                        </div>
                    </div>
                    <div class="kanban-card-body">
                        <p><strong><i class="bi bi-tag-fill me-1"></i>Category:</strong> ${sample.category || 'N/A'}</p>
                        <div class="component-tags-container">${componentNames}</div>
                    </div>
                    <div class="kanban-card-footer">
                        ${sample.isArchived ? '<span class="badge bg-secondary">Archived</span>' : ''}
                    </div>
                </div>`;
            },
            
            renderListView(samplesToRender) {
                const container = SampleManagerApp.elements.mainContent;

                if (SampleManagerApp.state.listViewHolder) {
                    SampleManagerApp.state.listViewHolder.destroy();
                    SampleManagerApp.state.listViewHolder = null;
                }
                
                let tableHtml = `<div class="table-view-container"><table id="samples-list-table" class="table table-hover align-middle mb-0"><thead><tr>
                    <th class="no-print">Image</th><th>Name</th><th>Category</th><th>Location</th><th>Last Updated</th>
                </tr></thead><tbody>`;
                
                if (samplesToRender.length > 0) {
                    samplesToRender.forEach(s => {
                        const placeholderImg = `https://placehold.co/40x40/6c757d/ffffff?text=${encodeURIComponent(s.name[0] || '?')}`;
                        const lastUpdatedText = s.lastUpdated ? new Date(s.lastUpdated).toLocaleDateString('en-US') : 'N/A';
                        tableHtml += `<tr class="list-view-row ${s.isArchived ? 'opacity-50' : ''}" data-id="${s.docId}">
                            <td class="no-print"><img src="${s.imageUrl || placeholderImg}" class="rounded" style="width:40px;height:40px;object-fit:cover;" onerror="this.onerror=null;this.src='${placeholderImg}';"></td>
                            <td class="fw-bold">${s.name}</td>
                            <td>${s.category || '-'}</td>
                            <td>${s.location || '-'}</td>
                            <td>${lastUpdatedText}</td>
                        </tr>`;
                    });
                }
                tableHtml += `</tbody></table></div>`;
                container.innerHTML = tableHtml;

                const tableElement = document.getElementById('samples-list-table');
                if (tableElement && samplesToRender.length > 0) {
                   SampleManagerApp.state.listViewHolder = new DataTable(tableElement, {
                        searching: false,
                        lengthChange: false,
                        pageLength: 10,
                        language: {
                            url: '//cdn.datatables.net/plug-ins/2.0.8/i18n/ar.json',
                        },
                        drawCallback: () => {
                            const rows = document.querySelectorAll('#samples-list-table .list-view-row');
                            rows.forEach(row => {
                                row.style.cursor = 'pointer';
                                row.onclick = (e) => {
                                    if(e.target.tagName === 'IMG') return;
                                    const sampleId = row.dataset.id;
                                    if(sampleId) this.renderDetailsModal(sampleId);
                                };
                            });
                        }
                    });
                } else if(samplesToRender.length === 0){
                    container.innerHTML = `<div class="text-center text-muted"><div class="card p-5"><p class="mb-0 h5">No samples match your search.</p></div></div>`;
                }

            },

            createComponentsTable(foil) {
                const components = foil.components || [];
                if (components.length === 0) {
                    return '<p class="text-muted small mt-3">No parts recorded for this foil.</p>';
                }

                let tableRows = '';
                components.forEach(comp => {
                    tableRows += `<tr>
                        <td>${comp.length || 0} cm</td>
                        <td>${comp.width || 0} cm</td>
                    </tr>`;
                });

                return `<table class="table table-sm table-bordered mt-3">
                    <thead class="table-light">
                        <tr>
                            <th>Length</th>
                            <th>Width</th>
                        </tr>
                    </thead>
                    <tbody>${tableRows}</tbody>
                </table>`;
            },
            
            renderFoilView(foilsToRender) {
                const container = SampleManagerApp.elements.mainContent;
                if (foilsToRender.length === 0) {
                    container.innerHTML = `<div class="text-center text-muted"><div class="card p-5"><p class="mb-0 h5">No foils to display.</p></div></div>`;
                    return;
                }

                const accordionHtml = foilsToRender.map((foil, index) => {
                    const placeholderImg = `https://placehold.co/40x40/6c757d/ffffff?text=${encodeURIComponent(foil.name[0] || '?')}`;
                    return `
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading-${foil.docId}">
                                <button class="accordion-button ${index > 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${foil.docId}">
                                    <img src="${foil.imageUrl || placeholderImg}" class="rounded me-3" style="width:32px;height:32px;object-fit:cover;" onerror="this.onerror=null;this.src='${placeholderImg}';">
                                    <span class="fw-bold me-auto">${foil.name}</span>
                                    <small class="text-muted">Ref: ${foil.reference || '-'}</small>
                                </button>
                            </h2>
                            <div id="collapse-${foil.docId}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" data-bs-parent="#foilAccordion">
                                <div class="accordion-body">
                                    <h6 class="component-bar-title">Visual Representation (Total Width: ${foil.width || 64} cm)</h6>
                                    ${this.createVisualBar(foil)}
                                    <h6 class="component-bar-title mt-4">Parts Table</h6>
                                    ${this.createComponentsTable(foil)}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = `<div class="accordion" id="foilAccordion">${accordionHtml}</div>`;
            },

            createVisualBar(foil) {
                const maxLength = foil.width || 64;
                const components = foil.components || [];
                const COLORS = ['#3b82f6', '#10b981', '#8b5cf6', '#f59e0b', '#ef4444', '#14b8a6', '#f97316'];
                let segmentsHTML = '';
                
                const totalLength = components.reduce((sum, comp) => sum + (comp.length || 0), 0);
                
                components.forEach((component, index) => {
                    if (!component || !component.length || component.length <= 0) return;

                    const segmentWidthPercentage = (component.length / maxLength) * 100;
                    const segmentColor = COLORS[index % COLORS.length];

                    segmentsHTML += `
                        <div 
                            class="visual-bar-segment" 
                            style="width: ${segmentWidthPercentage}%; background-color: ${segmentColor};"
                            data-bs-toggle="tooltip" 
                            title="Length: ${component.length} cm, Width: ${component.width || foil.width} cm"
                        ></div>`;
                });

                if (totalLength < maxLength) {
                    const remainingLength = maxLength - totalLength;
                    const remainingPercentage = (remainingLength / maxLength) * 100;
                    segmentsHTML += `<div class="visual-bar-segment" style="width: ${remainingPercentage}%" data-bs-toggle="tooltip" title="Remaining: ${remainingLength.toFixed(1)} cm"></div>`;
                } else if (totalLength > maxLength) {
                    segmentsHTML += `
                        <div 
                            class="visual-bar-segment" 
                            style="flex-grow: 1; background-color: #dc3545;"
                            data-bs-toggle="tooltip" 
                            title="Exceeded: ${(totalLength - maxLength).toFixed(1)} cm"
                        >+</div>`;
                }

                return `
                    <div class="visual-bar-container">
                        <div class="visual-bar-content">
                            ${segmentsHTML}
                        </div>
                    </div>`;
            },
            
            renderReportsView() {
                const container = SampleManagerApp.elements.mainContent;
                const logs = SampleManagerApp.state.logs.slice(0, 50);

                if (logs.length === 0) {
                    container.innerHTML = `<div class="card p-5 text-center text-muted">No logs to display.</div>`;
                    return;
                }

                const getIconForAction = (action) => {
                    switch(action) {
                        case 'CREATE_SAMPLE': return '<i class="bi bi-plus-circle-fill text-success me-2"></i>';
                        case 'UPDATE_SAMPLE_INFO': return '<i class="bi bi-pencil-fill text-primary me-2"></i>';
                        case 'ARCHIVE_SAMPLE': return '<i class="bi bi-archive-fill text-warning me-2"></i>';
                        case 'UNARCHIVE_SAMPLE': return '<i class="bi bi-box-arrow-up text-info me-2"></i>';
                        case 'DELETE_SAMPLE': return '<i class="bi bi-trash3-fill text-danger me-2"></i>';
                        case 'SYNC_FOILS':
                        case 'IMPORT_FOILS': return '<i class="bi bi-cloud-download-fill text-info me-2"></i>';
                        default: return '<i class="bi bi-info-circle-fill text-muted me-2"></i>';
                    }
                };

                const accordionHtml = logs.map((log, index) => `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading-${log.id}">
                            <button class="accordion-button ${index > 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${log.id}">
                                ${getIconForAction(log.action)} ${log.description}
                                <small class="ms-auto text-muted">${new Date(log.timestamp).toLocaleString('en-US')}</small>
                            </button>
                        </h2>
                        <div id="collapse-${log.id}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" data-bs-parent="#logsAccordion">
                            <div class="accordion-body">
                                <strong>Log Details:</strong>
                                <pre class="bg-light p-2 rounded mt-2"><code>${JSON.stringify(log.details, null, 2)}</code></pre>
                            </div>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = `<div class="accordion" id="logsAccordion">${accordionHtml}</div>`;
            },
            
            openModal(mode, docId = null){
                const form = document.getElementById('sample-form');
                form.reset();
                
                if (SampleManagerApp.state.componentsSelect) {
                    SampleManagerApp.state.componentsSelect.destroy();
                }

                // MODIFICATION: Start - Destroy old category selector and initialize a new one
                if (SampleManagerApp.state.categorySelect) {
                    SampleManagerApp.state.categorySelect.destroy();
                    SampleManagerApp.state.categorySelect = null;
                }
                
                // Prepare options for the category dropdown
                const defaultCategories = ['CIMAISE', 'PLINTHE', 'Wall panel', 'CORNICHE', 'CADRE'];
                const existingCategories = SampleManagerApp.state.samples.map(s => s.category).filter(Boolean);
                const allCategoryOptions = [...new Set([...defaultCategories, ...existingCategories])].map(cat => ({ value: cat, text: cat }));

                SampleManagerApp.state.categorySelect = new TomSelect('#sample-category', {
                    create: true, // Allow creating new categories
                    options: allCategoryOptions,
                    items: [],
                    render: {
                        no_results: function(data, escape) {
                            return '<div class="no-results">No results found. Type to create a new category.</div>';
                        },
                    }
                });
                // MODIFICATION: End

                const uniqueFoilsByName = [...new Map(SampleManagerApp.state.foils.map(item => [item['name'], item])).values()];
                const options = uniqueFoilsByName.map(foil => ({ value: foil.docId, text: foil.name }));

                SampleManagerApp.state.componentsSelect = new TomSelect('#sample-components', {
                    create: false,
                    options: options,
                    items: []
                });

                const imgPreview = document.getElementById('sample-image-preview');
                imgPreview.src = '';
                imgPreview.classList.add('d-none');
                document.getElementById('image-drop-zone').querySelector('p').textContent = 'Drag & drop an image here, or click to select a file.';
                document.getElementById('sample-edit-id').value = (mode === 'edit' && docId) ? docId : '';
                document.getElementById('modal-title').textContent = (mode === 'add') ? 'Create New Sample' : 'Edit Sample';

                if(mode === 'edit' && docId){
                    const sample = SampleManagerApp.state.samples.find(s => s.docId === docId);
                    if(sample){
                        document.getElementById('sample-name').value = sample.name || '';
                        // MODIFICATION: Use setValue for the Tom-Select instance
                        SampleManagerApp.state.categorySelect.setValue(sample.category || '');
                        document.getElementById('sample-location').value = sample.location || '';
                        document.getElementById('sample-description').value = sample.description || '';
                        if(sample.entryDate) document.getElementById('sample-entry-date').value = sample.entryDate;
                        if(sample.imageUrl){ 
                            imgPreview.src = sample.imageUrl; 
                            imgPreview.classList.remove('d-none');
                            document.getElementById('image-drop-zone').querySelector('p').textContent = "Existing image. Drag a new one to replace.";
                        }
                        if(sample.components) {
                            const componentIds = sample.components.map(c => typeof c === 'object' ? c.id : c);
                            SampleManagerApp.state.componentsSelect.setValue(componentIds);
                        }
                    }
                }
                SampleManagerApp.elements.sampleModal.show();
            },

            updateImagePreview(fileOrUrl) {
                const dropZoneText = document.getElementById('image-drop-zone').querySelector('p');
                const imgPreview = document.getElementById('sample-image-preview');

                if (typeof fileOrUrl === 'string') {
                    imgPreview.src = fileOrUrl;
                    imgPreview.classList.remove('d-none');
                    dropZoneText.textContent = "Image captured.";
                } else if (fileOrUrl instanceof File) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imgPreview.src = e.target.result;
                        imgPreview.classList.remove('d-none');
                    };
                    reader.readAsDataURL(fileOrUrl);
                    dropZoneText.textContent = fileOrUrl.name;
                }
            },
            
            renderSearchTags(view) {
                const container = SampleManagerApp.elements.searchTagsContainer; 
                container.innerHTML = '';
                const terms = SampleManagerApp.state.searchTerms[view] || [];
                terms.forEach(term => { 
                    // FIX: Escape quotes in the term before setting it as a data attribute
                    const escapedTerm = term.replace(/"/g, '&quot;');
                    container.innerHTML += `<span class="search-tag" data-term="${escapedTerm}">${term} <button type="button" class="btn-close btn-close-sm"></button></span>`; 
                });
            },

            closeAllSuggestions() {
                if (SampleManagerApp.state.activeSuggestions && SampleManagerApp.state.activeSuggestions.element) {
                    SampleManagerApp.state.activeSuggestions.element.style.display = 'none';
                    SampleManagerApp.state.activeSuggestions = null;
                }
            },

            printView() { window.print(); },
            showToast(message, type='success'){const id='t-'+Date.now();const tc=document.querySelector('.toast-container');tc.insertAdjacentHTML('beforeend',`<div id="${id}" class="toast align-items-center text-bg-${type} border-0" role="alert"><div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white ms-auto me-2" data-bs-dismiss="toast"></button></div></div>`);const toastEl=document.getElementById(id);const toast=new bootstrap.Toast(toastEl,{delay:3500});toast.show();toastEl.addEventListener('hidden.bs.toast',()=>toastEl.remove());},
            showConfirmationModal(message, onConfirm){const modalEl=document.getElementById('confirmation-modal');modalEl.querySelector('.modal-body').textContent=message;const confirmBtn=modalEl.querySelector('#confirmation-modal-confirm-btn');const newBtn=confirmBtn.cloneNode(true);confirmBtn.parentNode.replaceChild(newBtn,confirmBtn);newBtn.addEventListener('click',async ()=>{await onConfirm();SampleManagerApp.elements.confirmationModal.hide();},{once:true});SampleManagerApp.elements.confirmationModal.show();},
            
            initTooltips() {
                const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
                [...tooltipTriggerList].forEach(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
            },

            drawAnnotationsOnCanvas(ctx, annotations) {
                if (!ctx || !annotations || annotations.length === 0) {
                    return;
                }

                annotations.forEach(annotation => {
                    const foil = SampleManagerApp.state.foils.find(f => f.docId === annotation.id);
                    if (!foil) return;
                    const labelText = foil.name;

                    (annotation.points || []).forEach(point => {
                        if (point.x === null || point.y === null) return;

                        ctx.font = 'bold 16px Inter';
                        ctx.textAlign = 'center';
                        const textMetrics = ctx.measureText(labelText);
                        const textWidth = textMetrics.width;
                        const textHeight = 16;
                        const padding = 8;
                        const rectWidth = textWidth + padding;
                        const rectHeight = textHeight + padding;
                        const rectX = point.x - (rectWidth / 2);
                        const rectY = point.y - 35 - rectHeight;

                        ctx.fillStyle = 'rgba(103, 78, 167, 0.9)';
                        ctx.fillRect(rectX, rectY, rectWidth, rectHeight);

                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillText(labelText, point.x, point.y - 35 - (padding / 2));

                        ctx.strokeStyle = 'rgba(103, 78, 167, 0.9)';
                        ctx.fillStyle = 'rgba(103, 78, 167, 0.9)';
                        ctx.lineWidth = 2;
                        
                        ctx.beginPath();
                        ctx.arc(point.x, point.y, 5, 0, 2 * Math.PI);
                        ctx.fill();
                        
                        ctx.beginPath();
                        ctx.moveTo(point.x, point.y);
                        ctx.lineTo(point.x, rectY + rectHeight);
                        ctx.stroke();
                    });
                });
            },

            renderDetailsModal(sampleId) {
                SampleManagerApp.state.currentModalSampleId = sampleId;
                const sample = SampleManagerApp.state.samples.find(s => s.docId === sampleId);
                if (!sample) { SampleManagerApp.elements.detailsModal.hide(); return; }

                SampleManagerApp.elements.detailsModalTitle.innerHTML = `Sample Details: ${sample.name}`;
                const lastUpdatedText = sample.lastUpdated ? new Date(sample.lastUpdated).toLocaleString('en-US') : 'N/A';

                let actionButtonsHtml = '';
                if (sample.isArchived) {
                    actionButtonsHtml = `
                        <button id="details-unarchive-btn" data-doc-id="${sample.docId}" class="btn btn-success w-100 mb-2"><i class="bi bi-box-arrow-up me-2"></i>Unarchive</button>
                        <button id="details-delete-btn" data-doc-id="${sample.docId}" class="btn btn-danger w-100"><i class="bi bi-trash3-fill me-2"></i>Delete Permanently</button>`;
                } else {
                    actionButtonsHtml = `
                        <button id="details-edit-btn" data-doc-id="${sample.docId}" class="btn btn-primary w-100 mb-2"><i class="bi bi-pencil-square me-2"></i>Edit</button>
                        <button id="details-annotate-btn" data-doc-id="${sample.docId}" class="btn btn-info w-100 mb-2"><i class="bi bi-palette-fill me-2"></i>Annotate Image</button>
                        <button id="details-archive-btn" data-doc-id="${sample.docId}" class="btn btn-warning w-100"><i class="bi bi-archive-fill me-2"></i>Archive</button>`;
                }
                
                let componentsBarsHtml = '';
                if (sample.components && sample.components.length > 0) {
                    const attachedFoils = sample.components
                        .map(comp => SampleManagerApp.state.foils.find(f => f.docId === (typeof comp === 'object' ? comp.id : comp)))
                        .filter(f => f);
                    
                    const uniqueNames = [...new Set(attachedFoils.map(f => f.name))];
                    const lightColors = ['rgba(232, 245, 253, 0.7)', 'rgba(237, 247, 237, 0.7)', 'rgba(250, 240, 255, 0.7)', 'rgba(255, 248, 225, 0.7)', 'rgba(255, 235, 238, 0.7)'];
                    let colorIndex = 0;

                    uniqueNames.forEach(name => {
                        const allMatchingFoils = SampleManagerApp.state.foils.filter(f => f.name === name);
                        const backgroundColor = lightColors[(colorIndex++) % lightColors.length];
                        const representativeFoil = allMatchingFoils[0];
                        const placeholderImg = `https://placehold.co/40x40/6c757d/ffffff?text=${encodeURIComponent(representativeFoil.name[0] || '?')}`;
                        const groupImageHtml = `<img src="${representativeFoil.imageUrl || placeholderImg}" class="component-bar-image me-2" onerror="this.onerror=null;this.src='${placeholderImg}';">`;

                        let barsHtml = '';

                        if (allMatchingFoils.length > 1) {
                            allMatchingFoils.forEach(foil => {
                                barsHtml += `
                                    <div class="mt-2">
                                        <h6 class="component-bar-title mb-1"><small class="text-muted">Ref: ${foil.reference || 'N/A'}</small></h6>
                                        ${this.createVisualBar(foil)}
                                    </div>`;
                            });
                            
                            componentsBarsHtml += `
                                <div class="mb-3 p-2" style="border-left: 3px solid rgb(var(--bs-danger-rgb)); background-color: ${backgroundColor}; border-radius: 5px;">
                                    <div class="d-flex align-items-center">
                                        ${groupImageHtml}
                                        <h6 class="component-bar-title mb-0 flex-grow-1">${representativeFoil.name} <span class="badge bg-secondary">${allMatchingFoils.length}</span></h6>
                                    </div>
                                    ${barsHtml}
                                </div>`;
                        } else {
                            const foil = allMatchingFoils[0];
                            if (foil) {
                                barsHtml = `<div class="mt-2">${this.createVisualBar(foil)}</div>`;
                                componentsBarsHtml += `
                                <div class="component-bar-container p-2 mb-2" style="background-color: ${backgroundColor}; border-radius: 5px;">
                                    <div class="d-flex align-items-center">
                                        ${groupImageHtml}
                                        <h6 class="component-bar-title mb-0 flex-grow-1">${foil.name} <small class="text-muted">(Ref: ${foil.reference || 'N/A'})</small></h6>
                                    </div>
                                    ${barsHtml}
                                </div>`;
                            }
                        }
                    });
                }


                const imageDisplayHtml = sample.imageUrl
                    ? `<canvas id="details-image-canvas" class="img-fluid rounded shadow-sm mb-3" style="border: 1px solid #dee2e6;"></canvas>`
                    : `<div class="text-center bg-light p-5 rounded mb-3"><i class="bi bi-image-alt h1 text-muted"></i><p class="text-muted mt-2">No image for this sample</p></div>`;

                SampleManagerApp.elements.detailsModalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-5 mb-3 mb-md-0">
                        ${imageDisplayHtml} 
                        ${actionButtonsHtml}
                        <div class="text-center text-muted small mt-3"><i class="bi bi-clock-history"></i> Last updated: ${lastUpdatedText}</div>
                    </div>
                    <div class="col-md-7">
                        <ul class="list-group mb-3">
                            <li class="list-group-item d-flex justify-content-between align-items-center"><strong>Category:</strong> <span>${sample.category || '-'}</span></li>
                            <li class="list-group-item d-flex justify-content-between align-items-center"><strong>Location:</strong> <span>${sample.location || '-'}</span></li>
                            <li class="list-group-item d-flex justify-content-between align-items-center"><strong>Entry Date:</strong> <span>${sample.entryDate ? new Date(sample.entryDate).toLocaleDateString('en-CA') : '-'}</span></li>
                            <li class="list-group-item">
                                <strong>Description:</strong>
                                <p class="mt-1 mb-0" style="white-space: pre-wrap;">${sample.description || 'No description.'}</p>
                            </li>
                        </ul>
                        <div id="components-bars-section">
                           ${componentsBarsHtml}
                        </div>
                    </div>
                </div>`;
                
                if (sample.imageUrl) {
                    const canvas = document.getElementById('details-image-canvas');
                    const ctx = canvas.getContext('2d');
                    const image = new Image();
                    image.crossOrigin = "Anonymous";
                    
                    image.onload = () => {
                        canvas.width = image.width;
                        canvas.height = image.height;
                        ctx.drawImage(image, 0, 0);
                        this.drawAnnotationsOnCanvas(ctx, sample.components);
                    };
                    
                    image.src = sample.imageUrl + '?' + new Date().getTime();
                }

                this.initTooltips();

                if (!SampleManagerApp.elements.detailsModal._element.classList.contains('show')) {
                    SampleManagerApp.elements.detailsModal.show();
                }
            },

            ImageAnnotator: {
                canvas: null,
                ctx: null,
                sample: null,
                image: null,
                annotations: [],

                isDrawing: false,
                activeFoilId: null,
                isDragging: false,
                draggedPoint: null,

                init(sample) {
                    this.sample = sample;
                    this.canvas = document.getElementById('annotation-canvas');
                    this.ctx = this.canvas.getContext('2d');
                    
                    this.annotations = JSON.parse(JSON.stringify(
                        (sample.components || []).map(c => {
                            if (typeof c === 'object' && c.points) {
                                return c;
                            }
                            return { id: (c.id || c), points: (c.x !== null && c.y !== null) ? [{ x: c.x, y: c.y }] : [] };
                        })
                    ));

                    this.image = new Image();
                    this.image.crossOrigin = "Anonymous";
                    this.image.onload = () => {
                        this.canvas.width = this.image.width;
                        this.canvas.height = this.image.height;
                        this.redraw();
                    };
                    this.image.src = sample.imageUrl + '?' + new Date().getTime();

                    this.populateFoilTray();
                    this.bindEvents();
                },

                populateFoilTray() {
                    const tray = document.getElementById('foil-tray');
                    tray.innerHTML = '';
                    this.annotations.forEach(annotation => {
                        const foil = SampleManagerApp.state.foils.find(f => f.docId === annotation.id);
                        if (foil) {
                            tray.innerHTML += `
                                <div class="foil-label" data-foil-id="${foil.docId}">
                                    <span class="foil-name">${foil.name}</span>
                                    <div class="foil-handle"></div>
                                </div>
                            `;
                        }
                    });
                },

                findNearbyPoint(mouseX, mouseY) {
                    const hitRadius = 15;
                    for (const annotation of this.annotations) {
                        for (let i = 0; i < annotation.points.length; i++) {
                            const point = annotation.points[i];
                            const distance = Math.sqrt(Math.pow(mouseX - point.x, 2) + Math.pow(mouseY - point.y, 2));
                            if (distance < hitRadius) {
                                return { annotation, pointIndex: i };
                            }
                        }
                    }
                    return null;
                },

                bindEvents() {
                    const tray = document.getElementById('foil-tray');
                    tray.onmousedown = (e) => {
                        if (e.target.classList.contains('foil-handle')) {
                            this.isDrawing = true;
                            this.activeFoilId = e.target.closest('.foil-label').dataset.foilId;
                            e.preventDefault();
                        }
                    };

                    this.canvas.onmousedown = (e) => {
                        const rect = this.canvas.getBoundingClientRect();
                        const mouseX = (e.clientX - rect.left) * (this.canvas.width / rect.width);
                        const mouseY = (e.clientY - rect.top) * (this.canvas.height / rect.height);

                        const nearbyPoint = this.findNearbyPoint(mouseX, mouseY);
                        if (nearbyPoint) {
                            this.isDragging = true;
                            this.draggedPoint = nearbyPoint;
                            e.preventDefault();
                        }
                    };

                    this.canvas.onmousemove = (e) => {
                        const rect = this.canvas.getBoundingClientRect();
                        const mouseX = (e.clientX - rect.left) * (this.canvas.width / rect.width);
                        const mouseY = (e.clientY - rect.top) * (this.canvas.height / rect.height);
                        
                        if (this.isDragging && this.draggedPoint) {
                            this.draggedPoint.annotation.points[this.draggedPoint.pointIndex] = { x: mouseX, y: mouseY };
                            this.redraw();
                        } 
                        else if (this.isDrawing) {
                            this.redraw();
                            this.ctx.beginPath();
                            this.ctx.moveTo(mouseX, 0);
                            this.ctx.lineTo(mouseX, mouseY);
                            this.ctx.strokeStyle = 'rgb(var(--bs-primary-rgb))';
                            this.ctx.lineWidth = 2;
                            this.ctx.setLineDash([5, 5]);
                            this.ctx.stroke();
                            this.ctx.setLineDash([]);
                        }
                    };

                    this.canvas.onmouseup = (e) => {
                        const rect = this.canvas.getBoundingClientRect();
                        
                        if (this.isDragging && this.draggedPoint) {
                            const isOutside = e.clientX < rect.left || e.clientX > rect.right || e.clientY < rect.top || e.clientY > rect.bottom;
                            
                            if (isOutside) {
                                this.draggedPoint.annotation.points.splice(this.draggedPoint.pointIndex, 1);
                            }
                        }
                        else if (this.isDrawing) {
                            const mouseX = Math.round((e.clientX - rect.left) * (this.canvas.width / rect.width));
                            const mouseY = Math.round((e.clientY - rect.top) * (this.canvas.height / rect.height));

                            const annotation = this.annotations.find(a => a.id === this.activeFoilId);
                            if (annotation) {
                                annotation.points.push({ x: mouseX, y: mouseY });
                            }
                        }

                        this.isDrawing = false;
                        this.isDragging = false;
                        this.activeFoilId = null;
                        this.draggedPoint = null;
                        this.redraw();
                    };
                },

                redraw() {
                    if (!this.image || !this.ctx) return;
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    this.ctx.drawImage(this.image, 0, 0);

                    this.annotations.forEach(annotation => {
                        const foil = SampleManagerApp.state.foils.find(f => f.docId === annotation.id);
                        const labelText = foil ? foil.name : 'Unknown';

                        annotation.points.forEach(point => {
                            this.ctx.font = 'bold 16px Inter';
                            this.ctx.textAlign = 'center';
                            const textMetrics = this.ctx.measureText(labelText);
                            const textWidth = textMetrics.width;
                            const textHeight = 16;
                            const padding = 8;
                            const rectWidth = textWidth + padding;
                            const rectHeight = textHeight + padding;
                            const rectX = point.x - (rectWidth / 2);
                            const rectY = point.y - 35 - rectHeight;

                            this.ctx.fillStyle = 'rgba(220, 53, 69, 0.9)';
                            this.ctx.fillRect(rectX, rectY, rectWidth, rectHeight);

                            this.ctx.fillStyle = '#FFFFFF';
                            this.ctx.fillText(labelText, point.x, point.y - 35 - (padding / 2));

                            this.ctx.strokeStyle = 'rgba(220, 53, 69, 0.9)';
                            this.ctx.fillStyle = 'rgba(220, 53, 69, 0.9)';
                            this.ctx.lineWidth = 2;
                            this.ctx.beginPath();
                            this.ctx.arc(point.x, point.y, 5, 0, 2 * Math.PI);
                            this.ctx.fill();
                            this.ctx.beginPath();
                            this.ctx.moveTo(point.x, point.y);
                            this.ctx.lineTo(point.x, rectY + rectHeight);
                            this.ctx.stroke();
                        });
                    });
                },

                save() {
                    SampleManagerApp.updateSample(this.sample.docId, { components: this.annotations });
                    this.cleanup();
                    bootstrap.Modal.getInstance(document.getElementById('annotation-modal')).hide();
                    SampleManagerApp.UI.showToast('Annotations saved successfully!', 'success');
                },

                cleanup() {
                    this.canvas.onmousedown = null;
                    this.canvas.onmousemove = null;
                    this.canvas.onmouseup = null;
                    document.getElementById('foil-tray').onmousedown = null;
                    this.canvas = null;
                    this.ctx = null;
                    this.sample = null;
                    this.image = null;
                    this.annotations = [];
                    this.isDrawing = this.isDragging = false;
                    this.activeFoilId = this.draggedPoint = null;
                }
            },
            
            Camera: {
                dataURLtoFile(dataurl, filename) {
                    let arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                        bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
                    while(n--){ u8arr[n] = bstr.charCodeAt(n); }
                    return new File([u8arr], filename, {type: mime});
                },
                async open() {
                    if (!('mediaDevices' in navigator && 'getUserMedia' in navigator.mediaDevices)) {
                        SampleManagerApp.UI.showToast("Camera not supported on this browser.", "danger");
                        return;
                    }
                    this.reset();
                    SampleManagerApp.elements.cameraModal.show();
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                        SampleManagerApp.state.cameraStream = stream;
                        const video = document.getElementById('camera-stream');
                        video.srcObject = stream;
                        video.style.display = 'block';
                        document.getElementById('camera-permission-message').style.display = 'none';
                        document.getElementById('snap-photo-btn').style.display = 'inline-block';
                    } catch (err) {
                        console.error("Camera access error:", err);
                        SampleManagerApp.UI.showToast(`Camera access denied: ${err.message}`, "danger");
                        document.getElementById('camera-permission-message').textContent = "Could not access camera.";
                        SampleManagerApp.elements.cameraModal.hide();
                    }
                },
                snap() {
                    const video = document.getElementById('camera-stream');
                    const canvas = document.getElementById('camera-canvas');
                    const preview = document.getElementById('camera-snap-preview');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    canvas.getContext('2d').drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
                    preview.src = canvas.toDataURL('image/jpeg');
                    video.style.display = 'none';
                    preview.style.display = 'block';
                    document.getElementById('snap-photo-btn').style.display = 'none';
                    document.getElementById('use-photo-btn').style.display = 'inline-block';
                },
                use() {
                    const canvas = document.getElementById('camera-canvas');
                    const dataUrl = canvas.toDataURL('image/jpeg');
                    const file = this.dataURLtoFile(dataUrl, `capture_${Date.now()}.jpg`);
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    document.getElementById('sample-image').files = dataTransfer.files;
                    SampleManagerApp.UI.updateImagePreview(dataUrl);
                    SampleManagerApp.elements.cameraModal.hide(); 
                },
                close() {
                    if (SampleManagerApp.state.cameraStream) {
                        SampleManagerApp.state.cameraStream.getTracks().forEach(track => track.stop());
                        SampleManagerApp.state.cameraStream = null;
                        console.log("Camera stream stopped.");
                    }
                    this.reset();
                },
                reset() {
                    document.getElementById('camera-permission-message').style.display = 'block';
                    document.getElementById('camera-permission-message').textContent = 'Waiting for camera permission...';
                    document.getElementById('camera-stream').style.display = 'none';
                    document.getElementById('camera-snap-preview').style.display = 'none';
                    document.getElementById('snap-photo-btn').style.display = 'none';
                    document.getElementById('use-photo-btn').style.display = 'none';
                }
            },
            
            ImageConverter: {
                convertToPng(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        const image = new Image();
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        image.onload = () => {
                            canvas.width = image.width;
                            canvas.height = image.height;
                            ctx.drawImage(image, 0, 0);
                            const dataUrl = canvas.toDataURL('image/png');
                            const newFileName = file.name.replace(/\.[^/.]+$/, "") + ".png";
                            const pngFile = SampleManagerApp.UI.Camera.dataURLtoFile(dataUrl, newFileName);
                            resolve(pngFile);
                        };

                        image.onerror = (error) => {
                            reject(error);
                        };

                        reader.onload = (e) => {
                            image.src = e.target.result;
                        };

                        reader.onerror = (error) => {
                            reject(error);
                        };

                        reader.readAsDataURL(file);
                    });
                }
            }
        };

        SampleManagerApp.init();
    });
    </script>
</body>
</html>