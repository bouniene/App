<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APS Scheduler Pro | Production Planning</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            /* --- Professional Palette (App B) --- */
            --header-bg: #2b303b;
            --header-text: #ffffff;
            --body-bg: #eef1f5;
            --panel-bg: #ffffff;
            --border-color: #d1d5db;
            --grid-line: #e5e7eb;
            
            --primary: #2563eb;       /* Blue */
            --action-orange: #f97316; /* Professional Orange */
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            
            --text-main: #374151;
            --text-secondary: #6b7280;
            
            --row-height: 50px;
            --header-height: 55px;

            /* --- Functional Vars (App A Legacy) --- */
            --color-setup: #3b82f6;
            --color-late: #ef4444;
        }

        /* Dark Mode Override */
        body.dark-mode {
            --header-bg: #1f2937;
            --body-bg: #111827;
            --panel-bg: #1f2937;
            --border-color: #374151;
            --grid-line: #374151;
            --text-main: #e5e7eb;
            --text-secondary: #9ca3af;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--body-bg);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            font-size: 13px;
        }

        /* --- Layout --- */
        #app {
            display: grid;
            grid-template-rows: var(--header-height) 1fr;
            height: 100vh;
        }

        body.resizing { cursor: col-resize !important; user-select: none; }

        /* --- Header --- */
        header {
            background-color: var(--header-bg);
            color: var(--header-text);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 50;
        }

        .brand {
            display: flex; align-items: center; gap: 10px;
            font-weight: 600; font-size: 16px; min-width: 200px;
        }

        .top-toolbar {
            display: flex; align-items: center; gap: 15px; flex: 1; justify-content: flex-end;
        }

        .search-box {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            padding: 6px 12px;
            display: flex; align-items: center; gap: 8px;
            width: 300px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .search-box input {
            background: transparent; border: none; color: white; width: 100%; font-size: 13px;
        }
        .search-box input::placeholder { color: rgba(255,255,255,0.5); }

        /* Buttons */
        .btn {
            border: none; padding: 0 16px; height: 32px; border-radius: 4px;
            cursor: pointer; font-weight: 500; font-size: 12px;
            display: flex; align-items: center; gap: 6px;
            transition: all 0.2s;
        }
        .btn-orange { background-color: var(--action-orange); color: white; }
        .btn-orange:hover { background-color: #e66000; }
        
        .btn-blue { background-color: var(--primary); color: white; }
        .btn-blue:hover { filter: brightness(1.1); }

        .btn-ghost { background: transparent; color: rgba(255,255,255,0.8); border: 1px solid rgba(255,255,255,0.2); }
        .btn-ghost:hover { background: rgba(255,255,255,0.1); color: white; }
        
        .btn-ghost-dark { background: transparent; color: var(--text-main); border: 1px solid var(--border-color); }
        .btn-ghost-dark:hover { background: var(--grid-line); }

        /* --- Main Content --- */
        .main-wrapper {
            display: grid;
            grid-template-rows: 45px 1fr 220px; /* SubHeader, Gantt, BottomPanel */
            overflow: hidden;
            background: var(--panel-bg);
        }

        /* Sub Header */
        .sub-header {
            display: flex; align-items: center; gap: 20px;
            padding: 0 15px; border-bottom: 1px solid var(--border-color);
            background: var(--panel-bg); /* Match panel bg for clean look */
        }
        .view-tab {
            padding: 13px 0; border-bottom: 2px solid transparent; cursor: pointer; color: var(--text-secondary);
            font-weight: 500;
        }
        .view-tab.active { border-bottom-color: var(--action-orange); color: var(--action-orange); }

        /* --- Gantt Chart Area --- */
        .gantt-container {
            display: grid;
            grid-template-columns: 220px 1fr; /* Fixed Resource Width matches App A logic */
            overflow: hidden;
            position: relative;
            background: var(--body-bg);
        }

        /* Resource Column */
        .resource-col {
            border-right: 1px solid var(--border-color);
            background: var(--panel-bg);
            z-index: 20;
            display: flex; flex-direction: column;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            overflow-y: hidden; /* Syncs via scroll event usually, but here fixed height headers */
        }
        .res-header-cell {
            height: var(--row-height); border-bottom: 1px solid var(--border-color);
            background: #f3f4f6; color: var(--text-secondary); font-weight: 600;
            display: flex; align-items: center; padding-left: 15px; text-transform: uppercase; font-size: 11px;
        }
        /* Dark mode fix for header cell */
        body.dark-mode .res-header-cell { background: #374151; color: #e5e7eb; }

        .res-row-cell {
            height: var(--row-height); border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; padding: 0 15px; justify-content: space-between;
            font-weight: 500; color: var(--text-main);
            background: var(--panel-bg);
        }

        /* Timeline Area */
        .timeline-wrapper {
            overflow: auto;
            position: relative;
            background: var(--panel-bg);
        }

        .time-scale {
            position: sticky; top: 0; z-index: 10;
            height: var(--row-height);
            background: var(--panel-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
        }

        .time-cell {
            border-right: 1px solid var(--grid-line);
            padding: 5px 8px;
            display: flex; flex-direction: column; justify-content: center;
            font-size: 11px; color: var(--text-secondary);
            box-sizing: border-box;
            background: var(--panel-bg);
        }
        .time-cell b { color: var(--text-main); font-size: 12px; }

        /* Grid Backgrounds */
        .grid-bg {
            position: absolute; top: var(--row-height); left: 0; right: 0; bottom: 0;
            background-image: linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            z-index: 0; pointer-events: none;
        }
        .week-line {
            position: absolute; top: 0; bottom: 0; width: 2px;
            background-color: var(--success); opacity: 0.3; z-index: 2; pointer-events: none;
        }

        /* Gantt Rows */
        .gantt-row {
            height: var(--row-height);
            border-bottom: 1px solid var(--grid-line);
            position: relative;
            width: 100%;
        }
        .gantt-row.hovered { background-color: rgba(37, 99, 235, 0.05); }

        /* --- Operation Bars (Visuals from App B, Functionality from App A) --- */
        .op-bar {
            position: absolute; top: 6px; height: 38px;
            border-radius: 3px;
            font-size: 11px;
            display: flex; flex-direction: column; justify-content: center;
            padding: 0; /* Changed to 0 to handle inner layout */
            box-shadow: 0 1px 2px rgba(0,0,0,0.15);
            cursor: grab;
            color: white;
            overflow: visible; /* Important for resize handles */
            border: 1px solid rgba(0,0,0,0.1);
            z-index: 5;
            transition: box-shadow 0.2s, transform 0.1s;
        }
        .op-bar:active { cursor: grabbing; z-index: 100; }
        .op-bar:hover { z-index: 30; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .op-bar.selected { border: 2px solid white; outline: 2px solid var(--primary); z-index: 31; }
        .op-bar.late-delivery { border: 2px solid var(--danger); }

        .op-content {
            padding: 0 8px;
            width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center;
            overflow: hidden;
        }

        /* Setup Phase Visual */
        .bar-setup {
            position: absolute; left: 0; top: 0; bottom: 0;
            background-color: rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
            border-right: 1px solid rgba(255,255,255,0.3);
            background-image: linear-gradient(45deg, rgba(255,255,255,.1) 25%, transparent 25%, transparent 50%, rgba(255,255,255,.1) 50%, rgba(255,255,255,.1) 75%, transparent 75%, transparent);
            background-size: 10px 10px;
        }

        /* Resize Handles (From App A) */
        .resize-handle {
            position: absolute; top: 0; bottom: 0; width: 10px;
            cursor: ew-resize; z-index: 110;
        }
        .resize-handle.left { left: 0; }
        .resize-handle.right { right: 0; }
        .op-bar:hover .resize-handle { background: rgba(255,255,255,0.2); }

        /* Pegging Lines */
        .connector-svg {
            position: absolute; top: var(--row-height); left: 0; height: 100%; pointer-events: none; z-index: 4;
        }

        /* Now Marker */
        .now-marker {
            position: absolute; top: 0; bottom: 0; width: 2px; background: var(--danger);
            z-index: 40; pointer-events: none;
        }
        .now-tag {
            position: absolute; top: 40px; left: 2px; background: var(--danger); color: white;
            font-size: 9px; padding: 2px 4px; border-radius: 2px;
        }

        /* --- Bottom Panel --- */
        .bottom-panel {
            border-top: 1px solid var(--border-color);
            background: var(--panel-bg);
            display: flex; flex-direction: column;
            z-index: 60;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .panel-header {
            padding: 8px 15px; background: var(--body-bg); border-bottom: 1px solid var(--border-color);
            font-weight: 600; color: var(--text-main); display: flex; justify-content: space-between; align-items: center;
            height: 40px;
        }
        
        .data-grid {
            display: flex; flex-direction: column; overflow-y: auto; flex: 1;
        }
        .grid-row {
            display: grid;
            grid-template-columns: 100px 180px 120px 100px 150px 1fr;
            padding: 8px 15px; border-bottom: 1px solid var(--grid-line);
            align-items: center; font-size: 12px; cursor: grab;
            background: var(--panel-bg);
            color: var(--text-main);
        }
        .grid-row:hover { background: var(--body-bg); }
        .grid-header {
            background: var(--body-bg); color: var(--text-secondary); font-weight: 600; cursor: default;
        }
        
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 10px; background: #e5e7eb; color: #374151; }
        .tag.blue { background: #dbeafe; color: #1e40af; }
        .tag.orange { background: #ffedd5; color: #9a3412; }
        .tag.red { background: #fee2e2; color: #991b1b; }

        /* --- View Containers (Table/Kanban) --- */
        .view-wrapper { padding: 20px; overflow-y: auto; height: 100%; background: var(--body-bg); }
        
        /* Table View */
        .std-table { width: 100%; border-collapse: collapse; background: var(--panel-bg); border-radius: 6px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .std-table th { background: var(--header-bg); color: white; padding: 10px; text-align: left; font-weight: 500; cursor: pointer; }
        .std-table td { padding: 10px; border-bottom: 1px solid var(--border-color); color: var(--text-main); }
        .std-table tr:hover { background: var(--body-bg); }

        /* Kanban View */
        .kanban-board { display: flex; gap: 15px; height: 100%; overflow-x: auto; }
        .kanban-col { 
            min-width: 280px; background: var(--panel-bg); border-radius: 6px; border: 1px solid var(--border-color); 
            display: flex; flex-direction: column; max-height: 100%;
        }
        .kanban-col-header { padding: 10px; border-bottom: 1px solid var(--border-color); font-weight: bold; background: var(--body-bg); }
        .kanban-col-body { padding: 10px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .kanban-card {
            background: var(--panel-bg); border: 1px solid var(--border-color); border-left-width: 4px;
            padding: 10px; border-radius: 4px; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .kanban-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* --- Modals & Ghosts --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); z-index: 999;
            display: flex; align-items: center; justify-content: center;
        }
        .modal-card {
            background: var(--panel-bg); width: 450px; border-radius: 6px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); padding: 20px;
            color: var(--text-main); border: 1px solid var(--border-color);
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 12px; color: var(--text-secondary); }
        .form-input { 
            width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; 
            background: var(--body-bg); color: var(--text-main);
        }
        .form-input:focus { border-color: var(--primary); }

        .ghost-preview {
            position: absolute; height: 38px; border: 2px dashed var(--action-orange);
            background: rgba(249, 115, 22, 0.1); border-radius: 3px; pointer-events: none; z-index: 50;
            display: flex; align-items: center; justify-content: center; color: var(--action-orange); font-weight: bold;
            font-size: 11px;
        }
        
        .drag-tooltip {
            position: fixed; background: var(--header-bg); color: white; padding: 4px 8px; border-radius: 4px;
            font-size: 11px; pointer-events: none; z-index: 1000; transform: translate(15px, 15px);
        }
    </style>
</head>
<body :class="{'dark-mode': isDarkMode}">

<div id="app">
    <!-- Drag Tooltip (from App A logic) -->
    <div v-if="dragState.isDragging" class="drag-tooltip" :style="{top: dragState.y + 'px', left: dragState.x + 'px'}">
        {{ formatTimeTooltip(dragState.hoverTime) }}
    </div>

    <!-- Header (App B Layout) -->
    <header>
        <div class="brand">
            <i class="fa-solid fa-layer-group" style="color:var(--action-orange);"></i>
            <span>APS Scheduler Pro</span>
        </div>

        <div class="search-box">
            <i class="fa-solid fa-magnifying-glass" style="color:rgba(255,255,255,0.5);"></i>
            <input type="text" placeholder="Search orders, jobs or materials...">
        </div>

        <div class="top-toolbar">
            <button class="btn btn-ghost" @click="toggleTheme" title="Toggle Theme">
                <i class="fa-solid" :class="isDarkMode ? 'fa-sun' : 'fa-moon'"></i>
            </button>
            <button class="btn btn-ghost" @click="openResourcesModal"><i class="fa-solid fa-gear"></i> Setup</button>
            <button class="btn btn-ghost" @click="resetData"><i class="fa-solid fa-rotate-left"></i> Reset</button>
            
            <div style="width:1px; height:20px; background:rgba(255,255,255,0.2); margin:0 5px;"></div>
            
            <button class="btn btn-blue" @click="autoSchedule"><i class="fa-solid fa-wand-magic-sparkles"></i> Auto-Plan</button>
            <button class="btn btn-orange" @click="openAddOrderModal"><i class="fa-solid fa-plus"></i> New Order</button>
        </div>
    </header>

    <div class="main-wrapper">
        
        <!-- Sub Header / Tabs -->
        <div class="sub-header">
            <div class="view-tab" :class="{active: currentView==='gantt'}" @click="currentView='gantt'">
                <i class="fa-solid fa-chart-gantt"></i> Gantt Planning
            </div>
            <div class="view-tab" :class="{active: currentView==='table'}" @click="currentView='table'">
                <i class="fa-solid fa-list"></i> Order List
            </div>
            <div class="view-tab" :class="{active: currentView==='kanban'}" @click="currentView='kanban'">
                <i class="fa-solid fa-border-all"></i> Kanban Board
            </div>
            
            <div style="margin-left:auto; font-size:12px; display:flex; gap:15px; color:var(--text-secondary);">
                <span><b style="color:var(--text-main);">{{kpis.otif}}%</b> OTIF</span>
                <span><b style="color:var(--text-main);">{{kpis.utilization}}%</b> Efficiency</span>
            </div>
            
            <div style="width:1px; height:20px; background:var(--border-color); margin:0 10px;"></div>

            <!-- Zoom Control -->
            <div style="display:flex; align-items:center; gap:5px;">
                <i class="fa-solid fa-magnifying-glass-minus" style="font-size:10px; color:var(--text-secondary)"></i>
                <input type="range" v-model.number="config.pixelsPerMin" min="0.05" max="0.5" step="0.05" style="width:80px">
                <i class="fa-solid fa-magnifying-glass-plus" style="font-size:10px; color:var(--text-secondary)"></i>
            </div>
            
            <button class="btn btn-ghost-dark" @click="scrollToToday(true)">
                Today
            </button>
        </div>

        <!-- GANTT VIEW -->
        <div v-show="currentView === 'gantt'" class="gantt-container">
            
            <!-- Resource Column -->
            <div class="resource-col">
                <div class="res-header-cell">Resources</div>
                <div class="res-row-cell" v-for="res in resources" :key="res.id">
                    <div style="display:flex; flex-direction:column;">
                        <span>{{res.name}}</span>
                        <span style="font-size:10px; color:var(--text-secondary);">{{res.group}}</span>
                    </div>
                    <!-- Using App A Logic for Status Toggle -->
                    <button style="background:none; border:none; cursor:pointer;" @click="toggleResourceStatus(res)">
                         <i class="fa-solid" 
                           :class="{
                               'fa-circle-check': res.status === 'running',
                               'fa-circle-xmark': res.status === 'stopped',
                               'fa-screwdriver-wrench': res.status === 'maintenance'
                           }"
                           :style="{ color: getStatusColor(res.status) }">
                        </i>
                    </button>
                </div>
            </div>

            <!-- Timeline Area -->
            <div class="timeline-wrapper" ref="timelineScroll" @scroll="onScroll">
                
                <div class="time-scale" :style="{width: totalWidth + 'px'}">
                    <div v-for="d in config.scheduleDays" :key="d" 
                         class="time-cell" :style="{width: dayWidth + 'px'}">
                        <b>{{ getDayName(d-1) }}</b>
                        <span>{{ getDayFullDate(d-1) }}</span>
                    </div>
                </div>

                <div class="grid-bg" :style="{width: totalWidth + 'px', backgroundSize: hourWidth + 'px 100%'}"></div>
                
                <!-- Saturday Lines (App A Logic) -->
                <div class="week-line" v-for="(wPos, idx) in weekLines" :key="'wk-'+idx" :style="{left: wPos + 'px'}"></div>

                <div class="now-marker" :style="{left: nowMarkerPos + 'px'}">
                    <div class="now-tag">NOW</div>
                </div>

                <svg class="connector-svg" :style="{width: totalWidth + 'px'}">
                    <path v-for="line in peggingLines" :d="line.path" 
                          style="fill:none; stroke:var(--action-orange); stroke-width:2; stroke-dasharray:5,5; opacity:0.6;"></path>
                </svg>

                <!-- Gantt Rows -->
                <div v-for="res in resources" :key="res.id" 
                     class="gantt-row"
                     :class="{'hovered': dragState.hoverResId === res.id}"
                     :style="{width: totalWidth + 'px'}"
                     @dragover.prevent="onDragOver($event, res.id)"
                     @dragleave="onDragLeave"
                     @drop="onDrop($event, res.id)">
                     
                     <div v-for="op in getOpsForResource(res.id)" :key="op.id"
                          class="op-bar"
                          draggable="true"
                          :class="{'selected': selectedOpId === op.id, 'late-delivery': isLate(op)}"
                          :style="getBarStyle(op)"
                          @dragstart="startDrag($event, op)"
                          @click.stop="selectOp(op)"
                          @dblclick.stop="openEditOpModal(op)">
                          
                          <!-- Resize Handles (From App A) -->
                          <div class="resize-handle left" @mousedown.stop="startResize($event, op, 'left')"></div>
                          <div class="resize-handle right" @mousedown.stop="startResize($event, op, 'right')"></div>

                          <!-- Setup Visual -->
                          <div class="bar-setup" v-if="op.setupDuration > 0" :style="{width: (op.setupDuration * config.pixelsPerMin) + 'px'}">
                               <i class="fa-solid fa-cogs" style="font-size:0.8em; opacity:0.7"></i>
                          </div>

                          <!-- Content -->
                          <div class="op-content" :style="{marginLeft: (op.setupDuration * config.pixelsPerMin) + 'px', backgroundColor: op.color}">
                              <div style="font-weight:bold; display:flex; justify-content:space-between; width:100%;">
                                  <span>{{op.orderId}}</span>
                              </div>
                              <div style="opacity:0.9; white-space:nowrap; overflow:hidden;">{{op.product}} ({{op.qty}})</div>
                          </div>
                     </div>
                </div>

                <!-- Ghost Preview -->
                <div v-if="dragState.isDragging && dragState.hoverResId" 
                     class="ghost-preview"
                     :style="{
                         left: (dragState.ghostStartTime * config.pixelsPerMin) + 'px', 
                         width: ((dragState.ghostDuration) * config.pixelsPerMin) + 'px',
                         top: getGhostTop() + 'px'
                     }">
                     {{ formatTimeTooltip(dragState.ghostStartTime) }}
                </div>

            </div>
        </div>

        <!-- TABLE VIEW -->
        <div v-if="currentView === 'table'" class="view-wrapper">
            <table class="std-table">
                <thead>
                    <tr>
                        <th @click="sort('orderId')">Order ID <i class="fa-solid fa-sort"></i></th>
                        <th @click="sort('product')">Product</th>
                        <th @click="sort('status')">Status</th>
                        <th @click="sort('resourceId')">Machine</th>
                        <th @click="sort('qty')">Qty</th>
                        <th @click="sort('dueDate')">Due Date</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="op in sortedOps" :key="op.id">
                        <td><strong>{{ op.orderId }}</strong></td>
                        <td>{{ op.product }} <span style="font-size:0.8em; opacity:0.7">({{op.color}})</span></td>
                        <td><span class="tag" :class="op.status === 'scheduled' ? 'blue' : 'orange'">{{ op.status }}</span></td>
                        <td>{{ getResourceName(op.resourceId) }}</td>
                        <td>{{ op.qty }}</td>
                        <td>{{ formatAlgerianDateTime(op.dueDate) }}</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- KANBAN VIEW -->
        <div v-if="currentView === 'kanban'" class="view-wrapper">
             <div class="kanban-board">
                 <div class="kanban-col" v-for="res in resources" :key="res.id">
                     <div class="kanban-col-header">{{ res.name }} <span style="font-weight:normal; opacity:0.6">({{ getOpsForResource(res.id).length }})</span></div>
                     <div class="kanban-col-body">
                         <div v-for="op in getSortedOpsForResource(res.id)" :key="op.id" 
                              class="kanban-card" 
                              :style="{borderLeftColor: op.color}"
                              @dblclick="openEditOpModal(op)">
                              <div style="font-weight:bold; display:flex; justify-content:space-between;">
                                  {{ op.orderId }}
                              </div>
                              <div style="color:var(--text-secondary); font-size:11px;">{{ op.product }}</div>
                              <div style="margin-top:5px; font-size:10px;">{{ formatTimeTooltip(op.startTime) }}</div>
                         </div>
                     </div>
                 </div>
             </div>
        </div>

        <!-- BOTTOM PANEL (Unscheduled) -->
        <div class="bottom-panel" v-if="currentView === 'gantt'">
            <div class="panel-header">
                <span><i class="fa-solid fa-layer-group"></i> Production Queue / Unscheduled Orders</span>
                <span class="tag orange">{{ unscheduledOps.length }} Pending</span>
            </div>
            
            <div class="data-grid">
                <div class="grid-row grid-header">
                    <div>Order ID</div>
                    <div>Product</div>
                    <div>Due Date</div>
                    <div>Qty (kg)</div>
                    <div>Required</div>
                    <div>Notes</div>
                </div>
                
                <div class="grid-row" v-for="op in unscheduledOps" :key="op.id"
                     draggable="true"
                     @dragstart="startDrag($event, op)"
                     @dblclick="openEditOpModal(op)">
                     
                    <div style="font-weight:bold; color:var(--primary);">{{op.orderId}}</div>
                    <div>{{op.product}} <span class="tag" style="background:none; border:1px solid #ccc">{{op.color}}</span></div>
                    <div :style="{color: isLateUnscheduled(op) ? 'var(--danger)' : 'inherit'}">
                        {{ formatAlgerianDateTime(op.dueDate) }}
                    </div>
                    <div>{{op.qty}}</div>
                    <div><span class="tag blue">{{op.requiredGroup}}</span></div>
                    <div style="color:var(--text-secondary); font-style:italic;">
                        {{ op.notes || 'Drag to schedule...' }}
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- MODALS (Styled like App B) -->
    
    <!-- Add Order Modal -->
    <div class="modal-overlay" v-if="modals.addOrder" @click.self="modals.addOrder=false">
        <div class="modal-card">
            <h3 style="margin-top:0; border-bottom:1px solid var(--border-color); padding-bottom:10px;">Create New Order</h3>
            <div class="form-group">
                <label>Order ID</label>
                <input v-model="newOrder.id" class="form-input">
            </div>
            <div class="form-group">
                <label>Product</label>
                <input v-model="newOrder.product" class="form-input">
            </div>
            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1">
                    <label>Color</label>
                    <select v-model="newOrder.color" class="form-input">
                         <option value="Black">Black</option>
                         <option value="White">White</option>
                         <option value="Red">Red</option>
                         <option value="Blue">Blue</option>
                         <option value="#eab308">Yellow</option>
                         <option value="#a855f7">Purple</option>
                    </select>
                </div>
                <div class="form-group" style="flex:1">
                    <label>Qty (kg)</label>
                    <input type="number" v-model="newOrder.qty" class="form-input">
                </div>
            </div>
            
            <div class="form-group">
                <label>Run Duration (Result: {{ calculatedNewDuration }} mins)</label>
                <div style="display:flex; gap:10px;">
                    <input type="number" v-model.number="modalState.customDurationVal" class="form-input">
                    <select v-model="modalState.customDurationUnit" class="form-input" style="width:100px;">
                        <option value="minutes">Mins</option>
                        <option value="hours">Hrs</option>
                        <option value="days">Days</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Due Hours</label>
                <input type="number" v-model="newOrder.dueHours" class="form-input">
            </div>

            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px; border-top:1px solid var(--border-color); padding-top:15px;">
                <button class="btn btn-ghost-dark" @click="modals.addOrder=false">Cancel</button>
                <button class="btn btn-orange" @click="saveNewOrder">Create Order</button>
            </div>
        </div>
    </div>

    <!-- Edit Job Modal -->
    <div class="modal-overlay" v-if="modals.editOp && selectedOp" @click.self="modals.editOp=false">
        <div class="modal-card">
            <h3 style="margin-top:0; border-bottom:1px solid var(--border-color); padding-bottom:10px;">
                Edit Job: {{ selectedOp.orderId }}
            </h3>
            
            <div class="form-group">
                <label>Product</label>
                <input v-model="selectedOp.product" class="form-input">
            </div>
            
            <div class="form-group">
                 <label>Run Duration (Update: {{ calculatedEditDuration }} mins)</label>
                 <div style="display:flex; gap:10px;">
                    <input type="number" v-model.number="modalState.editDurationVal" class="form-input">
                    <select v-model="modalState.editDurationUnit" class="form-input" style="width:100px;">
                        <option value="minutes">Mins</option>
                        <option value="hours">Hrs</option>
                        <option value="days">Days</option>
                    </select>
                 </div>
            </div>
            
            <div style="display:flex; justify-content:space-between; margin-top:20px; border-top:1px solid var(--border-color); padding-top:15px;">
                <button class="btn btn-ghost" style="color:var(--danger); border-color:var(--danger)" @click="deleteOp">Delete</button>
                
                <div style="display:flex; gap:10px;">
                    <button v-if="selectedOp.status === 'scheduled'" class="btn btn-ghost-dark" @click="unscheduleOp">Unschedule</button>
                    <button class="btn btn-blue" @click="saveEditOp">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Resources Modal -->
    <div class="modal-overlay" v-if="modals.resources" @click.self="modals.resources=false">
        <div class="modal-card">
             <h3>Manage Resources</h3>
             <div style="max-height:200px; overflow-y:auto; margin-bottom:15px;">
                <div v-for="(res, idx) in resources" :key="res.id" style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid var(--border-color);">
                    <span><b>{{res.name}}</b> ({{res.group}})</span>
                    <button class="btn btn-ghost" style="color:var(--danger); padding:0 5px;" @click="removeResource(idx)"><i class="fa-solid fa-trash"></i></button>
                </div>
             </div>
             <div style="display:flex; gap:5px;">
                 <input v-model="newRes.name" class="form-input" placeholder="Name">
                 <select v-model="newRes.group" class="form-input">
                     <option value="Extrusion">Extrusion</option>
                     <option value="Assembly">Assembly</option>
                 </select>
                 <button class="btn btn-success" style="background:var(--success); color:white" @click="addResource">Add</button>
             </div>
        </div>
    </div>

</div>

<script>
    const { createApp, reactive, computed, ref, onMounted, watch, nextTick } = Vue;

    createApp({
        setup() {
            // --- CONFIGURATION ---
            const config = reactive({
                pixelsPerMin: 0.15, 
                scheduleDays: 40 // Initial buffer
            });
            
            const ROW_HEIGHT = 50;
            const isDarkMode = ref(false);
            const baseDate = ref(new Date()); 
            const timelineScroll = ref(null);
            const nowMarkerPos = ref(0);

            // Watcher for Body Class
            watch(isDarkMode, (newVal) => {
                if(newVal) document.body.classList.add('dark-mode');
                else document.body.classList.remove('dark-mode');
            }, { immediate: true });

            // --- VIEW STATE ---
            const currentView = ref('gantt'); 
            const sortKey = ref('orderId');
            const sortAsc = ref(true);
            const selectedOpId = ref(null);
            
            // --- DATA STATE ---
            const resources = reactive([
                { id: 'm1', name: 'EXT-100', group: 'Extrusion', status: 'running' },
                { id: 'm2', name: 'EXT-075', group: 'Extrusion', status: 'running' },
                { id: 'm3', name: 'EXT-050', group: 'Extrusion', status: 'maintenance' },
            ]);

            const scheduledOps = reactive([]);
            const unscheduledOps = reactive([]);

            // Modals State
            const modals = reactive({ resources: false, addOrder: false, editOp: false });
            const newRes = reactive({ name: '', group: 'Extrusion' });
            
            const modalState = reactive({
                customDurationVal: 8,
                customDurationUnit: 'hours',
                editDurationVal: 0,
                editDurationUnit: 'minutes'
            });

            const newOrder = reactive({ 
                id: 'WO-2024-X', 
                product: 'Pipe-110', 
                color: 'Black', 
                qty: 500, 
                dueHours: 48, 
                ops: ['Extrusion'], 
                notes: '', 
                batchGroup: ''
            });
            
            const selectedOp = ref(null);

            // --- DRAG & DROP STATE ---
            const dragState = reactive({
                isDragging: false,
                op: null,
                x: 0,
                y: 0,
                hoverTime: 0,
                hoverResId: null,
                ghostStartTime: 0,
                ghostDuration: 0,
                dragOffset: 0
            });

            // --- RESIZE STATE ---
            const resizeState = reactive({
                isResizing: false,
                op: null,
                side: null, // 'left' or 'right'
                startX: 0,
                initialStart: 0,
                initialDur: 0
            });

            // Matrix Setup
            const setupMatrix = {
                'Black': { 'Black': 0, 'White': 120, 'Red': 60, 'Blue': 60 },
                'White': { 'Black': 60, 'White': 0, 'Red': 60, 'Blue': 60 },
                'Red':   { 'Black': 60, 'White': 60, 'Red': 0, 'Blue': 60 },
                'Blue':  { 'Black': 60, 'White': 60, 'Red': 60, 'Blue': 0 }
            };

            // --- INITIALIZATION ---
            const initData = () => {
                scheduledOps.length = 0;
                unscheduledOps.length = 0;
                
                // IMPORTANT: Start baseDate 15 days in the PAST so "Today" is in the middle
                const today = new Date();
                baseDate.value = new Date(today.getTime() - (15 * 24 * 60 * 60000));

                createOrder('WO-101', 'HDPE Pipe 50mm', 'Black', 1000, 48, ['Extrusion'], 1440); // 1 Day
                createOrder('WO-102', 'PVC Tube', 'White', 500, 24, ['Extrusion'], 480); // 8 Hours
                createOrder('WO-103', 'Profile A', 'Red', 800, 72, ['Extrusion'], 2880); // 2 Days
                
                // Start Timer for Red Line
                setInterval(updateNowMarker, 60000); // Update every minute
                updateNowMarker();
            };

            const createOrder = (id, prod, color, qty, dueHours, route, durationMins = null, notes = '', batchGroup = '') => {
                const today = new Date(); // Due date relative to now
                const dueMinutesFromBase = ((today.getTime() + (dueHours*60*60000)) - baseDate.value.getTime()) / 60000;
                
                const calcDuration = durationMins || Math.ceil(qty * 0.5); 

                route.forEach((stage, idx) => {
                    unscheduledOps.push({
                        id: `${id}-${idx}-${Date.now()}-${Math.random()}`,
                        orderId: id,
                        product: prod,
                        color: color,
                        qty: qty,
                        stageIndex: idx,
                        requiredGroup: stage,
                        runDuration: calcDuration,
                        setupDuration: 0,
                        dueDate: dueMinutesFromBase, 
                        startTime: 0,
                        resourceId: null,
                        status: 'unscheduled',
                        notes: notes,
                        batchGroup: batchGroup
                    });
                });
            };

            onMounted(async () => {
                initData();
                await nextTick();
                // ATTEMPT 1: Immediate Jump
                scrollToToday(false);
                // ATTEMPT 2: Delayed Correction
                setTimeout(() => { scrollToToday(true); }, 500);
            });

            // --- RED LINE MARKER LOGIC ---
            const updateNowMarker = () => {
                const now = new Date();
                const diffMins = (now.getTime() - baseDate.value.getTime()) / 60000;
                nowMarkerPos.value = diffMins * config.pixelsPerMin;
            };
            
            // Re-calculate when zoom changes
            watch(() => config.pixelsPerMin, updateNowMarker);

            const scrollToToday = (smooth = true) => {
                updateNowMarker(); // Ensure pos is fresh
                if(timelineScroll.value) {
                    const screenCenter = timelineScroll.value.clientWidth / 2;
                    const scrollTarget = nowMarkerPos.value - screenCenter;
                    timelineScroll.value.scrollTo({
                        left: scrollTarget > 0 ? scrollTarget : 0,
                        behavior: smooth ? 'smooth' : 'auto'
                    });
                }
            };

            // --- MACHINE STATUS LOGIC ---
            const toggleResourceStatus = (res) => {
                const states = ['running', 'stopped', 'maintenance'];
                const currentIndex = states.indexOf(res.status);
                const nextIndex = (currentIndex + 1) % states.length;
                res.status = states[nextIndex];
            };

            const getStatusColor = (status) => {
                switch(status) {
                    case 'running': return 'var(--success)';
                    case 'stopped': return 'var(--danger)';
                    case 'maintenance': return 'var(--warning)';
                    default: return 'gray';
                }
            };

            // --- INFINITE SCROLL LOGIC ---
            const onScroll = (e) => {
                const el = e.target;
                const scrollRight = el.scrollLeft + el.clientWidth;
                
                // Forward (Right)
                if (scrollRight >= el.scrollWidth - 100) {
                    config.scheduleDays += 7;
                }

                // Backward (Left) - Infinite Past
                if (el.scrollLeft < 100) {
                    loadPreviousWeek();
                }
            };

            const loadPreviousWeek = () => {
                const minsInWeek = 7 * 24 * 60;
                baseDate.value = new Date(baseDate.value.getTime() - (minsInWeek * 60000));
                config.scheduleDays += 7;

                // Shift ops forward
                scheduledOps.forEach(op => {
                    op.startTime += minsInWeek;
                    if(op.dueDate) op.dueDate += minsInWeek;
                });
                unscheduledOps.forEach(op => {
                      if(op.dueDate) op.dueDate += minsInWeek;
                });

                if(timelineScroll.value) {
                    const pixelShift = minsInWeek * config.pixelsPerMin;
                    timelineScroll.value.scrollLeft += pixelShift;
                }
                updateNowMarker();
            };

            // --- HELPER: CORRECT X POSITION ---
            const getXInTimeline = (clientX) => {
                if (!timelineScroll.value) return 0;
                const container = timelineScroll.value;
                const rect = container.getBoundingClientRect();
                const scrollLeft = container.scrollLeft;
                return (clientX - rect.left) + scrollLeft; 
            };

            // --- GENERAL HELPERS ---
            const getAlgerianDateObj = (minutesToAdd) => {
                const d = new Date(baseDate.value.getTime() + minutesToAdd * 60000);
                return d;
            };

            const formatAlgerianDateTime = (minutesToAdd) => {
                const date = getAlgerianDateObj(minutesToAdd);
                return new Intl.DateTimeFormat('fr-DZ', {
                    timeZone: 'Africa/Algiers',
                    month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                }).format(date);
            };

            const getDayName = (dayIndex) => {
                const date = getAlgerianDateObj(dayIndex * 24 * 60);
                return new Intl.DateTimeFormat('en-US', {
                    weekday: 'short'
                }).format(date);
            };
            
            const isSaturday = (dayIndex) => {
                const date = getAlgerianDateObj(dayIndex * 24 * 60);
                return date.getDay() === 6; 
            };

            const getDayFullDate = (dayIndex) => {
                const date = getAlgerianDateObj(dayIndex * 24 * 60);
                return new Intl.DateTimeFormat('en-US', {
                    day: 'numeric', month: 'numeric'
                }).format(date);
            };

            const formatTimeTooltip = (minutes) => formatAlgerianDateTime(minutes);

            const totalWidth = computed(() => config.scheduleDays * 24 * 60 * config.pixelsPerMin);
            const dayWidth = computed(() => 24 * 60 * config.pixelsPerMin);
            const hourWidth = computed(() => 60 * config.pixelsPerMin);
            
            const weekLines = computed(() => {
                const lines = [];
                for(let i=0; i<config.scheduleDays; i++) {
                    if(isSaturday(i)) {
                        lines.push(i * 24 * 60 * config.pixelsPerMin);
                    }
                }
                return lines;
            });

            // --- DURATION CALCS ---
            const convertToMins = (val, unit) => {
                if(unit === 'days') return val * 1440;
                if(unit === 'hours') return val * 60;
                return val;
            };

            const calculatedNewDuration = computed(() => convertToMins(modalState.customDurationVal, modalState.customDurationUnit));
            const calculatedEditDuration = computed(() => convertToMins(modalState.editDurationVal, modalState.editDurationUnit));

            const calculateSetup = (op, resId, startTime) => {
                const sorted = scheduledOps
                    .filter(o => o.resourceId === resId && o.id !== op.id)
                    .sort((a,b) => a.startTime - b.startTime);
                
                let prev = null;
                for(let s of sorted) {
                    if (s.startTime + s.setupDuration + s.runDuration <= startTime) prev = s;
                    else break;
                }

                if(!prev) return 30;
                const map = setupMatrix[prev.color];
                return (map && map[op.color] !== undefined) ? map[op.color] : 30;
            };

            const hasCollision = (op, start, resId) => {
                const end = start + op.setupDuration + op.runDuration;
                return scheduledOps.some(o => {
                    if(o.id === op.id || o.resourceId !== resId) return false;
                    const oStart = o.startTime;
                    const oEnd = o.startTime + o.setupDuration + o.runDuration;
                    return (start < oEnd && end > oStart);
                });
            };

            // --- CLICK / SELECT LOGIC ---
            const selectOp = (op) => {
                selectedOpId.value = op.id;
            };

            // --- RESIZE LOGIC ---
            const startResize = (e, op, side) => {
                resizeState.isResizing = true;
                resizeState.op = op;
                resizeState.side = side;
                resizeState.startX = e.clientX;
                resizeState.initialStart = op.startTime;
                resizeState.initialDur = op.runDuration;
                
                document.body.classList.add('resizing');
                window.addEventListener('mousemove', handleResize);
                window.addEventListener('mouseup', stopResize);
            };

            const handleResize = (e) => {
                if (!resizeState.isResizing) return;
                
                const dx = e.clientX - resizeState.startX;
                const dt = dx / config.pixelsPerMin; 
                const SNAP_THRESHOLD_MINS = 60; 
                const DAY_MINS = 1440;

                if (resizeState.side === 'right') {
                    let newDur = resizeState.initialDur + dt;
                    if (newDur < 15) newDur = 15; 
                    resizeState.op.runDuration = Math.round(newDur);
                } else {
                    let newStart = resizeState.initialStart + dt;
                    let newDur = resizeState.initialDur - dt;
                    if (newDur >= 15 && newStart >= 0) {
                        resizeState.op.startTime = Math.round(newStart);
                        resizeState.op.runDuration = Math.round(newDur);
                    }
                }
            };

            const stopResize = () => {
                resizeState.isResizing = false;
                resizeState.op = null;
                document.body.classList.remove('resizing');
                window.removeEventListener('mousemove', handleResize);
                window.removeEventListener('mouseup', stopResize);
            };

            // --- DRAG & DROP ENGINE ---
            const startDrag = (e, op) => {
                if (resizeState.isResizing) {
                    e.preventDefault();
                    return;
                }
                selectOp(op); 

                // Offset Calculation
                // In App B structure, we need to be careful with offset since bars are inside rows
                // Simple assumption: center drag if offset calculation is tricky
                dragState.dragOffset = 0; 

                dragState.isDragging = true;
                dragState.op = op;
                dragState.ghostDuration = op.runDuration + (op.setupDuration || 30);
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.dropEffect = 'move';
                // Dummy data
                e.dataTransfer.setData('text/plain', op.id);
            };

            const onDragOver = (e, resId) => {
                const xPos = getXInTimeline(e.clientX);
                
                dragState.x = e.clientX;
                dragState.y = e.clientY;
                dragState.hoverResId = resId;
                
                let rawMins = xPos / config.pixelsPerMin;
                let startMins = rawMins;
                
                let snappedMins = Math.round(startMins / 15) * 15;
                if(snappedMins < 0) snappedMins = 0;

                dragState.hoverTime = snappedMins;
                dragState.ghostStartTime = snappedMins;

                if(dragState.op) {
                      const estimatedSetup = calculateSetup(dragState.op, resId, snappedMins);
                      dragState.ghostDuration = dragState.op.runDuration + estimatedSetup;
                }
            };

            const onDragLeave = () => {};

            const onDrop = (e, resId) => {
                const op = dragState.op;
                dragState.isDragging = false;
                dragState.op = null;
                dragState.hoverResId = null;

                if(!op) return;

                const res = resources.find(r => r.id === resId);
                if(res.group !== op.requiredGroup) {
                    alert(`Machine group mismatch. Job needs ${op.requiredGroup}`);
                    return;
                }

                let time = dragState.hoverTime; 

                if(op.stageIndex > 0) {
                    let prev = scheduledOps.find(o => o.orderId === op.orderId && o.stageIndex === op.stageIndex - 1);
                    if (!prev && unscheduledOps.find(o => o.orderId === op.orderId && o.stageIndex === op.stageIndex - 1)) {
                        alert("Please schedule the previous operation first.");
                        return;
                    }
                    if(prev && time < (prev.startTime + prev.setupDuration + prev.runDuration)) {
                        time = prev.startTime + prev.setupDuration + prev.runDuration;
                    }
                }

                const oldRes = op.resourceId;
                const oldTime = op.startTime;
                
                op.setupDuration = calculateSetup(op, resId, time);
                
                if(hasCollision(op, time, resId)) {
                    alert("Collision detected. Please drop in an empty space.");
                    if(op.status === 'scheduled') {
                           op.setupDuration = calculateSetup(op, oldRes, oldTime);
                    }
                    return;
                }

                op.resourceId = resId;
                op.startTime = time;
                op.status = 'scheduled';

                const uIdx = unscheduledOps.findIndex(o => o.id === op.id);
                if(uIdx > -1) {
                    unscheduledOps.splice(uIdx, 1);
                    scheduledOps.push(op);
                }
            };
            
            // --- GHOST TOP CALC ---
            const getGhostTop = () => {
                // Since ghost is inside timeline-wrapper (relative), we need Y relative to that
                // Simplified: use a fixed top or 0, CSS handles standard position, 
                // but if we want it to float over the specific row, we need row index
                const idx = resources.findIndex(r => r.id === dragState.hoverResId);
                if(idx > -1) {
                    // Header height (0 inside timeline-wrapper because header is separate div? No, time-scale is inside)
                    // time-scale height is 50px
                    return 50 + (idx * ROW_HEIGHT) + 7; // 7 is top padding of bar
                }
                return 0;
            }

            // --- ACTIONS ---
            const toggleTheme = () => isDarkMode.value = !isDarkMode.value;
            
            const openResourcesModal = () => modals.resources = true;
            const addResource = () => {
                if(!newRes.name) return;
                resources.push({ id: `r-${Date.now()}`, name: newRes.name, group: newRes.group, status: 'running' });
                newRes.name = '';
            };
            const removeResource = (idx) => {
                const res = resources[idx];
                const toRemove = scheduledOps.filter(o => o.resourceId === res.id);
                toRemove.forEach(o => {
                    o.resourceId = null; o.startTime = 0; o.setupDuration = 0; o.status = 'unscheduled';
                    unscheduledOps.push(o);
                });
                for (let i = scheduledOps.length - 1; i >= 0; i--) {
                    if (scheduledOps[i].resourceId === res.id) scheduledOps.splice(i, 1);
                }
                resources.splice(idx, 1);
            };

            const openAddOrderModal = () => {
                modalState.customDurationVal = 8;
                modalState.customDurationUnit = 'hours';
                modals.addOrder = true;
            };

            const saveNewOrder = () => {
                createOrder(
                    newOrder.id, 
                    newOrder.product, 
                    newOrder.color, 
                    newOrder.qty, 
                    newOrder.dueHours, 
                    newOrder.ops,
                    calculatedNewDuration.value,
                    newOrder.notes
                );
                modals.addOrder = false;
            };

            const openEditOpModal = (op) => { 
                selectedOpId.value = op.id; 
                selectedOp.value = op; 
                modalState.editDurationVal = op.runDuration;
                modalState.editDurationUnit = 'minutes'; 
                modals.editOp = true; 
            };

            const saveEditOp = () => {
                if(selectedOp.value) {
                    selectedOp.value.runDuration = calculatedEditDuration.value;
                }
                modals.editOp = false;
            };
            
            const unscheduleOp = () => {
                const idx = scheduledOps.indexOf(selectedOp.value);
                if(idx > -1) {
                    const op = scheduledOps.splice(idx, 1)[0];
                    op.status = 'unscheduled'; op.startTime = 0; op.resourceId = null; op.setupDuration = 0;
                    unscheduledOps.push(op);
                    modals.editOp = false;
                }
            };
            const deleteOp = () => {
                let idx = scheduledOps.indexOf(selectedOp.value);
                if(idx > -1) scheduledOps.splice(idx, 1);
                idx = unscheduledOps.indexOf(selectedOp.value);
                if(idx > -1) unscheduledOps.splice(idx, 1);
                modals.editOp = false;
            };

            const autoSchedule = () => {
                unscheduledOps.sort((a,b) => a.dueDate - b.dueDate);
                const list = [...unscheduledOps];
                list.forEach(op => {
                    const cands = resources.filter(r => r.group === op.requiredGroup);
                    let bestT = Infinity, bestR = null;

                    cands.forEach(r => {
                        let t = 0;
                        if(op.stageIndex > 0) {
                             const prev = scheduledOps.find(o => o.orderId === op.orderId && o.stageIndex === op.stageIndex - 1);
                             if(prev) t = prev.startTime + prev.setupDuration + prev.runDuration;
                             else return; 
                        }
                        
                        let safe = false;
                        const maxTime = config.scheduleDays * 24 * 60;
                        while(!safe && t < maxTime) {
                             op.setupDuration = calculateSetup(op, r.id, t);
                             if(!hasCollision(op, t, r.id)) safe = true;
                             else t += 15;
                        }
                        if(safe && t < bestT) { bestT = t; bestR = r.id; }
                    });

                    if(bestR) {
                        op.resourceId = bestR; op.startTime = bestT;
                        op.setupDuration = calculateSetup(op, bestR, bestT);
                        op.status = 'scheduled';
                        scheduledOps.push(op);
                        unscheduledOps.splice(unscheduledOps.indexOf(op), 1);
                    }
                });
            };

            // --- COMPUTED ---
            const sort = (key) => {
                if (sortKey.value === key) sortAsc.value = !sortAsc.value;
                else { sortKey.value = key; sortAsc.value = true; }
            };

            const sortedOps = computed(() => {
                const all = [...scheduledOps, ...unscheduledOps];
                return all.sort((a, b) => {
                    let valA = a[sortKey.value], valB = b[sortKey.value];
                    if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); }
                    if (valA < valB) return sortAsc.value ? -1 : 1;
                    if (valA > valB) return sortAsc.value ? 1 : -1;
                    return 0;
                });
            });

            const getOpsForResource = (rid) => scheduledOps.filter(o => o.resourceId === rid);
            const getSortedOpsForResource = (rid) => scheduledOps.filter(o => o.resourceId === rid).sort((a,b) => a.startTime - b.startTime);
            const getResourceName = (rid) => { const r = resources.find(x => x.id === rid); return r ? r.name : 'Unassigned'; };
            const getBarStyle = (op) => ({ 
                left: (op.startTime * config.pixelsPerMin) + 'px', 
                width: ((op.setupDuration + op.runDuration) * config.pixelsPerMin) + 'px',
                // Using a darker tone for the border if desired, but we handle color in inner content
            });
            
            const isLate = (op) => (op.startTime + op.setupDuration + op.runDuration) > op.dueDate;
            const isLateUnscheduled = (op) => op.dueDate < 0; 

            const kpis = computed(() => {
                if(!scheduledOps.length) return { otif: 100, utilization: 0 };
                const late = scheduledOps.filter(isLate).length;
                const otif = Math.round(((scheduledOps.length - late)/scheduledOps.length)*100);
                const totalRun = scheduledOps.reduce((a,c) => a+c.runDuration, 0);
                const capacity = resources.length * config.scheduleDays * 24 * 60; 
                return { otif, utilization: Math.round((totalRun/capacity)*100) };
            });

            const peggingLines = computed(() => {
                const lines = [];
                const orders = [...new Set(scheduledOps.map(o => o.orderId))];
                orders.forEach(oid => {
                      const ops = scheduledOps.filter(o => o.orderId === oid).sort((a,b) => a.stageIndex - b.stageIndex);
                      for(let i=0; i<ops.length-1; i++) {
                          const curr = ops[i]; const next = ops[i+1];
                          const r1 = resources.findIndex(r => r.id === curr.resourceId);
                          const r2 = resources.findIndex(r => r.id === next.resourceId);
                          if(r1<0 || r2<0) continue;
                          const x1 = (curr.startTime + curr.setupDuration + curr.runDuration) * config.pixelsPerMin;
                          const y1 = 50 + (r1 * ROW_HEIGHT) + (ROW_HEIGHT/2); // 50 is header height
                          const x2 = next.startTime * config.pixelsPerMin;
                          const y2 = 50 + (r2 * ROW_HEIGHT) + (ROW_HEIGHT/2);
                          lines.push({ path: `M ${x1} ${y1} C ${x1+50} ${y1}, ${x2-50} ${y2}, ${x2} ${y2}` });
                      }
                });
                return lines;
            });

            return {
                config, resources, scheduledOps, unscheduledOps, modals, newRes, newOrder, selectedOp,
                kpis, peggingLines, currentView, sortKey, sortedOps, modalState,
                isDarkMode, toggleTheme, dragState, resizeState, timelineScroll, nowMarkerPos, weekLines,
                initData, resetData: initData,
                openResourcesModal, addResource, removeResource,
                openAddOrderModal, saveNewOrder,
                openEditOpModal, saveEditOp, unscheduleOp, deleteOp,
                startDrag, onDrop, onDragOver, onDragLeave, autoSchedule,
                startResize, selectOp, selectedOpId,
                getOpsForResource, getBarStyle, formatAlgerianDateTime, getDayName, getDayFullDate, isLate, isLateUnscheduled,
                getSortedOpsForResource, sort, getResourceName, formatTimeTooltip,
                totalWidth, dayWidth, hourWidth,
                calculatedNewDuration, calculatedEditDuration, onScroll, loadPreviousWeek, getXInTimeline, scrollToToday,
                toggleResourceStatus, getStatusColor, getGhostTop
            };
        }
    }).mount('#app');
</script>

</body>
</html>